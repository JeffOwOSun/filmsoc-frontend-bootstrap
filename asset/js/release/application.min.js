/**
 * Script File of Film Society, HKUSTSU
 * Author: John Tan <johnmave126@gmail.com>
 * All Rights Reserved
 */

var tz_info="+08:00";function assert(condition,opt_message){if(!condition){var msg="Assertion failed";if(opt_message){msg=msg+": "+opt_message}throw new Error(msg)}}var global=this;function $(id){return document.getElementById(id)}function pad(n,width,z){z=z||"0";n=n+"";return n.length>=width?n:new Array(width-n.length+1).join(z)+n}function cssurl(s){var s2=s.replace(/(\(|\)|\,|\s|\'|\"|\\)/g,"\\$1");if(/\\\\$/.test(s2)){s2+=" "}return'url("'+s2+'")'}function parseLocationParams(location){var params={};var query=unescape(location.search.substring(1));var vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");params[pair[0]]=pair[1]}return params}function findAncestorByClass(el,className){return findAncestor(el,function(el){if(el.classList){return el.classList.contains(className)}return null})}function findAncestor(node,predicate){var last=false;while(node!=null&&!(last=predicate(node))){node=node.parentNode}return last?node:null}function swapDomNodes(a,b){var afterA=a.nextSibling;if(afterA==b){swapDomNodes(b,a);return}var aParent=a.parentNode;b.parentNode.replaceChild(a,b);aParent.insertBefore(b,afterA)}function disableTextSelectAndDrag(opt_allowSelectStart,opt_allowDragStart){document.onselectstart=function(e){if(!(opt_allowSelectStart&&opt_allowSelectStart.call(this,e))){e.preventDefault()}};document.ondragstart=function(e){if(!(opt_allowDragStart&&opt_allowDragStart.call(this,e))){e.preventDefault()}}}function preventDefaultOnPoundLinkClicks(){document.addEventListener("click",function(e){var anchor=findAncestor(e.target,function(el){return el.tagName=="A"});if(anchor&&anchor.getAttribute("href")=="#"){e.preventDefault()}})}function getRequiredElement(id){var element=$(id);assert(element,"Missing required element: "+id);return element}(function(){if(!Element.prototype.matches){if(Element.prototype.webkitMatchesSelector){Element.prototype.matches=Element.prototype.webkitMatchesSelector}else{if(Element.prototype.mozMatchesSelector){Element.prototype.matches=Element.prototype.mozMatchesSelector}else{if(Element.prototype.oMatchesSelector){Element.prototype.matches=Element.prototype.oMatchesSelector}else{if(Element.prototype.msMatchesSelector){Element.prototype.matches=Element.prototype.msMatchesSelector}}}}}assert(Element.prototype.matches,"Unsupported Browser")})();function createElementWithClassName(type,className){var elm=document.createElement(type);elm.className=className;return elm}function extend(child,parent){var F=function(){};F.prototype=parent.prototype;child.prototype=new F();child.prototype.constructor=child;child.prototype.extend=function(obj){assert(this.hasOwnProperty("extend"),"Only prototype callable");for(var prop in obj){if(obj.hasOwnProperty(prop)){this[prop]=obj[prop]}}};child.uber=parent.prototype}function superCall(instance,func){assert(instance.uber,"Not a subclass of any class");assert(instance.uber[func] instanceof Function,"super class has no functin specified");return instance.uber[func].bind(instance)}function toISODate(dateString){return dateString.replace(" ","T")+".000"+tz_info}function stopEvent(e){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation()}function deepCopy(src){if(src==null||typeof(src)!=="object"){return src}if(typeof src.clone=="function"){return src.clone(true)}if(src instanceof Date){return new Date(src.getTime())}if(src instanceof RegExp){return new RegExp(src)}if(src.nodeType&&typeof src.cloneNode=="function"){return src.cloneNode(true)}if(src instanceof Array){return src.slice(0)}var proto=(Object.getPrototypeOf?Object.getPrototypeOf(src):src.__proto__);if(!proto){proto=src.constructor.prototype}var ret=Object.create(proto);for(var key in src){ret[key]=deepCopy(src[key])}return ret}(function(){if(!Function.prototype.bind){Function.prototype.bind=function(oThis){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,fNOP=function(){},fBound=function(){return fToBind.apply(this instanceof fNOP&&oThis?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))};fNOP.prototype=this.prototype;fBound.prototype=new fNOP();return fBound}}})();String.prototype.splice=function(idx,rem,s){return(this.slice(0,idx)+s+this.slice(idx+Math.abs(rem)))};var EventTracker=(function(){function EventTracker(){this.listeners_=[]}EventTracker.Entry;EventTracker.prototype={add:function(node,eventType,listener,capture){var h={node:node,eventType:eventType,listener:listener,capture:capture};this.listeners_.push(h);node.addEventListener(eventType,listener,capture)},remove:function(node,eventType){this.listeners_=this.listeners_.filter(function(h){if(h.node==node&&(!eventType||(h.eventType==eventType))){EventTracker.removeEventListener_(h);return false}return true})},removeAll:function(){this.listeners_.forEach(EventTracker.removeEventListener_);this.listeners_=[]}};EventTracker.removeEventListener_=function(h){h.node.removeEventListener(h.eventType,h.listener,h.capture)};return EventTracker})();var global=this;this.cr=(function(){function exportPath(name,opt_object,opt_objectToExportTo){var parts=name.split(".");var cur=opt_objectToExportTo||global;for(var part;parts.length&&(part=parts.shift());){if(!parts.length&&opt_object!==undefined){cur[part]=opt_object}else{if(part in cur){cur=cur[part]}else{cur=cur[part]={}}}}return cur}function dispatchPropertyChange(target,propertyName,newValue,oldValue){var e=new cr.Event(propertyName+"Change");e.propertyName=propertyName;e.newValue=newValue;e.oldValue=oldValue;target.dispatchEvent(e)}function getAttributeName(jsName){return jsName.replace(/([A-Z])/g,"-$1").toLowerCase()}var PropertyKind={JS:"js",ATTR:"attr",BOOL_ATTR:"boolAttr"};function getGetter(name,kind){switch(kind){case PropertyKind.JS:var privateName=name+"_";return function(){return this[privateName]};case PropertyKind.ATTR:var attributeName=getAttributeName(name);return function(){return this.getAttribute(attributeName)};case PropertyKind.BOOL_ATTR:var attributeName=getAttributeName(name);return function(){return this.hasAttribute(attributeName)}}}function getSetter(name,kind,opt_setHook){switch(kind){case PropertyKind.JS:var privateName=name+"_";return function(value){var oldValue=this[name];if(value!==oldValue){this[privateName]=value;if(opt_setHook){opt_setHook.call(this,value,oldValue)}dispatchPropertyChange(this,name,value,oldValue)}};case PropertyKind.ATTR:var attributeName=getAttributeName(name);return function(value){var oldValue=this[name];if(value!==oldValue){if(value==undefined){this.removeAttribute(attributeName)}else{this.setAttribute(attributeName,value)}if(opt_setHook){opt_setHook.call(this,value,oldValue)}dispatchPropertyChange(this,name,value,oldValue)}};case PropertyKind.BOOL_ATTR:var attributeName=getAttributeName(name);return function(value){var oldValue=this[name];if(value!==oldValue){if(value){this.setAttribute(attributeName,name)}else{this.removeAttribute(attributeName)}if(opt_setHook){opt_setHook.call(this,value,oldValue)}dispatchPropertyChange(this,name,value,oldValue)}}}}function defineProperty(obj,name,opt_kind,opt_setHook){if(typeof obj=="function"){obj=obj.prototype}var kind=opt_kind||PropertyKind.JS;if(!obj.__lookupGetter__(name)){obj.__defineGetter__(name,getGetter(name,kind))}if(!obj.__lookupSetter__(name)){obj.__defineSetter__(name,getSetter(name,kind,opt_setHook))}}var uidCounter=1;function createUid(){return uidCounter++}function getUid(item){if(item.hasOwnProperty("uid")){return item.uid}return item.uid=createUid()}function dispatchSimpleEvent(target,type,opt_bubbles,opt_cancelable){var e=new cr.Event(type,opt_bubbles,opt_cancelable);return target.dispatchEvent(e)}function define(name,fun){var obj=exportPath(name);var exports=fun();for(var propertyName in exports){var propertyDescriptor=Object.getOwnPropertyDescriptor(exports,propertyName);if(propertyDescriptor){Object.defineProperty(obj,propertyName,propertyDescriptor)}}}function addSingletonGetter(ctor){ctor.getInstance=function(){return ctor.instance_||(ctor.instance_=new ctor())}}function Event(type,opt_bubbles,opt_preventable){var e=cr.doc.createEvent("Event");e.initEvent(type,!!opt_bubbles,!!opt_preventable);e.__proto__=global.Event.prototype;return e}function initialize(){if(!global.document){var originalCr=cr;Object.defineProperty(global,"cr",{get:function(){Object.defineProperty(global,"cr",{value:originalCr});originalCr.initialize();return originalCr},configurable:true});return}Event.prototype={__proto__:global.Event.prototype};cr.doc=document}return{addSingletonGetter:addSingletonGetter,createUid:createUid,define:define,defineProperty:defineProperty,dispatchPropertyChange:dispatchPropertyChange,dispatchSimpleEvent:dispatchSimpleEvent,Event:Event,getUid:getUid,initialize:initialize,PropertyKind:PropertyKind}})();cr.initialize();cr.define("cr",function(){function EventTarget(){}EventTarget.prototype={addEventListener:function(type,handler){if(!this.listeners_){this.listeners_=Object.create(null)}if(!(type in this.listeners_)){this.listeners_[type]=[handler]}else{var handlers=this.listeners_[type];if(handlers.indexOf(handler)<0){handlers.push(handler)}}},removeEventListener:function(type,handler){if(!this.listeners_){return}if(type in this.listeners_){var handlers=this.listeners_[type];var index=handlers.indexOf(handler);if(index>=0){if(handlers.length==1){delete this.listeners_[type]}else{handlers.splice(index,1)}}}},dispatchEvent:function(event){if(this["on"+event.type]){return this["on"+event.type].call(this,event)}if(!this.listeners_){return true}var self=this;event.__defineGetter__("target",function(){return self});event.preventDefault=function(){this.returnValue=false};var type=event.type;var prevented=0;if(type in this.listeners_){var handlers=this.listeners_[type].concat();for(var i=0,handler;handler=handlers[i];i++){if(handler.handleEvent){prevented|=handler.handleEvent.call(handler,event)===false}else{prevented|=handler.call(this,event)===false}}}return !prevented&&event.returnValue}};return{EventTarget:EventTarget}});cr.define("cr.settings",function(){return{resource_base:"http://ihome.ust.hk/~su_film/asset/",api_base:"http://dml085.resnet.ust.hk:49000/film/api/",login_url:"http://dml085.resnet.ust.hk:49000/film/member/login/",logout_url:"http://dml085.resnet.ust.hk:49000/film/member/logout/",url_base:"/~su_film/",scribd_id:"pub-51573345608846754358"}});cr.define("cr.ui.template",function(){var templates={},BBHandler=[{pattern:/\[b\](.+?)\[\/b\]/ig,repl:"<b>$1</b>"},{pattern:/\[i\](.+?)\[\/i\]/ig,repl:"<em>$1</em>"},{pattern:/\[u\](.+?)\[\/u\]/ig,repl:"<u>$1</u>"},{pattern:/\[big\](.+?)\[\/big\]/ig,repl:"<big>$1</big>"},{pattern:/\[small\](.+?)\[\/small\]/ig,repl:"<small>$1</small>"},{pattern:/\[color=([a-zA-Z]*|\#?[0-9a-fA-F]{6})\](.+?)\[\/color\]/ig,repl:'<span style="color:$1">$2</span>'},{pattern:/\[link\=\s*((?:(?:ftp|https?):\/\/)?(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+[A-Z]{2,6}\.?|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d+)?(?:\/?|[\/?]\S+?))\s*\](.+?)\[\/link\]/ig,repl:'<a href="$1" rel="nofollow" target="_blank">$2</a>'},{pattern:/\[img\=\s*((?:(?:ftp|https?):\/\/)?(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+[A-Z]{2,6}\.?|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d+)?(?:\/?|[\/?]\S+?))\s*\](.*?)\[\/img\]/ig,repl:'<img src="$1" alt="$2" title="$2">'}];function escapeWrap(value){return"<p>"+value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\n/g,"</p><p>")+"</p>"}function escapePreWrap(value){return value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace("\n","<br>")}function escapePre(value){return value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function escapeAttr(value){return value.replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function escapeHTML(value){return value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace("\n"," ")}function escapeBBCode(value){value=escapeWrap(value);for(var i=0;i<BBHandler.length;i++){var dup_value;do{dup_value=value;value=value.replace(BBHandler[i].pattern,BBHandler[i].repl)}while(dup_value!=value)}return value}function render_template(url,param){var template=templates[url],wrapper=document.createElement("div"),item,text,func_head,func_bottom;if(template===undefined){throw new ReferenceError("Undefined template.")}param=param||{};text=template.content||"";var argn=[],args=[];for(var prop in param){if(param.hasOwnProperty(prop)&&/^[_a-zA-Z][_a-zA-Z0-9]*$/.test(prop)){argn.push(prop);args.push("param."+prop)}}func_head="(function("+argn.join(",")+"){ return eval('";func_bottom="');})("+args.join(",")+")";var html=text.replace(/{{(.*?)}}/g,function(m,value){var arg_list,escaper=escapeHTML;value=value.trim();arg_list=value.split("|");if(arg_list[1]){switch(arg_list[1].trim()){case"safe":escaper=function(value){return value};break;case"attr":escaper=escapeAttr;break;case"bbcode":escaper=escapeBBCode;break;case"wrap":escaper=escapeWrap;break;case"pre":escaper=escapePre;break;case"prewrap":escaper=escapePreWrap;break;default:break}}var result=eval(func_head+arg_list[0].trim().replace(/'/g,"\\'")+func_bottom);if(result!=undefined){result=""+result}else{result=""}return escaper(result)});wrapper.innerHTML=html;item=wrapper.firstChild||document.createElement("div");if(template.callback){template.callback.call(item,param)}return item}function globalInitialization(){var pending=[],complete_cnt=0;for(var url in templates){var xhr=new XMLHttpRequest();xhr.open("GET",cr.settings.resource_base+"templates/"+url,true);xhr.onload=(function(url){templates[url].content=this.responseText.trim();complete_cnt++;if(complete_cnt==pending.length){cr.dispatchSimpleEvent(window,"moduleload",false,false)}}).bind(xhr,url);xhr.onerror=function(e){e.recObj={errno:xhr.status,error:""};cr.errorHandler(e)};pending.push(xhr)}for(var i=0;i<pending.length;i++){pending[i].send(null)}if(pending.length===0){cr.dispatchSimpleEvent(window,"moduleload",false,false)}}function register(url,callback){templates[url]={content:null,callback:callback}}function registerBBCode(pattern,repl){assert(pattern instanceof RegExp,"pattern must be RegExp");BBHandler.push({pattern:pattern,repl:repl})}return{globalInitialization:globalInitialization,render_template:render_template,register:register,registerBBCode:registerBBCode,escapeAttr:escapeAttr,escapeBBCode:escapeBBCode}});document.addEventListener("DOMContentLoaded",cr.ui.template.globalInitialization);cr.define("cr",function(){var dirty_listening=[];function BaseModel(name){Object.defineProperty(this,"name",{value:name});this._cache={};this.fields=[]}function APIRequest(model,method,api,force_new){var base_url=cr.settings.api_base+model.name+api;this.xhr=new XMLHttpRequest();if(method==="GET"&&force_new){this.xhr.open(method,base_url+((/\?/).test(base_url)?"&":"?")+(new Date()).getTime(),true)}else{this.xhr.open(method,base_url,true)}this.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");this.xhr.withCredentials=true;this.xhr.onprogress=(function(e){if(this.onloadprogress){this.onloadprogress(e)}}).bind(this);this.xhr.upload.onprogress=(function(e){if(this.onuploadprogress){this.onuploadprogress(e)}}).bind(this);this.xhr.onreadystatechange=(function(){if(this.xhr.readyState===4){if(this.xhr.status===200){try{var obj=JSON.parse(this.xhr.responseText);this.success=obj.errno===0;this.data=obj;e=new cr.Event((obj.errno===0)?"load":"error",false,true);e.recObj=obj}catch(exception){this.success=false;this.data={errno:2,error:"Error receiving data"};e=new cr.Event("error",false,true);e.recObj={errno:2,error:"Error receiving data"}}}else{this.success=false;this.data={errno:this.xhr.status,error:this.xhr.statusText};e=new cr.Event("error",false,true);e.recObj={errno:this.xhr.status,error:this.xhr.statusText}}this.dispatchEvent(e)}}).bind(this)}extend(APIRequest,cr.EventTarget);APIRequest.prototype.extend({onload:null,onerror:null,onuploadprogress:null,onloadprogress:null,send:function(){this.xhr.send()},sendRaw:function(data){this.xhr.send(data)},sendForm:function(data){this.xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");this.xhr.send(data)},sendJSON:function(obj){this.xhr.setRequestHeader("Content-Type","application/json");this.xhr.send(JSON.stringify(obj))}});BaseModel.prototype={update:function(data,level){if(!this._cache[data.id]){this._cache[data.id]={data:{}}}for(var key in data){if(this.fields.indexOf(key)!==-1){this._cache[data.id].data[key]=data[key]}}this._cache[data.id].dirty=level},get:function(id,callback){if(this._cache[id]&&this._cache[id].dirty>0){if(callback){callback(deepCopy(this._cache[id].data))}}else{var r=new APIRequest(this,"GET","/"+id+"/",this._cache[id]);r.onload=(function(e){this.update(e.recObj,1);if(callback){callback(deepCopy(this._cache[id].data))}}).bind(this);r.onerror=function(e){cr.errorHandler(e)};r.send()}},put:function(id,data,update,callback){var r=new APIRequest(this,"PUT","/"+id+"/");r.onload=(function(e){if(update){this.update(e.recObj,2)}if(callback){callback(deepCopy(this._cache[id].data))}}).bind(this);r.onerror=function(e){cr.errorHandler(e)};r.sendJSON(data)},post:function(data,callback){var r=new APIRequest(this,"POST","/");r.onload=(function(e){this.update(e.recObj,2);if(callback){callback(deepCopy(this._cache[e.recObj.id].data))}}).bind(this);r.onerror=function(e){cr.errorHandler(e)};r.sendJSON(data)},remove:function(id,callback){var r=new APIRequest(this,"DELETE","/"+id+"/");r.onload=(function(e){if(this._cache[e.recObj.id]){delete this._cache[e.recObj.id]}if(callback){callback(e.recObj)}}).bind(this);r.onerror=function(e){cr.errorHandler(e)};r.send()},setup:function(refresh){if(refresh){addDirty(this)}}};function addDirty(model){dirty_listening.push(model)}function ModelInit(){var delay=6*60*1000;var refresh_dirty=function(){var r=new APIRequest({name:"dirty"},"GET","/",true);r.onerror=function(e){if(e.recObj.errno!==403){setTimeout(refresh_dirty,delay)}};r.onload=function(e){for(var i=0;i<dirty_listening.length;i++){var model=dirty_listening[i],list=e.recObj[model.name];for(var j=0;list&&j<list.length;j++){model._cache[list[i]]&&(model._cache[list[i]].dirty--)}}setTimeout(refresh_dirty,delay)};r.send()};setTimeout(refresh_dirty,delay)}return{BaseModel:BaseModel,APIRequest:APIRequest,ModelInit:ModelInit}});cr.ModelInit();cr.define("cr",function(){function Pager(model,query){Object.defineProperty(this,"model",{value:model});Object.defineProperty(this,"has_prev",{get:function(){return this._cache[this.pos].meta.previous.length>0}});Object.defineProperty(this,"has_next",{get:function(){return this._cache[this.pos].meta.next.length>0}});Object.defineProperty(this,"page",{get:function(){return this._cache[this.pos].meta.page}});Object.defineProperty(this,"total",{get:function(){return this._cache[this.pos].meta.total}});Object.defineProperty(this,"obj_list",{get:function(){return this._cache[this.pos].objects}});this._cache={};this.pos=0;(loadPage.bind(this))(query,0)}function readPage(entry,callback){var objs=[],loaded=0;for(var i=0;i<entry.objects.length;i++){this.model.get(entry.objects[i],(function(p,instance){objs[p]=instance;loaded++;if(loaded===entry.objects.length){if(callback){callback.call(this,objs)}}}).bind(this,i))}if(entry.objects.length===0){callback.call(this,objs)}}function loadPage(query,pos,callback){if(this._cache[pos]){if(this._cache[pos].state===1){(readPage.bind(this))(this._cache[pos],callback)}else{this._cache[pos].callback=callback}}else{if(!query){return}this._cache[pos]={state:0,callback:callback,objects:[],meta:{}};var r=new cr.APIRequest(this.model,"GET",query);r.onload=(function(ev){var entry=this._cache[pos],obj=ev.recObj;entry.meta=deepCopy(obj.meta);for(var i=0;i<obj.objects.length;i++){this.model.update(obj.objects[i],1);entry.objects.push(obj.objects[i].id)}entry.state=1;if(entry.callback){entry.callback.call(this,obj.objects)}}).bind(this);r.onerror=cr.errorHandler;r.send()}}Pager.prototype={load:function(callback){(loadPage.bind(this))(null,this.pos,function(){if(callback){callback.apply(this,arguments)}if(!this._cache[this.pos+1]){(loadPage.bind(this))(this._cache[this.pos].meta.next,this.pos+1,null)}if(!this._cache[this.pos-1]){(loadPage.bind(this))(this._cache[this.pos].meta.previous,this.pos-1,null)}})},next:function(callback){if(this._cache[this.pos].meta.next){this.pos++}(loadPage.bind(this))(null,this.pos,function(){if(callback){callback.apply(this,arguments)}if(!this._cache[this.pos+1]){(loadPage.bind(this))(this._cache[this.pos].meta.next,this.pos+1,null)}})},prev:function(callback){if(this._cache[this.pos].meta.previous){this.pos--}(loadPage.bind(this))(null,this.pos,function(){if(callback){callback.apply(this,arguments)}if(!this._cache[this.pos-1]){(loadPage.bind(this))(this._cache[this.pos].meta.previous,this.pos-1,null)}})}};return{Pager:Pager}});cr.define("routerManager",function(){function getHash(){var hash=location.hash.substr(1),qs=parseLocationParams(window.location);if(qs._escaped_fragment_){return qs._escaped_fragment_}if(hash.charAt(0)=="!"){hash=hash.substr(1)}return hash}function parseQueryParams(query){var params={};var vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");params[pair[0]]=decodeURIComponent(pair[1])}return params}function parseHash(){var hashString=getHash(),query;var q_pos=hashString.indexOf("?");if(q_pos===-1){query={}}else{query=hashString.slice(q_pos+1,hashString.length);query=parseQueryParams(query);hashString=hashString.slice(0,q_pos)}if(hashString.length===0){this.pushState(this.defaultRouter.url,true);return}if(hashString[hashString.length-1]!=="/"){hashString=hashString+"/"}for(var i=0;i<this.routers.length;i++){var router=this.routers[i];if(router.re.test(hashString)){var args;hashString.replace(router.re,function(){var end=Array.prototype.indexOf.call(arguments,0);args=Array.prototype.slice.call(arguments,1,end);for(var i=0;i<args.length;i++){args[i]=decodeComponent(args[i])}});args.push(query);router.callback.apply(router,args);return}}cr.notFoundHandler(hashString)}function globalInitialization(){window.addEventListener("authload",(function(){window.onpopstate=parseHash.bind(this);this.parseHash()}).bind(this));this.routers=[];this.notFoundHandler=function(){};this.defaultRouter={url:"",callback:function(){},re:new RegExp("")}}function encodeComponent(url){return url.replace("!","!0").replace("/","!1")}function decodeComponent(componnet){return componnet.replace("!1","/").replace("!0","!")}function pushState(url,replace,custom){if(url===getHash()){return}var historyFunction=!replace?window.history.pushState:window.history.replaceState,prefix=this.prefix==0?"#":"#!";historyFunction.call(window.history,{},"",prefix+url);if(!custom){this.parseHash()}}function register(pattern,isDefault,callback){assert(pattern instanceof RegExp,"Regular Expression wanted");var router={url:pattern.source.replace("\\/","/"),callback:callback,re:new RegExp("^"+pattern.source+"$")};this.routers.push(router);if(isDefault===true){this.defaultRouter=router}}function markTracker(){if(window.ga){ga("send","pageview",{page:cr.settings.url_base+getHash()})}}return{globalInitialization:globalInitialization,encodeComponent:encodeComponent,decodeComponent:decodeComponent,pushState:pushState,register:register,parseHash:parseHash,markTracker:markTracker,prefix:0}});routerManager.globalInitialization();cr.define("cr.ui",function(){function decorate(source,constr){var elements;if(typeof source=="string"){elements=cr.doc.querySelectorAll(source)}else{elements=[source]}for(var i=0,el;el=elements[i];i++){if(!(el instanceof constr)){constr.decorate(el)}}}function createElementHelper(tagName,opt_bag){var doc;if(opt_bag&&opt_bag.ownerDocument){doc=opt_bag.ownerDocument}else{doc=cr.doc}return doc.createElement(tagName)}function define(tagNameOrFunction){var createFunction,tagName;if(typeof tagNameOrFunction=="function"){createFunction=tagNameOrFunction;tagName=""}else{createFunction=createElementHelper;tagName=tagNameOrFunction}function f(opt_propertyBag){var el=createFunction(tagName,opt_propertyBag);f.decorate(el);for(var propertyName in opt_propertyBag){el[propertyName]=opt_propertyBag[propertyName]}return el}f.decorate=function(el){el.__proto__=f.prototype;el.decorate()};return f}function limitInputWidth(el,parentEl,min,opt_scale){el.style.width="10px";var doc=el.ownerDocument;var win=doc.defaultView;var computedStyle=win.getComputedStyle(el);var parentComputedStyle=win.getComputedStyle(parentEl);var rtl=computedStyle.direction=="rtl";var inputRect=el.getBoundingClientRect();var parentRect=parentEl.getBoundingClientRect();var startPos=rtl?parentRect.right-inputRect.right:inputRect.left-parentRect.left;var inner=parseInt(computedStyle.borderLeftWidth,10)+parseInt(computedStyle.paddingLeft,10)+parseInt(computedStyle.paddingRight,10)+parseInt(computedStyle.borderRightWidth,10);var parentPadding=rtl?parseInt(parentComputedStyle.paddingLeft,10):parseInt(parentComputedStyle.paddingRight,10);var max=parentEl.clientWidth-startPos-inner-parentPadding;if(opt_scale){max*=opt_scale}function limit(){if(el.scrollWidth>max){el.style.width=max+"px"}else{el.style.width=0;var sw=el.scrollWidth;if(sw<min){el.style.width=min+"px"}else{el.style.width=sw+"px"}}}el.addEventListener("input",limit);limit()}function toCssPx(pixels){if(!window.isFinite(pixels)){console.error("Pixel value is not a number: "+pixels)}return Math.round(pixels)+"px"}function swallowDoubleClick(e){var doc=e.target.ownerDocument;var counter=Math.min(1,e.detail);function swallow(e){e.stopPropagation();e.preventDefault()}function onclick(e){if(e.detail>counter){counter=e.detail;swallow(e)}else{doc.removeEventListener("dblclick",swallow,true);doc.removeEventListener("click",onclick,true)}}setTimeout(function(){doc.addEventListener("click",onclick,true);doc.addEventListener("dblclick",swallow,true)},0)}return{decorate:decorate,define:define,limitInputWidth:limitInputWidth,toCssPx:toCssPx,swallowDoubleClick:swallowDoubleClick}});(function(){if("ontouchstart" in document.documentElement){var listener=function(e){var old=document.body.querySelectorAll(".hover");for(var i=0;i<old.length;i++){old[i].classList.remove("hover")}findAncestor(e.target,function(node){if(node.classList){node.classList.add("hover")}return !node.classList})};document.addEventListener("mouseover",listener,true);document.addEventListener("touchstart",listener,true);try{var ignore=":hover",orig=/:hover/g,replace=".hover";for(var i=0;i<document.styleSheets.length;i++){var sheet=document.styleSheets[i];for(var j=0;sheet.cssRules&&j<sheet.cssRules.length;j++){var rule=sheet.cssRules[j];if(rule.type===CSSRule.STYLE_RULE&&rule.selectorText.search(ignore)!==-1){rule.selectorText=rule.selectorText.replace(orig,replace)}}}}catch(e){}}})();(function(){var requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){setTimeout(function(){callback(Date.now())},30)};window.requestAnimationFrame=requestAnimationFrame})();cr.define("cr.ui",function(){function scrollList(elem,wrapper,pager,conf){var default_conf={onfirstload:function(){return true},onload:function(obj,idx){return true},deleteAnchor:true,anchorClass:".anchor"},that=this;conf=conf||{};for(var key in default_conf){if(conf[key]==null){conf[key]=default_conf[key]}}that.elem=elem;that.wrapper=wrapper;that.pager=pager;that.onfirstload=conf.onfirstload;that.onload=conf.onload;that.deleteAnchor=conf.deleteAnchor;that.first_load=true;that.ajax_loading=true;that.anchor_element=elem.querySelector(conf.anchorClass)}function handleScroll(e){if(this.ajax_loading){return}e.preventDefault();e.stopImmediatePropagation();var that=this,elem=that.wrapper,scrollTop=elem.scrollTop,windowHeight=elem.clientHeight,scrollHeight=elem.scrollHeight;if(scrollTop+windowHeight+15>scrollHeight){that.ajax_loading=true;that.pager.next(loadItem.bind(that))}}function loadItem(obj_list){var that=this,elem=that.elem,pager=that.pager;for(var i=0;i<obj_list.length;i++){that.onload&&that.onload(obj_list[i],i)}if(that.first_load){that.onfirstload&&that.onfirstload(obj_list)}if(!pager.has_next){if(!that.first_load||that.deleteAnchor||obj_list.length>0){elem.removeChild(that.anchor_element)}that.wrapper.removeEventListener("scroll",that.scrollcbk)}that.first_load=false;that.ajax_loading=false}scrollList.prototype={load:function(){var that=this;that.scrollcbk=handleScroll.bind(that);that.wrapper.addEventListener("scroll",that.scrollcbk);that.pager.load(loadItem.bind(that))}};return{scrollList:scrollList}});cr.define("cr.ui",function(){var notificationTimeout=null;function showNotification(text,actionText,opt_delay){var notificationElement=$("notification");var actionLink=notificationElement.querySelector(".link-color");var delay=opt_delay||5000;function show(){window.clearTimeout(notificationTimeout);notificationElement.classList.add("show");document.body.classList.add("notification-shown")}function hide(){window.clearTimeout(notificationTimeout);notificationElement.classList.remove("show");document.body.classList.remove("notification-shown");actionLink.tabIndex=-1;actionLink.blur()}function delayedHide(){notificationTimeout=window.setTimeout(hide,delay)}notificationElement.firstElementChild.textContent=text;actionLink.textContent=actionText;actionLink.onclick=hide;actionLink.onkeydown=function(e){if(e.keyIdentifier=="Enter"){hide()}};notificationElement.onmouseover=show;notificationElement.onmouseout=delayedHide;actionLink.onfocus=show;actionLink.onblur=delayedHide;actionLink.tabIndex=0;show();delayedHide()}return{showNotification:showNotification}});cr.define("cr.ui.bbcode",function(){function globalInitialization(){cr.ui.template.registerBBCode(/\[inlinedisk\](\d+)\[\/inlinedisk\]/ig,'<a class="richtext-inline-disk" href="#!library/$1/" remote_id="$1">...</a>');cr.ui.template.registerBBCode(/\[disk\](\d+)\[\/disk\]/ig,'<div class="richtext-disk" remote_id="$1"></div>');cr.ui.template.registerBBCode(/\[rfs\](\d+)\[\/rfs\]/ig,'<div class="richtext-rfs" remote_id="$1"></div>');cr.ui.template.registerBBCode(/\[ticket\](\d+)\[\/ticket\]/ig,'<div class="richtext-ticket" remote_id="$1"></div>');cr.ui.template.register("richtext_disk.html",function(param){var cover=this.querySelector(".richtext-disk-cover");if(param.disk.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.disk.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}});cr.ui.template.register("richtext_rfs.html",function(param){var items=this.querySelectorAll(".richtext-rfs-item");for(var i=0;i<items.length;i++){var item=items[i],disk=param.rfs["film_"+item.getAttribute("refer")];if(disk.cover_url){item.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+disk.cover_url.url+")"}else{item.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}}});cr.ui.template.register("richtext_ticket.html",function(param){var cover=this.querySelector(".richtext-disk-cover");if(param.ticket.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.ticket.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}})}function handleHTML(elem){var inline_disks=elem.querySelectorAll(".richtext-inline-disk"),disks=elem.querySelectorAll(".richtext-disk"),rfss=elem.querySelectorAll(".richtext-rfs"),tickets=elem.querySelectorAll(".richtext-ticket");for(var i=0;i<inline_disks.length;i++){var entry=inline_disks[i],id=entry.getAttribute("remote_id");cr.model.Disk.get(id,(function(disk){this.textContent=disk.title_en+" / "+disk.title_ch}).bind(entry));entry.addEventListener("click",function(e){e.preventDefault();e.stopImmediatePropagation();routerManager.pushState(this.getAttribute("href").substr(2),false,false)})}for(var i=0;i<disks.length;i++){var entry=disks[i],id=entry.getAttribute("remote_id");cr.model.Disk.get(id,(function(disk){var info=cr.ui.template.render_template("richtext_disk.html",{disk:disk});this.appendChild(info);info.classList.remove("loading")}).bind(entry))}for(var i=0;i<rfss.length;i++){var entry=rfss[i],id=entry.getAttribute("remote_id");cr.model.RegularFilmShow.get(id,(function(rfs){var info=cr.ui.template.render_template("richtext_rfs.html",{rfs:rfs});this.appendChild(info);info.classList.remove("loading")}).bind(entry))}for(var i=0;i<tickets.length;i++){var entry=tickets[i],id=entry.getAttribute("remote_id");cr.model.PreviewShowTicket.get(id,(function(ticket){var info=cr.ui.template.render_template("richtext_ticket.html",{ticket:ticket});this.appendChild(info);info.classList.remove("loading")}).bind(entry))}}return{globalInitialization:globalInitialization,handleHTML:handleHTML}});cr.ui.bbcode.globalInitialization();cr.define("cr.model",function(){var File=new cr.BaseModel("file"),User=new cr.BaseModel("user"),Disk=new cr.BaseModel("disk"),RegularFilmShow=new cr.BaseModel("regularfilmshow"),PreviewShowTicket=new cr.BaseModel("previewshowticket"),DiskReview=new cr.BaseModel("diskreview"),News=new cr.BaseModel("news"),Document=new cr.BaseModel("document"),Publication=new cr.BaseModel("publication"),Sponsor=new cr.BaseModel("sponsor"),Exco=new cr.BaseModel("exco"),SiteSettings=new cr.BaseModel("sitesettings"),OneSentence=new cr.BaseModel("onesentence");File.fields=["id","name","url"];User.fields=["id","expire_at","admin","full_name","itsc","member_type","pennalized","rfs_count","login_count"];Disk.fields=["id","director_en","director_ch","category","create_log","imdb_url","show_year","avail_type","actors","desc_en","tags","title_en","cover_url","disk_type","due_at","borrow_cnt","length","desc_ch","title_ch","user_held"];Disk.CN=function(disk){return disk.disk_type+pad(disk.id,4)};RegularFilmShow.fields=["id","state","film_1","film_2","film_3","vote_cnt_1","vote_cnt_2","vote_cnt_3","remarks","create_log"];PreviewShowTicket.fields=["id","state","title_en","title_ch","desc_en","desc_ch","director_en","director_ch","actors","cover_url","language","subtitle","venue","show_time","apply_deadline","length","quantity","remarks","successful_applicant","create_log"];DiskReview.fields=["id","disk","content","create_log"];News.fields=["id","title","content","create_log"];Document.fields=["id","title","doc_url","create_log"];Publication.fields=["id","pub_type","title","cover_url","doc_url","ext_doc_url","create_log"];Sponsor.fields=["id","name","img_url"];Exco.fields=["id","name_en","name_ch","descript","position","email","img_url"];SiteSettings.fields=["id","key","value"];SiteSettings._cache_dict={};SiteSettings.loadSettings=function(callback){var r=new cr.APIRequest(this,"GET","/",true);r.onload=function(e){for(var i=0;i<e.recObj.objects.length;i++){SiteSettings.update(e.recObj.objects[i],1);SiteSettings._cache_dict[e.recObj.objects[i].key]=e.recObj.objects[i].id}if(callback){callback()}};r.onerror=cr.errorHandler;r.send()};SiteSettings.getField=function(field){if(!this._cache_dict[field]){return null}return this._cache[this._cache_dict[field]].data};OneSentence.fields=["id","content","film"];return{File:File,User:User,Disk:Disk,RegularFilmShow:RegularFilmShow,PreviewShowTicket:PreviewShowTicket,DiskReview:DiskReview,News:News,Document:Document,Publication:Publication,Sponsor:Sponsor,Exco:Exco,SiteSettings:SiteSettings,OneSentence:OneSentence}});cr.model.Disk.setup(true);cr.model.RegularFilmShow.setup(true);cr.model.PreviewShowTicket.setup(true);cr.model.News.setup(true);cr.model.Document.setup(true);cr.model.Publication.setup(true);cr.model.Sponsor.setup(true);cr.model.Exco.setup(true);cr.define("cr.ui",function(){function replaceContent(repl,callback){var container=$("content-wrapper");container.classList.add("loading");if(repl instanceof HTMLElement||repl instanceof DocumentFragment){setTimeout(function(){container.setAttribute("hidden",true);while(container.firstChild){container.removeChild(container.firstChild)}container.appendChild(repl);container.removeAttribute("hidden");setTimeout(function(){container.classList.remove("loading")},0);if(callback){callback()}},cr.view.name?210:0)}else{if(repl instanceof Function){setTimeout(function(){container.setAttribute("hidden",true);while(container.firstChild){container.removeChild(container.firstChild)}repl(container);container.removeAttribute("hidden");setTimeout(function(){container.classList.remove("loading")},0);if(callback){callback()}},cr.view.name?210:0)}else{container.classList.remove("loading");assert(false,"Error processing content")}}}function changeSelection(name){var navItem=document.querySelector('#footer a[controls="'+name+'"]');setSelection(navItem)}function setSelection(newSelection){var lastSelectedNavItem=document.querySelector("#footer a.selected");if(lastSelectedNavItem!==newSelection){newSelection.classList.add("selected");if(lastSelectedNavItem){lastSelectedNavItem.classList.remove("selected")}}}return{replaceContent:replaceContent,changeSelection:changeSelection,setSelection:setSelection}});cr.define("cr.ui.select",function(){function init(elem){elem.value="";elem.name=elem.getAttribute("name");elem.type="select";elem.querySelector(".custom-options").addEventListener("click",function(e){if(e.target===this){return}elem.querySelector(".default").textContent=e.target.textContent;elem.value=e.target.getAttribute("value");this.setAttribute("hidden",true);setTimeout((function(){this.removeAttribute("hidden")}).bind(this),0)})}return{init:init}});cr.define("OneSentence",function(){function Initialization(){var r=new cr.APIRequest(cr.model.OneSentence,"GET","/rand/",true);r.onload=function(e){var sentence_container=$("onesentence");sentence_container.querySelector("span").textContent=e.recObj.content;sentence_container.setAttribute("tooltip","From: "+cr.ui.template.escapeAttr(e.recObj.film))};r.onerror=function(e){};r.send()}return{Initialization:Initialization}});document.addEventListener("DOMContentLoaded",OneSentence.Initialization);cr.define("Application",function(){var membership_table={Full:"Full Member",OneSem:"One Semester Member",OneYear:"One Year Member",TwoYear:"Two Year Member",ThreeYear:"Three Year Member",Honour:"Honour Member",Assoc:"Asscocitate Member"};function initialization(){window.addEventListener("moduleload",function(){var r=new cr.APIRequest(cr.model.User,"GET","/current_user/",true);r.onload=function(ev){cr.define("cr",function(){return{user:deepCopy(ev.recObj)}});var user_panel=cr.ui.template.render_template("user_panel.html",{user:ev.recObj,table:membership_table});user_panel.querySelector(".link-logout").addEventListener("click",function(){var next=location.hash.substr(1),url=cr.settings.logout_url+(next?"?next="+next:"");location.href=url});user_panel.querySelector(".link-info").addEventListener("click",function(){routerManager.pushState("userinfo/")});user_panel.querySelector(".link-admin").addEventListener("click",function(){window.open("admin/")});$("header").replaceChild(user_panel,$("user-wrapper"));cr.ui.showNotification(ev.recObj.full_name+", Welcome back!","dismiss");cr.model.SiteSettings.loadSettings(function(){cr.dispatchSimpleEvent(window,"authload",false,false)})};r.onerror=function(ev){if(ev.recObj.errno===2){$("user-wrapper").querySelector(".link-login").addEventListener("click",function(){var next=location.hash.substr(1),url=cr.settings.login_url+(next?"?next="+next:""),redirect="https://cas.ust.hk/cas/login?service="+encodeURIComponent(url);location.href=redirect});cr.model.SiteSettings.loadSettings(function(){cr.dispatchSimpleEvent(window,"authload",false,false)})}else{errorHandler(ev)}};r.send()});window.addEventListener("authload",cr.ui.hideLoading);cr.define("cr",function(){return{errorHandler:errorHandler,notFoundHandler:notFoundHandler}});$("footer").addEventListener("click",function(e){var target=e.target,control=target.getAttribute("href").substr(2);if(target.getAttribute("eternal")=="true"){return}routerManager.pushState(control,false,false);e.preventDefault();e.stopPropagation()},true);routerManager.prefix=1;routerManager.register(/userinfo\//,false,userInfo)}function userInfo(){cr.view.name="userinfo";document.title="User Information | Film Society, HKUSTSU";var user_template=cr.ui.template.render_template("user_template.html");cr.ui.replaceContent(user_template,(function(){var node=this,r=new cr.APIRequest(cr.model.User,"GET","/current_user/",true);r.onload=function(ev){cr.define("cr",function(){return{user:deepCopy(ev.recObj)}});var user_container=cr.ui.template.render_template("user_info.html",{user:cr.user,table:membership_table});node.querySelector(".user-content-wrapper").appendChild(user_container);user_container.removeAttribute("hidden");node.classList.remove("loading");setTimeout(function(){user_container.classList.remove("loading")},0)};r.onerror=function(ev){if(ev.recObj.errno===2){var next=location.hash.substr(1),url=cr.settings.login_url+(next?"?next="+next:""),redirect="https://cas.ust.hk/cas/login?service="+encodeURIComponent(url);location.href=redirect}else{errorHandler(ev)}};r.send()}).bind(user_template))}function errorHandler(ev){var errno=ev.recObj.errno,error=ev.recObj.error||"Connection Failed";switch(errno){case 0:case 1:case 2:case 3:cr.ui.showNotification(error,"dismiss");break;case 404:notFoundHandler();break;default:cr.ui.showNotification("Server: "+error,"try again later")}}function notFoundHandler(){var content=cr.ui.template.render_template("error_page.html",{text:"Oops... 404 Page Not Found."});cr.view.name="404";document.title="404 Page Not Found | Film Society, HKUSTSU";cr.ui.replaceContent(content)}function collectForm(content){var inputs=content.querySelectorAll("input:enabled, select:enabled, textarea:enabled, .input"),payload={};for(var i=0;i<inputs.length;i++){payload[inputs[i].name]=(inputs[i].type==="checkbox")?inputs[i].checked:inputs[i].value;if(payload[inputs[i].name]==undefined||payload[inputs[i].name]===""){payload[inputs[i].name]=null;if(inputs[i].getAttribute("role")==="list"){payload[inputs[i].name]=""}}}return payload}return{initialization:initialization,collectForm:collectForm}});document.addEventListener("DOMContentLoaded",Application.initialization);cr.ui.template.register("user_panel.html");cr.ui.template.register("error_page.html");cr.ui.template.register("user_template.html");cr.ui.template.register("user_info.html",function(param){function generateEntry(disk){var entry=createElementWithClassName("a","user-disk-entry");entry.title=disk.title_en+"/"+disk.title_ch;entry.href="#!library/"+disk.id+"/";entry.disk_id=disk.id;if(disk.cover_url){entry.style.backgroundImage=cssurl(cr.settings.resource_base+"upload/"+disk.cover_url)}else{entry.style.backgroundImage=cssurl(cr.settings.resource_base+"css/question.png")}entry.addEventListener("click",function(e){stopEvent(e);routerManager.pushState("library/"+this.disk_id+"/")});return entry}var borrow_list=this.querySelector(".user-borrowed .user-disk-list"),reserve_list=this.querySelector(".user-reserved .user-disk-list"),history_list=this.querySelector(".user-history .user-disk-list"),user=param.user;for(var i=0;i<user.borrowed.length;i++){borrow_list.appendChild(generateEntry(user.borrowed[i]))}for(var i=0;i<user.reserved.length;i++){reserve_list.appendChild(generateEntry(user.reserved[i]))}for(var i=0;i<user.borrow_history.length;i++){history_list.appendChild(generateEntry(user.borrow_history[i]))}});cr.define("cr.view.library",function(){var name="library";function Initialization(){routerManager.register(/library\//,false,liba_setup(liba_list));routerManager.register(/library\/search\//,false,liba_setup(liba_search));routerManager.register(/library\/(\d+)\//,false,liba_setup(liba_disk));routerManager.register(/library\/rand\//,false,liba_setup(liba_rand));cr.ui.template.register("liba_template.html",function(){var node=this;liba_suggest(node);this.querySelector('button[controls="search"]').addEventListener("click",function(){var value=node.querySelector('input[name="search_term"]').value;if(value){routerManager.pushState("library/search/?q="+encodeURIComponent(value),false,true);liba_switch(node,liba_search,[{q:value}])}});this.querySelector('a[controls="random"]').addEventListener("click",function(e){e.preventDefault();routerManager.pushState("library/rand/",false,true);liba_switch(node,liba_rand)});this.querySelector('a[controls="popular"]').addEventListener("click",function(e){e.preventDefault();routerManager.pushState("library/?mode=popular",false,true);liba_switch(node,liba_list,[{mode:"popular"}])});this.querySelector('a[controls="rank"]').addEventListener("click",function(e){e.preventDefault();routerManager.pushState("library/?mode=rank",false,true);liba_switch(node,liba_list,[{mode:"rank"}])})});cr.ui.template.register("liba_suggest_item.html",function(param){var cover=this.querySelector(".item-cover");if(param.disk.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.disk.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}});cr.ui.template.register("liba_list.html");cr.ui.template.register("liba_list_notfound.html",function(){this.querySelector(".link-goback").addEventListener("click",function(){if(history.length>1){history.go(-1)}else{routerManager.pushState("library/",false,true);liba_switch(document.querySelector(".library-wrapper"),liba_list,[{}])}})});cr.ui.template.register("liba_list_item.html",function(param){var cover=this.querySelector("div.disk-cover-border"),button=this.querySelector(".disk-detail-button");if(param.disk.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.disk.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}button.addEventListener("click",(function(id,e){e.preventDefault();routerManager.pushState("library/"+id+"/",false,true);liba_switch(document.querySelector(".library-wrapper"),liba_disk,[id])}).bind(null,param.disk.id))});cr.ui.template.register("liba_disk.html",function(){var overlay=this.querySelector(".popup-overlay");overlay.addEventListener("close",function(){this.classList.add("loading");setTimeout((function(){this.setAttribute("hidden",true)}).bind(this),210)});overlay.addEventListener("click",function(e){e.target===this&&cr.dispatchSimpleEvent(this,"close",true,true)});overlay.addEventListener("keydown",function(e){if(e.keyCode===27){cr.dispatchSimpleEvent(this,"close",true,true)}});overlay.querySelector(".close-button").addEventListener("click",function(){cr.dispatchSimpleEvent(overlay,"close",true,true)})});cr.ui.template.register("liba_disk_detail.html",function(param){var cover=this.querySelector(".disk-brief .disk-cover");if(param.disk.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.disk.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}this.querySelector(".link-goback").addEventListener("click",function(){if(history.length>1){history.go(-1)}else{routerManager.pushState("library/",false,true);liba_switch(document.querySelector(".library-wrapper"),liba_list,[{}])}});var actor_wrapper=this.querySelector(".actors-wrapper");for(var i=0;i<param.disk.actors.length;i++){var act=createElementWithClassName("span","link link-search");act.setAttribute("tag","actor");act.textContent=param.disk.actors[i];(i>0)&&actor_wrapper.appendChild(createElementWithClassName("span","space"));actor_wrapper.appendChild(act)}var tag_wrapper=this.querySelector(".tags-wrapper");for(var i=0;i<param.disk.tags.length;i++){var tag=createElementWithClassName("span","link link-search");tag.setAttribute("tag","tag");tag.textContent=param.disk.tags[i];(i>0)&&tag_wrapper.appendChild(createElementWithClassName("span","space"));tag_wrapper.appendChild(tag)}var search_btns=this.querySelectorAll(".link-search");for(var i=0;i<search_btns.length;i++){search_btns[i].addEventListener("click",function(e){var tag=this.getAttribute("tag"),q=tag+":("+this.textContent+")";routerManager.pushState("library/search/?q="+encodeURIComponent(q),false,true);liba_switch(document.querySelector(".library-wrapper"),liba_search,[{q:q}])})}this.querySelector('button[controls="reserve"]').addEventListener("click",function(){var popup=document.querySelector(".library-wrapper .library-disk .popup-overlay"),box=popup.querySelector(".popup-box"),content=box.querySelector(".content"),reserve_form=cr.ui.template.render_template("liba_disk_reserve.html",{disk:param.disk});box.querySelector("h1").textContent="Reserve Disk";while(content.firstChild){content.removeChild(content.firstChild)}content.appendChild(reserve_form);box.classList.remove("loading");popup.removeAttribute("hidden");setTimeout(function(){popup.classList.remove("loading")},0)});this.querySelector('button[controls="renew"]').addEventListener("click",function(){var popup=document.querySelector(".library-wrapper .library-disk .popup-overlay"),box=popup.querySelector(".popup-box"),content=box.querySelector(".content"),renew_form=cr.ui.template.render_template("liba_disk_renew.html",{disk:param.disk});box.querySelector("h1").textContent="Renew Disk";while(content.firstChild){content.removeChild(content.firstChild)}content.appendChild(renew_form);box.classList.remove("loading");popup.removeAttribute("hidden");setTimeout(function(){popup.classList.remove("loading")},0)})});cr.ui.template.register("liba_disk_reserve.html",function(param){var node=this,selects=this.querySelectorAll(".custom-select");for(var i=0;i<selects.length;i++){cr.ui.select.init(selects[i])}this.querySelector('button[controls="deliver"]').addEventListener("click",function(){var payload=Application.collectForm(node.querySelector(".reserve-delivery")),r=new cr.APIRequest(cr.model.Disk,"POST","/"+param.disk.id+"/reservation/");payload.form="Hall";payload.hall=~~(payload.hall);r.onload=function(e){var disk=e.recObj;cr.model.Disk.update(disk,1);cr.ui.showNotification("Disk reserved","dismiss");history.go()};r.onerror=function(e){node.classList.remove("loading");cr.errorHandler(e)};node.classList.add("loading");r.sendJSON(payload)});this.querySelector('button[controls="reserve"]').addEventListener("click",function(){var r=new cr.APIRequest(cr.model.Disk,"POST","/"+param.disk.id+"/reservation/"),payload={form:"Counter"};r.onload=function(e){var disk=e.recObj;cr.model.Disk.update(disk,2);cr.ui.showNotification("Disk reserved","dismiss");history.go()};r.onerror=function(e){node.classList.remove("loading");cr.errorHandler(e)};node.classList.add("loading");r.sendJSON(payload)})});cr.ui.template.register("liba_disk_renew.html",function(param){var node=this;this.querySelector('button[controls="renew"]').addEventListener("click",function(){var r=new cr.APIRequest(cr.model.Disk,"POST","/"+param.disk.id+"/borrow/"),payload={id:cr.user&&cr.user.id};r.onload=function(e){var disk=e.recObj;cr.model.Disk.update(disk,2);cr.ui.showNotification("Disk renewed","dismiss");history.go()};r.onerror=function(e){node.classList.remove("loading");cr.errorHandler(e)};node.classList.add("loading");r.sendJSON(payload)})});cr.ui.template.register("disk_review_entry.html")}function liba_setup(func){return function(){if(cr.model.SiteSettings.getField("liba_state").value!=="Open"){var error_template=cr.ui.template.render_template("error_page.html",{text:"Sorry, The VCD/DVD Library is temporarily closed."});cr.ui.replaceContent(error_template,function(){cr.ui.changeSelection(name);cr.view.name=name});return}if(cr.view.name!==name){var liba_template=cr.ui.template.render_template("liba_template.html");cr.ui.replaceContent(liba_template,(function(a){cr.ui.changeSelection(name);cr.view.name=name;func.apply(this,a)}).bind(liba_template,arguments))}else{liba_switch(document.querySelector(".library-wrapper"),func,arguments)}}}function liba_switch(root,func,query){var panel=root.querySelector(".right-panel");panel.classList.add("loading");setTimeout(function(){panel.setAttribute("hidden",true);while(panel.firstChild){panel.removeChild(panel.firstChild)}func.apply(root,query)},210)}function liba_disp_list(node,pager,uri){var page=0,content=node.querySelector(".list-item-wrapper");pager.load(next_page);node.querySelector(".prev-button").addEventListener("click",function(){page--;routerManager.pushState(uri(page),false,true);node.classList.add("loading");pager.prev(prev_page)});node.querySelector(".next-button").addEventListener("click",function(){page++;routerManager.pushState(uri(page),false,true);node.classList.add("loading");pager.next(next_page)});function prev_page(obj_list){switch_page.call(this,obj_list,"prev")}function next_page(obj_list){switch_page.call(this,obj_list,"next")}function switch_page(obj_list,direction){var current_disks=content.querySelectorAll(".list-item"),notfounder=content.querySelectorAll(".library-notfound");for(var i=0;i<current_disks.length;i++){current_disks[i].classList.add(direction=="next"?"at_left":"at_right")}for(var i=0;i<notfounder.length;i++){notfounder[i].classList.add("loading")}if(obj_list.length===0){var nothing_found=cr.ui.template.render_template("liba_list_notfound.html");content.appendChild(nothing_found);node.querySelector(".prev-button").setAttribute("hidden",true);node.querySelector(".next-button").setAttribute("hidden",true);setTimeout(function(){nothing_found.classList.remove("loading")},0);routerManager.markTracker()}else{if(this.has_prev){node.querySelector(".prev-button").removeAttribute("hidden")}else{node.querySelector(".prev-button").setAttribute("hidden",true)}if(this.has_next){node.querySelector(".next-button").removeAttribute("hidden")}else{node.querySelector(".next-button").setAttribute("hidden",true)}for(var i=0;i<obj_list.length;i++){var disk_item=cr.ui.template.render_template("liba_list_item.html",{disk:obj_list[i]});disk_item.classList.add(direction=="next"?"at_right":"at_left");disk_item.classList.add("item-"+i);content.appendChild(disk_item);setTimeout((function(){this.classList.remove(direction=="next"?"at_right":"at_left")}).bind(disk_item),0)}}node.classList.remove("loading");setTimeout(function(){for(var i=0;i<current_disks.length;i++){if(current_disks[i].parentNode===content){content.removeChild(current_disks[i])}}for(var i=0;i<notfounder.length;i++){if(notfounder[i].parentNode===content){content.removeChild(notfounder[i])}}},410)}}function liba_list(param){var mode=param.mode||"",page=param.page||1,skeleton=cr.ui.template.render_template("liba_list.html"),panel=this.querySelector(".right-panel"),pager=new cr.Pager(cr.model.Disk,getAPI(mode,page));panel.appendChild(skeleton);panel.removeAttribute("hidden");panel.classList.remove("loading");switch(mode){case"popular":document.title="Top Popular | Film Society, HKUSTSU";break;case"rank":document.title="Top Ranked | Film Society, HKUSTSU";break;default:document.title="VCD/DVD Library | Film Society, HKUSTSU"}var getURI=function(offset){var param_list=[],cur_page=~~(page)+~~(offset),base="library/";if(cur_page!==1){param_list.push("page="+encodeURIComponent(cur_page))}switch(mode){case"popular":case"rank":param_list.push("mode="+encodeURIComponent(mode))}return base+((param_list.length!==0)?("?"+param_list.join("&")):"")};liba_disp_list(skeleton,pager,getURI);function getAPI(mode,page){var base="/?limit=6&page="+encodeURIComponent(page);switch(mode){case"popular":base+="&ordering=-borrow_cnt,-id";break;case"rank":base+="&ordering=-rank,-id"}return base}}function liba_search(param){var query=param.q||"",page=param.page||1,skeleton=cr.ui.template.render_template("liba_list.html"),panel=this.querySelector(".right-panel"),search_box=this.querySelector('.left-panel .library-search input[name="search_term"]'),pager=new cr.Pager(cr.model.Disk,getAPI(query,page));search_box.value=query;panel.appendChild(skeleton);panel.removeAttribute("hidden");panel.classList.remove("loading");document.title="Searching For "+query+" | Film Society, HKUSTSU";var getURI=function(offset){var param_list=[],cur_page=~~(page)+~~(offset),base="library/search/";param_list.push("q="+encodeURIComponent(query));if(cur_page!==1){param_list.push("page="+encodeURIComponent(cur_page))}return base+((param_list.length!==0)?("?"+param_list.join("&")):"")};liba_disp_list(skeleton,pager,getURI);function getAPI(query,page){var base="/search/?limit=6&page="+encodeURIComponent(page);base+="&query="+encodeURIComponent(query);return base}}function liba_suggest(root){var search_box=root.querySelector('.left-panel input[name="search_term"]'),suggest_box=root.querySelector(".left-panel .search-suggestion"),suggest_idx=0,suggest_length=0,suggest_list=[],state=0;search_box.addEventListener("keypress",function(e){if(e.keyCode>=46||e.keyCode<=9){give_suggestion(this.value,suggest_box)}});search_box.addEventListener("keyup",function(e){if(e.keyCode>=46||e.keyCode<=9){give_suggestion(this.value,suggest_box)}});search_box.addEventListener("focus",function(){prepare_suggestion(search_box);give_suggestion(this.value,suggest_box)});search_box.addEventListener("blur",function(){remove_suggestion(suggest_box);cleanup_suggestion(search_box)});function handle_keyevent(e){switch(e.keyCode){case 13:if(suggest_idx!==0){var id=suggest_list[suggest_idx-1];this.value="";this.blur();routerManager.pushState("library/"+id+"/",false,true);liba_switch(document.querySelector(".library-wrapper"),liba_disk,[id])}else{this.blur();routerManager.pushState("library/search/?q="+encodeURIComponent(this.value),false,true);liba_switch(document.querySelector(".library-wrapper"),liba_search,[{q:this.value}])}break;case 27:this.blur();break;case 38:e.preventDefault();suggest_idx=(suggest_idx+suggest_length)%(suggest_length+1);highlight(suggest_idx);break;case 40:e.preventDefault();suggest_idx=(suggest_idx+suggest_length+2)%(suggest_length+1);highlight(suggest_idx);break}}function prepare_suggestion(search_box){search_box.addEventListener("keydown",handle_keyevent,true);state=1}function cleanup_suggestion(search_box){state=0;search_box.removeEventListener("keydown",handle_keyevent)}function highlight(idx){var current=suggest_box.querySelector(".selected"),target=suggest_box.querySelector(".suggest-item:nth-of-type("+idx+")");if(current===target){return}current&&current.classList.remove("selected");target&&target.classList.add("selected")}function give_suggestion(value,box){if(value===""||/[:()]/.test(value)){return remove_suggestion(box)}var r=new cr.APIRequest(cr.model.Disk,"GET","/search/?limit=5&engine=defualt&query="+encodeURIComponent(value));r.onload=function(e){if(search_box.value!==value||state===0){return}var list=e.recObj.objects;remove_suggestion(box);suggest_length=list.length;box.removeAttribute("hidden");for(var i=0;i<list.length;i++){cr.model.Disk.update(list[i],1);var item=cr.ui.template.render_template("liba_suggest_item.html",{disk:list[i]});box.appendChild(item);item.addEventListener("mouseover",(function(idx){if(suggest_idx===idx){return}suggest_idx=idx;highlight(idx)}).bind(item,i+1));item.addEventListener("mousedown",(function(id){search_box.value="";search_box.blur();routerManager.pushState("library/"+id+"/",false,true);liba_switch(document.querySelector(".library-wrapper"),liba_disk,[id])}).bind(null,list[i].id));suggest_list.push(list[i].id);setTimeout((function(){this.classList.remove("loading")}).bind(item),i*50)}};r.send()}function remove_suggestion(box){box.setAttribute("hidden",true);while(box.firstChild){box.removeChild(box.firstChild)}suggest_idx=0;suggest_length=0;suggest_list=[]}}function liba_disk(id){var skeleton=cr.ui.template.render_template("liba_disk.html",{user:cr.user}),panel=this.querySelector(".right-panel");panel.appendChild(skeleton);panel.removeAttribute("hidden");panel.classList.remove("loading");cr.model.Disk.get(id,function(disk){var disk_page=cr.ui.template.render_template("liba_disk_detail.html",{disk:disk,cn:cr.model.Disk.CN(disk),user:cr.user}),reviews=skeleton.querySelector(".diskreview-wrapper");skeleton.querySelector(".disk-wrapper").appendChild(disk_page);setTimeout(function(){skeleton.classList.remove("loading")},0);document.title=disk.title_en+" "+disk.title_ch+" | Film Society, HKUTSU";routerManager.markTracker();var r=new cr.APIRequest(cr.model.Disk,"GET","/"+id+"/rate/");r.onload=function(e){var rate=e.recObj,rate_num=skeleton.querySelector(".rate-box .rate-num"),up_button=skeleton.querySelector(".rate-box .rate-up-button"),down_button=skeleton.querySelector(".rate-box .rate-down-button");rate_num.textContent=rate.ups-rate.downs;if(rate.ups>rate.downs){rate_num.classList.add("positive")}else{if(rate.ups<rate.downs){rate_num.classList.add("negative")}}if(rate.rated){up_button.setAttribute("tooltip","You have rated before");down_button.setAttribute("tooltip","You have rated before")}else{up_button.addEventListener("click",function(){submit_rate("up")});down_button.addEventListener("click",function(){submit_rate("down")})}skeleton.querySelector(".rate-box").classList.remove("loading");function submit_rate(up_or_down){var r=new cr.APIRequest(cr.model.Disk,"POST","/"+id+"/rate/");r.onload=function(e){var rate=e.recObj;if(!rate_num){return}rate_num.textContent=rate.ups-rate.downs;if(rate.ups>rate.downs){rate_num.classList.add("positive")}else{if(rate.ups<rate.downs){rate_num.classList.add("negative")}}if(rate.rated){up_button.setAttribute("tooltip","You have rated before");down_button.setAttribute("tooltip","You have rated before")}cr.ui.showNotification("Rate successful","dismiss")};r.onerror=function(){cr.ui.showNotification("Rate failed","dismiss")};r.sendJSON({rate:up_or_down})}};r.send();var review_pager=new cr.Pager(cr.model.DiskReview,"/?disk="+id),review_none=false,review_container=skeleton.querySelector(".diskreview-wrapper"),review_upper=review_container.querySelector(".diskreview-entry-wrapper"),review_entries=review_upper.querySelector(".diskreview-inner-wrapper");review_entries.scrollList=new cr.ui.scrollList(review_entries,review_upper,review_pager,{onfirstload:function(obj_list){var that=this;elem=that.elem;if(obj_list.length===0){that.anchor_element.textContent="Be the first one to comment";review_none=true}var btn=review_container.querySelector('.diskreview-input-box button[controls="submit"]');btn.addEventListener("click",function(){var textarea=review_container.querySelector('.diskreview-input-box textarea[name="review"]');if(!textarea.value){return}var payload={disk:id,content:textarea.value};cr.model.DiskReview.post(payload,function(obj){var div_after=elem.querySelector(".diskreview-title").nextSibling,new_entry=cr.ui.template.render_template("disk_review_entry.html",{review:obj});elem.insertBefore(new_entry,div_after);if(review_none){elem.removeChild(that.anchor_element);review_none=false}setTimeout(function(){new_entry.classList.remove("loading")},0)})})},onload:function(obj,idx){var entry=cr.ui.template.render_template("disk_review_entry.html",{review:obj});this.elem.insertBefore(entry,this.anchor_element);setTimeout((function(){this.classList.remove("loading")}).bind(entry),50*idx)},deleteAnchor:false});review_entries.scrollList.load()})}function liba_rand(){var r=new cr.APIRequest(cr.model.Disk,"GET","/rand/",true),node=this;r.onload=function(e){cr.model.Disk.update(e.recObj,1);liba_disk.call(node,e.recObj.id)};r.onerror=cr.errorHandler;r.send()}return{Initialization:Initialization}});cr.view.library.Initialization();cr.define("cr.view.show",function(){var name="show";function toShow(obj){if(obj.film_1.avail_type==="Onshow"){return obj.film_1}if(obj.film_2.avail_type==="Onshow"){return obj.film_2}if(obj.film_3.avail_type==="Onshow"){return obj.film_3}return null}function Initialization(){routerManager.register(/show\//,false,rfs_setup(rfs_list));cr.ui.template.register("rfs_template.html");cr.ui.template.register("rfs_true_template.html",function(param){var strips=this.querySelectorAll(".rfs-film-strip"),board=this.querySelector(".info-tab");for(var i=0;i<strips.length;i++){var idx=strips[i].getAttribute("refer"),cover=strips[i].querySelector(".rfs-cover"),disk=param.show["film_"+idx];if(disk.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+disk.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}var actor_wrapper=this.querySelector('.info-tab .rfs-film-info[refer="'+idx+'"] .actors-wrapper');actor_wrapper.textContent=disk.actors.join(", ");var tag_wrapper=this.querySelector('.info-tab .rfs-film-info[refer="'+idx+'"] .tags-wrapper');tag_wrapper.textContent=disk.tags.join(", ");strips[i].querySelector(".rfs-cover").addEventListener("click",(function(id,e){routerManager.pushState("library/"+id+"/",false);e.preventDefault();e.stopPropagation();e.stopImmediatePropagation()}).bind(null,disk.id),true);strips[i].querySelector('button[controls="vote"]').addEventListener("click",rfs_vote.bind(null,param.show.id,idx));strips[i].addEventListener("mouseover",(function(idx){board.classList.add("noscrollbar");var old=this.querySelectorAll("div[selected]");for(var i=0;i<old.length;i++){old[i].removeAttribute("selected")}this.querySelector('.rfs-film-info[refer="'+idx+'"]').setAttribute("selected",true)}).bind(board,idx));strips[i].addEventListener("mouseout",(function(){board.classList.remove("noscrollbar");var old=this.querySelectorAll("div[selected]");for(var i=0;i<old.length;i++){old[i].removeAttribute("selected")}this.querySelector(".rfs-remarks").setAttribute("selected",true)}).bind(board))}})}function rfs_vote(id,idx){var r=new cr.APIRequest(cr.model.RegularFilmShow,"POST","/"+id+"/vote/");r.onload=function(e){cr.ui.showNotification("Vote success","dismiss");history.go()};r.onerror=cr.errorHandler;r.sendJSON({film_id:idx})}function rfs_setup(func){return function(){cr.view.name=name;cr.ui.changeSelection(name);document.title="Regular Film Show | Film Society, HKUSTSU";routerManager.markTracker();if(cr.model.SiteSettings.getField("rfs_state").value!=="Open"){var error_template=cr.ui.template.render_template("error_page.html",{text:"Sorry, Regular Film Show is temporarily closed."});cr.ui.replaceContent(error_template);return}var rfs_template=cr.ui.template.render_template("rfs_template.html");cr.ui.replaceContent(rfs_template,(function(a){func.apply(this,a)}).bind(rfs_template,arguments))}}function rfs_list(){var node=this,skeleton=this.querySelector(".rfs-content-wrapper"),pager=new cr.Pager(cr.model.RegularFilmShow,"/?limit=1");pager.load(disp_rfs);function disp_rfs(obj_list){if(obj_list.length===0){var error_template=cr.ui.template.render_template("error_page.html",{text:"Sorry, No Regular Film Show available."});cr.ui.replaceContent(error_template);return}var template=cr.ui.template.render_template("rfs_true_template.html",{show:obj_list[0],user:cr.user,toshow:toShow(obj_list[0])});console.log(obj_list[0],toShow(obj_list[0]));cr.model.Disk.update(obj_list[0].film_1,1);cr.model.Disk.update(obj_list[0].film_2,1);cr.model.Disk.update(obj_list[0].film_3,1);skeleton.appendChild(template);skeleton.removeAttribute("hidden");setTimeout(function(){node.classList.remove("loading");var bars=skeleton.querySelectorAll(".rfs-film-strip .vote-bar"),sum=obj_list[0].vote_cnt_1+obj_list[0].vote_cnt_2+obj_list[0].vote_cnt_3;for(var i=0;i<bars.length;i++){var vote=obj_list[0]["vote_cnt_"+(i+1)];bars[i].style.top=(100-90*(vote/(sum+0.0001)))+"%"}},0)}}return{Initialization:Initialization}});cr.view.show.Initialization();cr.define("cr.view.ticket",function(){var name="ticket";function Initialization(){routerManager.register(/ticket\//,false,ticket_setup(ticket_list));cr.ui.template.register("ticket_template.html",function(){var overlay=this.querySelector(".popup-overlay");overlay.addEventListener("close",function(){this.classList.add("loading");setTimeout((function(){this.setAttribute("hidden",true)}).bind(this),210)});overlay.addEventListener("click",function(e){e.target===this&&cr.dispatchSimpleEvent(this,"close",true,true)});overlay.addEventListener("keydown",function(e){if(e.keyCode===27){cr.dispatchSimpleEvent(this,"close",true,true)}});overlay.querySelector(".close-button").addEventListener("click",function(){cr.dispatchSimpleEvent(overlay,"close",true,true)})});cr.ui.template.register("ticket_list_item.html",function(param){var cover=this.querySelector(".item-cover");if(param.ticket.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.ticket.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}});cr.ui.template.register("ticket_detail.html",function(param){var cover=this.querySelector(".ticket-brief .ticket-cover");if(param.ticket.cover_url){cover.style.backgroundImage=cssurl(cr.settings.resource_base+"upload/"+param.ticket.cover_url.url)}else{cover.style.backgroundImage=cssurl(cr.settings.resource_base+"css/question.png")}this.querySelector('button[controls="apply"]').addEventListener("click",function(){var popup=document.querySelector(".ticket-wrapper .popup-overlay"),box=popup.querySelector(".popup-box"),content=box.querySelector(".content"),apply_form=cr.ui.template.render_template("ticket_apply.html",{ticket:param.ticket});box.querySelector("h1").textContent="Apply For Ticket";while(content.firstChild){content.removeChild(content.firstChild)}content.appendChild(apply_form);box.classList.remove("loading");popup.removeAttribute("hidden");setTimeout(function(){popup.classList.remove("loading")},0)})});cr.ui.template.register("ticket_apply.html",function(param){var node=this,selects=this.querySelectorAll(".custom-select");for(var i=0;i<selects.length;i++){cr.ui.select.init(selects[i])}this.querySelector('button[controls="apply"]').addEventListener("click",function(e){var payload=Application.collectForm(node),r=new cr.APIRequest(cr.model.PreviewShowTicket,"POST","/"+param.ticket.id+"/application/");cr.ui.swallowDoubleClick(e);payload.number=~~(payload.number);r.onload=function(e){cr.ui.showNotification("Ticket applied","dismiss");cr.dispatchSimpleEvent(node,"close",true,true)};r.onerror=function(e){node.classList.remove("loading");cr.errorHandler(e)};node.classList.add("loading");r.sendJSON(payload)})})}function ticket_setup(func){return function(){if(cr.model.SiteSettings.getField("pst_state").value!=="Open"){var error_template=cr.ui.template.render_template("error_page.html",{text:"Sorry, The Preview Show Ticket is temporarily closed."});cr.ui.replaceContent(error_template,function(){cr.ui.changeSelection(name);cr.view.name=name;document.title="Preview Show Ticket | Film Society, HKUSTSU";routerManager.markTracker()});return}var ticket_template=cr.ui.template.render_template("ticket_template.html");cr.ui.replaceContent(ticket_template,(function(a){cr.ui.changeSelection(name);cr.view.name=name;document.title="Preview Show Ticket | Film Society, HKUSTSU";routerManager.markTracker();func.apply(this,a)}).bind(ticket_template,arguments))}}function ticket_switch(root,id){var panel=root.querySelector(".right-panel"),detail_wrapper=panel.querySelector(".ticket-detail-wrapper");panel.classList.add("loading");cr.model.PreviewShowTicket.get(id,function(ticket){setTimeout(function(){document.title=ticket.title_en+" "+ticket.title_ch+" | Film Society, HKUSTSU";detail_wrapper.setAttribute("hidden",true);while(detail_wrapper.firstChild){detail_wrapper.removeChild(detail_wrapper.firstChild)}var ticket_item=cr.ui.template.render_template("ticket_detail.html",{ticket:ticket,user:cr.user});detail_wrapper.appendChild(ticket_item);detail_wrapper.removeAttribute("hidden");setTimeout(function(){panel.classList.remove("loading")},0)},410)})}function ticket_list(){var node=this,left_panel=node.querySelector(".left-panel"),list_wrapper=left_panel.querySelector(".ticket-list-wrapper"),panel=this.querySelector(".right-panel"),pager=new cr.Pager(cr.model.PreviewShowTicket,"/?limit=10");node.scrollList=new cr.ui.scrollList(list_wrapper,left_panel,pager,{onfirstload:function(obj_list){if(obj_list.length==0){this.anchor_element.textContent="No Ticket at the time"}},onload:function(obj,idx){var entry=cr.ui.template.render_template("ticket_list_item.html",{ticket:obj});entry.addEventListener("click",(function(node,id,e){ticket_switch(node,id);switch_selection(this)}).bind(entry,node,obj.id));this.elem.insertBefore(entry,this.anchor_element);setTimeout((function(){this.classList.remove("loading")}).bind(entry),idx*100+400);if(this.first_load&&idx==0){switch_selection(entry);ticket_switch(node,obj.id)}},deleteAnchor:false});node.scrollList.load();function switch_selection(node){var selected=list_wrapper.querySelectorAll("[selected]");for(var i=0;i<selected.length;i++){selected[i].removeAttribute("selected")}node.setAttribute("selected",true)}}return{Initialization:Initialization}});cr.view.ticket.Initialization();cr.define("cr.view.document",function(){var name="document";function Initialization(){routerManager.register(/document\//,false,doc_setup(doc_list));cr.ui.template.register("doc_template.html");cr.ui.template.register("doc_list_item.html");cr.ui.template.register("doc_detail.html")}function doc_setup(func){return function(){cr.view.name=name;cr.ui.changeSelection(name);document.title="Document | Film Society, HKUSTSU";routerManager.markTracker();var doc_template=cr.ui.template.render_template("doc_template.html");cr.ui.replaceContent(doc_template,(function(a){func.apply(this,a)}).bind(doc_template,arguments))}}function doc_switch(root,id){var panel=root.querySelector(".right-panel"),detail_wrapper=panel.querySelector(".doc-content-wrapper");panel.classList.add("loading");cr.model.Document.get(id,function(doc){setTimeout(function(){document.title=doc.title+" | Film Society, HKUSTSU";detail_wrapper.setAttribute("hidden",true);while(detail_wrapper.firstChild){detail_wrapper.removeChild(detail_wrapper.firstChild)}var doc_item=cr.ui.template.render_template("doc_detail.html",{doc:doc,base_url:cr.settings.resource_base+"upload/"});detail_wrapper.appendChild(doc_item);detail_wrapper.removeAttribute("hidden");setTimeout(function(){panel.classList.remove("loading")},0)},410)})}function doc_list(){var node=this,list_wrapper=this.querySelector(".left-panel .doc-list-wrapper"),anchor_element=list_wrapper.querySelector(".anchor"),pager=new cr.Pager(cr.model.Document,"/");node.scrollList=new cr.ui.scrollList(list_wrapper,list_wrapper,pager,{onload:function(obj,idx){var entry=cr.ui.template.render_template("doc_list_item.html",{doc:obj});entry.addEventListener("click",doc_switch.bind(null,node,obj.id));this.elem.insertBefore(entry,this.anchor_element);setTimeout((function(){this.classList.remove("loading")}).bind(entry),idx*50);if(this.first_load&&idx==0){doc_switch(node,obj.id)}}});node.scrollList.load()}return{Initialization:Initialization}});cr.view.document.Initialization();cr.define("cr.view.sponsor",function(){var name="sponsor",play_duration=15*1000,gaussian=new Ziggurat;function Initialization(){routerManager.register(/sponsor\//,false,sponsor_setup(sponsor_list));cr.ui.template.register("sponsor_template.html");cr.ui.template.register("sponsor_item.html",function(param){var node=this;img=node.querySelector("img");img.onload=function(){node.style.width=this.width+"px"};img.onerror=function(){node.style.display="none"};img.src=param.base_url+param.sponsor.img_url.url})}function sponsor_setup(func){return function(){cr.view.name=name;cr.ui.changeSelection(name);document.title="Sponsor | Film Society, HKUSTSU";routerManager.markTracker();var sponsor_template=cr.ui.template.render_template("sponsor_template.html");cr.ui.replaceContent(sponsor_template,(function(a){func.apply(this,a)}).bind(sponsor_template,arguments))}}function sponsor_list(){var node=this,pager=new cr.Pager(cr.model.Sponsor,"/"),row=0,latency=0;pager.load(disp_sponsor);var item_reload=function(e){var item=e.target;item.classList.remove("moving");if(latency<play_duration){item_setout.call(item,item.offset)}else{item_setout.call(item,latency+item.offset-play_duration*3/4)}};node.addEventListener("webkitAnimationEnd",item_reload);node.addEventListener("MSAnimationEnd",item_reload);node.addEventListener("oAnimationEnd",item_reload);node.addEventListener("animationend",item_reload);function disp_sponsor(obj_list){var arr=shuffle(obj_list);node.classList.remove("loading");for(var i=0;i<arr.length;i++){var item=cr.ui.template.render_template("sponsor_item.html",{sponsor:arr[i],base_url:cr.settings.resource_base+"upload/"});node.appendChild(item);item_setout.call(item,latency);if(row==0){latency+=play_duration/4}}if(this.has_next){this.next(disp_sponsor)}}function item_setout(latency){var offset=generateNumber(latency+1000,Math.min(2000,2*Math.max(latency+1000,0))),t=this;t.style.top=generateNumber(row*23+6,12)+"%";t.style.zIndex=~~(Math.random()*10);t.offset=latency+1000-offset;setTimeout((function(){this.classList.add("moving")}).bind(t),offset);row++;if(row>3){row=0}}function generateNumber(center,range){while(true){var raw=gaussian.nextGaussian();raw*=range/8;raw+=center;if(raw<center-(range>>1)||raw>center+(range>>1)){continue}return raw}}function shuffle(array){var currentIndex=array.length,temporaryValue,randomIndex;while(0!==currentIndex){randomIndex=Math.floor(Math.random()*currentIndex);currentIndex-=1;temporaryValue=array[currentIndex];array[currentIndex]=array[randomIndex];array[randomIndex]=temporaryValue}return array}}return{Initialization:Initialization}});cr.view.sponsor.Initialization();cr.define("cr.ui",function(){function UnitBezier(x1,y1,x2,y2){var t=this;t.cx=3*x1;t.bx=3*(x2-x1)-t.cx;t.ax=1-t.cx-t.bx;t.cy=3*y1;t.by=3*(y2-y1)-t.cy;t.ay=1-t.cy-t.by}UnitBezier.prototype={getX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},getY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},getDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveAtX:function(x,epsilon){assert(x>=0&&x<=1,"x out of range");var t0,t1,t2,i;for(t2=x,i=0;i<8;i++){var x2=this.getX(t2)-x;if(x2<epsilon&&x2>-epsilon){return t2}var d=this.getDerivativeX(t2);if(d<0.000001&&d>-0.000001){break}t2-=x2/d}t0=0;t1=1;t2=x;while(t0<t1){var x2=this.getX(t2);if(x2-x<epsilon&&x2-x>-epsilon){return t2}if(x>x2){t0=t2}else{t1=t2}t2=(t1-t0)/2+t0}return t2},solve:function(x,epsilon){if(x<0){return 0}if(x>1){return 1}return this.getY(this.solveAtX(x,epsilon))}};function Scroller(elem){this.elem=elem;this.lastTick=null;this.lastT=0;this.scrolling=false;this.toX=null;this.toY=null;this.sX=null;this.sY=null;this.dT=null;this.generator=null;this.cbk=null}Scroller.prototype={scrollTo:function(toX,toY,duration,cbk,timing){this.toX=toX;this.toY=toY;this.sX=this.elem.scrollLeft;this.sY=this.elem.scrollTop;this.lastT=0;this.dT=1/duration;this.generator=timing;this.cbk=cbk;if(!this.scrolling){this.scrolling=true;requestAnimationFrame(this.handleScroll.bind(this))}},handleScroll:function(timestamp){if(this.lastT>=1){this.elem.scrollLeft=this.toX;this.elem.scrollTop=this.toY;this.cbk&&this.cbk();this.reset();return}if(!this.scrolling){return}if(this.lastTick==null){this.lastTick=timestamp}var percent=this.generator.solve(this.lastT,0.005);this.elem.scrollLeft=this.sX+(this.toX-this.sX)*percent;this.elem.scrollTop=this.sY+(this.toY-this.sY)*percent;this.lastT+=(timestamp-this.lastTick)*this.dT;this.lastTick=timestamp;cr.dispatchSimpleEvent(this.elem,"scroll",true,true);requestAnimationFrame(this.handleScroll.bind(this))},reset:function(){this.lastTick=null;this.lastT=0;this.scrolling=false;this.toX=null;this.toY=null;this.sX=null;this.sY=null;this.dT=null;this.generator=null;this.cbk=null}};return{UnitBezier:UnitBezier,Scroller:Scroller}});cr.define("cr.view.news",function(){var name="news";var m_names=new Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec");function Initialization(){routerManager.register(/home\//,true,news_setup(news_list));routerManager.register(/news\/(\d+)\//,false,news_setup(news_detail));cr.ui.template.register("news_template.html");cr.ui.template.register("home_template.html");cr.ui.template.register("home_news_item.html",function(param){this.addEventListener("click",(function(id,e){e.preventDefault();routerManager.pushState("news/"+id+"/",false,true);home_switch(document.querySelector(".news-wrapper"),news_detail,[id])}).bind(null,param.news.id))});cr.ui.template.register("news_detail.html",function(){this.querySelector(".link-goback").addEventListener("click",function(){if(history.length>1){history.go(-1)}else{routerManager.pushState("home",false,true);home_switch(document.querySelector(".news-wrapper"),news_list,[{}])}})})}function news_setup(func){return function(){if(cr.view.name!==name){document.title="Home | Film Society, HKUSTSU";var news_template=cr.ui.template.render_template("news_template.html");cr.ui.replaceContent(news_template,(function(a){cr.view.name=name;cr.ui.changeSelection(name);func.apply(this,a)}).bind(news_template,arguments))}else{home_switch(document.querySelector(".news-wrapper"),func,arguments)}}}function home_switch(root,func,query){var container=root.querySelector(".news-content-wrapper");root.classList.add("loading");setTimeout(function(){container.setAttribute("hidden",true);while(container.firstChild){container.removeChild(container.firstChild)}func.apply(root,query)},210)}function news_list(){var node=this,skeleton=this.querySelector(".news-content-wrapper"),pager=new cr.Pager(cr.model.News,"/?limit=15"),cover=new Image(),cover_id=cr.model.SiteSettings.getField("header_image").value;document.title="Home | Film Society, HKUSTSU";routerManager.markTracker();cover.onload=function(e){var homepage=cr.ui.template.render_template("home_template.html",{url:this.src});skeleton.appendChild(homepage);skeleton.removeAttribute("hidden");setTimeout(function(){node.classList.remove("loading")},0);var news_container=homepage.querySelector(".news-list");homepage.scrollList=new cr.ui.scrollList(news_container,homepage,pager,{onfirstload:function(obj_list){if(obj_list.length==0){this.anchor_element.textContent="No News at the time"}},onload:function(obj,idx){var dateObj=new Date(toISODate(obj.create_log.created_at)),date=m_names[dateObj.getMonth()]+" "+pad(dateObj.getDate(),2),time=pad(dateObj.getHours(),2)+":"+pad(dateObj.getMinutes(),2),entry=cr.ui.template.render_template("home_news_item.html",{news:obj,date:date,time:time});this.elem.insertBefore(entry,this.anchor_element);setTimeout((function(){this.classList.remove("loading")}).bind(entry),100*idx)},deleteAnchor:false});var cHeight=skeleton.clientHeight,h=this.height*homepage.querySelector(".home-cover-wrapper").clientWidth/this.width,toY=h-(cHeight>>1);if(toY>0){homepage.addEventListener("scroll",preventer);homepage.addEventListener("mousewheel",preventer);homepage.classList.add("scrolling");var scroll_manager=new cr.ui.Scroller(homepage);setTimeout(scroll_manager.scrollTo.bind(scroll_manager,0,toY,3000,function(){homepage.removeEventListener("scroll",preventer);homepage.removeEventListener("mousewheel",preventer);homepage.classList.remove("scrolling");homepage.scrollList.load()},new cr.ui.UnitBezier(0.5,0,0.6,1)),700)}else{homepage.scrollList.load()}function preventer(e){e.preventDefault();e.stopImmediatePropagation()}};cover.onerror=function(){cr.errorHandler({recObj:{errno:500,error:"Unable to load"}})};cr.model.File.get(cover_id,function(cover_obj){cover.src=cr.settings.resource_base+"upload/"+cover_obj.url})}function news_detail(id){var node=this,skeleton=this.querySelector(".news-content-wrapper");cr.model.News.get(id,function(news){document.title=news.title+" | Film Society, HKUSTSU";routerManager.markTracker();var news_page=cr.ui.template.render_template("news_detail.html",{news:news});cr.ui.bbcode.handleHTML(news_page.querySelector(".news-content"));skeleton.appendChild(news_page);skeleton.removeAttribute("hidden");setTimeout(function(){node.classList.remove("loading")},0)})}return{Initialization:Initialization}});cr.view.news.Initialization();cr.define("cr.ui.rotator",function(){var fwidth=600,fheight=800,fnum=24,velocity=13,isTouch="ontouchstart" in document.documentElement,activeElem=null;function Initialization(){document.addEventListener(isTouch?"touchend":"mouseup",handleUp);document.addEventListener(isTouch?"touchmove":"mousemove",handleMove)}function init(elem){elem.addEventListener(isTouch?"touchstart":"mousedown",handleDown.bind(elem));elem.rotFrame=elem.rotLastFrame=0;elem.rotating=false}function handleDown(e){if(!isTouch&&e.button!=0){return false}this.rotDragging=true;activeElem=this;document.body.classList.add("dragging");if(this.rotCoords==null){this.rotCoords=getMouse(e)}this.offset=0;e.preventDefault();e.stopImmediatePropagation();return false}function handleMove(e){if(!activeElem){return false}var offset=calcOffset(e,activeElem.rotCoords);dragBg(offset);return true}function handleUp(e){if(!activeElem){return false}activeElem.rotLastFrame=activeElem.rotFrame;activeElem.rotCoords=null;document.body.classList.remove("dragging");activeElem=null;return true}function getMouse(e){if(isTouch){e=e.touches[0]}if(e.pageX&&e.pageY){return{x:e.pageX,y:e.pageY}}return{x:e.clientX+(document.documentElement.scrollLeft-document.documentElement.clientLeft),y:e.clientY+(document.documentElement.scrollTop-document.documentElement.clientTop)}}function calcOffset(e,coords){var curMouse=getMouse(e);return{x:curMouse.x-coords.x,y:curMouse.y-coords.y}}function dragBg(offset){var lastFrame=activeElem.rotLastFrame||0,gotoFrame;gotoFrame=lastFrame+Math.round(offset.x/velocity);if(gotoFrame>=fnum||gotoFrame<0){gotoFrame=gotoFrame-(fnum*Math.floor(gotoFrame/fnum))}activeElem.rotFrame=gotoFrame;activeElem.style.backgroundPosition=(100*gotoFrame/(fnum-1))+"% 0%"}return{Initialization:Initialization,init:init}});cr.ui.rotator.Initialization();cr.define("cr.view.about",function(){var name="about",scroll_timeout=10;function Initialization(){routerManager.register(/about\//,false,about_setup(about_list));cr.ui.template.register("aboutus_template.html");cr.ui.template.register("aboutus_list_item.html");cr.ui.template.register("aboutus_detail_wrapper.html",function(param){var cover=this.querySelector(".aboutus-image");cr.ui.rotator.init(cover)});cr.ui.template.register("aboutus_society.html")}function about_setup(func){return function(){var aboutus_template=cr.ui.template.render_template("aboutus_template.html");cr.ui.replaceContent(aboutus_template,(function(a){cr.ui.changeSelection(name);cr.view.name=name;document.title="About Us | Film Society, HKUSTSU";routerManager.markTracker();func.apply(this,a)}).bind(aboutus_template,arguments))}}function about_switch(root,id){var panel=root.querySelector(".left-panel"),detail_wrapper=panel.querySelector(".item-info-wrapper");panel.classList.add("loading");if(id!==0){cr.model.Exco.get(id,function(exco){setTimeout(function(){document.title=exco.name_ch+" "+exco.name_en+" | Film Society, HKUSTSU";detail_wrapper.setAttribute("hidden",true);while(detail_wrapper.firstChild){detail_wrapper.removeChild(detail_wrapper.firstChild)}var exco_info=cr.ui.template.render_template("aboutus_detail_wrapper.html",{exco:exco});detail_wrapper.appendChild(exco_info);detail_wrapper.removeAttribute("hidden");var img=new Image(),cover=exco_info.querySelector(".aboutus-image");img.onload=(function(exco){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+exco.img_url.url+")";panel.classList.remove("loading");cr.ui.bbcode.handleHTML(exco_info.querySelector(".aboutus-descript"))}).bind(null,exco);img.onerror=function(){panel.classList.remove("loading")};img.src=cr.settings.resource_base+"upload/"+exco.img_url.url},60)})}else{setTimeout(function(){document.title="About Us | Film Society, HKUSTSU";detail_wrapper.setAttribute("hidden",true);while(detail_wrapper.firstChild){detail_wrapper.removeChild(detail_wrapper.firstChild)}var soc_info=cr.ui.template.render_template("aboutus_society.html");detail_wrapper.appendChild(soc_info);detail_wrapper.removeAttribute("hidden");setTimeout(function(){panel.classList.remove("loading")},0)},60)}}function about_list(){var node=this,left_panel=this.querySelector(".left-panel"),right_panel=this.querySelector(".right-panel"),list_wrapper=right_panel.querySelector(".aboutus-list-wrapper"),pager=new cr.Pager(cr.model.Exco,"/"),scroller=new cr.ui.Scroller(right_panel);pager.load(load_excos);function load_excos(obj_list){var soc_entry=cr.ui.template.render_template("aboutus_list_item.html",{exco:{position:"Film Society, HKUSTSU",name_ch:cr.settings.session}});list_wrapper.appendChild(soc_entry);soc_entry.addEventListener("click",(function(node){about_switch(node,0);switch_selection(this)}).bind(soc_entry,node));for(var i=0;i<obj_list.length;i++){var entry=cr.ui.template.render_template("aboutus_list_item.html",{exco:obj_list[i]});entry.addEventListener("click",(function(node,id){about_switch(node,id);switch_selection(this)}).bind(entry,node,obj_list[i].id));list_wrapper.appendChild(entry)}ajustItems();var items=list_wrapper.querySelectorAll(".aboutus-list-item");for(var i=0;i<items.length;i++){setTimeout((function(){this.classList.remove("loading")}).bind(items[i]),100*i+50)}right_panel.addEventListener("scroll",handleScroll);left_panel.addEventListener("mouseover",resetScroll);setTimeout((function(){about_switch(node,0);switch_selection(this)}).bind(soc_entry),200)}function ajustItems(){var items=getInView(),perHeight=items[0]?items[0].clientHeight:0,cHeight=right_panel.clientHeight,halfHeight=(cHeight>>1)+perHeight,viewCenter=right_panel.scrollTop-(perHeight>>1);for(var i=0;i<items.length;i++){var entry=items[i],distance=viewCenter-entry.offsetTop,abs_dist=Math.abs(distance),new_transform="translateX("+((entry.getAttribute("selected")?10:20)+(10*abs_dist/halfHeight))+"%) scale(1)";entry.style.webkitTransform=new_transform;entry.style.MozTransform=new_transform;entry.style.msTransform=new_transform;entry.style.OTransform=new_transform;entry.style.transform=new_transform;entry.style.marginBottom=(-0.5+(0.5*distance/halfHeight))+"em"}}function getInView(){var cHeight=right_panel.clientHeight,viewStart=right_panel.scrollTop-(cHeight>>1),viewEnd=viewStart+cHeight,items=list_wrapper.querySelectorAll(".aboutus-list-item"),perHeight=items[0].clientHeight,cumTop=0,start,end;for(start=0;cumTop<viewStart&&start<items.length;start++){cumTop+=perHeight}for(end=start;cumTop<=viewEnd&&end<items.length;end++){cumTop+=perHeight}return Array.prototype.slice.call(items,Math.max(0,start-1),end+1)}function handleScroll(e){ajustItems()}function resetScroll(){var selected=list_wrapper.querySelector("[selected]");var itemHeight=selected.clientHeight,centerOffset=selected.offsetTop+(itemHeight>>1);scroller.scrollTo(0,centerOffset,500,null,new cr.ui.UnitBezier(0.5,0,0.6,1))}function switch_selection(node){var selected=list_wrapper.querySelectorAll("[selected]");for(var i=0;i<selected.length;i++){selected[i].removeAttribute("selected")}node.setAttribute("selected",true);var itemHeight=node.clientHeight,centerOffset=node.offsetTop+(itemHeight>>1);scroller.scrollTo(0,centerOffset,500,null,new cr.ui.UnitBezier(0.5,0,0.6,1));ajustItems()}}return{Initialization:Initialization}});cr.view.about.Initialization();cr.define("cr.view.publication",function(){var name="publication",isIOS=/(ipad|iphone|ipod)/i.exec(navigator.userAgent),idx=0;function Initialization(){routerManager.register(/publication\//,false,pub_setup(pub_list));cr.ui.template.register("pub_template.html",function(){var node=this.querySelector(".left-panel");left_rotator=node.querySelectorAll(".btn-rotate-left"),right_rotator=node.querySelectorAll(".btn-rotate-right");node.face_idx=1;node.rot=0;for(var i=0;i<left_rotator.length;i++){left_rotator[i].addEventListener("click",function(){node.rot+=120;node.face_idx=(node.face_idx+1)%3;var transformText="translateX("+(25*node.face_idx-25)+"%) rotateY("+node.rot+"deg)";node.style.webkitTransform=transformText;node.style.MozTransform=transformText;node.style.msTransform=transformText;node.style.OTransform=transformText;node.style.transform=transformText})}for(var i=0;i<right_rotator.length;i++){right_rotator[i].addEventListener("click",function(){node.rot-=120;node.face_idx=(node.face_idx+2)%3;var transformText="translateX("+(25*node.face_idx-25)+"%) rotateY("+node.rot+"deg)";node.style.webkitTransform=transformText;node.style.MozTransform=transformText;node.style.msTransform=transformText;node.style.OTransform=transformText;node.style.transform=transformText})}});cr.ui.template.register("pub_list_item.html",function(param){var cover=this.querySelector(".publication-cover");cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.publication.cover_url.url+")"});cr.ui.template.register("pub_magazine.html");cr.ui.template.register("pub_micromagazine.html");cr.ui.template.register("pub_podcast.html",function(param){var node=this,player=node.querySelector(".podcast-player"),played=node.querySelector(".podcast-time .podcast-played"),control_wrapper=node.querySelector(".podcast-control-wrapper"),play_cover=control_wrapper.querySelector(".podcast-cover"),play_control=control_wrapper.querySelector(".podcast-play"),first_load=false;play_cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.publication.cover_url.url+")";play_control.addEventListener("click",function(){if(this.classList.contains("loading")){return}if(!first_load&&isIOS){player.load();play_control.classList.add("loading");return}else{if(player.ended){player.currentTime=0;player.play()}else{if(player.paused){player.play()}else{player.pause();control_wrapper.classList.remove("playing")}}}});player.addEventListener("play",function(){control_wrapper.classList.add("playing");if(!first_load&&isIOS){first_load=true;node.querySelector(".podcast-time .podcast-duration").textContent=pad(~~(this.duration/60),2)+":"+pad((~~(this.duration))%60,2)}});player.addEventListener("canplay",function(){player.play();play_control.classList.remove("loading")});player.addEventListener("waiting",function(){play_control.classList.add("loading");control_wrapper.classList.remove("playing")});player.addEventListener("ended",function(){control_wrapper.classList.remove("playing")});player.addEventListener("loadedmetadata",function(e){node.querySelector(".podcast-time .podcast-duration").textContent=pad(~~(this.duration/60),2)+":"+pad((~~(this.duration))%60,2);play_control.classList.add("loading");control_wrapper.classList.remove("playing")});player.addEventListener("timeupdate",function(e){played.textContent=pad(~~(this.currentTime/60),2)+":"+pad((~~(this.currentTime))%60,2)});player.addEventListener("error",function(e){if(player.networkState===HTMLMediaElement.NETWORK_NO_SOURCE){player.load()}});player.src=param.base_url+param.publication.doc_url.url;if(isIOS){play_control.classList.remove("loading")}})}function pub_setup(func){return function(){var pub_template=cr.ui.template.render_template("pub_template.html");cr.ui.replaceContent(pub_template,(function(a){cr.ui.changeSelection(name);cr.view.name=name;document.title="Publication | Film Society, HKUSTSU";routerManager.markTracker();func.apply(this,a)}).bind(pub_template,arguments))}}function publication_switch(root,id){var panel=root.querySelector(".right-panel"),detail_wrapper=panel.querySelector(".publication-content-wrapper");panel.classList.add("loading");cr.model.Publication.get(id,function(publication){setTimeout(function(){document.title=publication.title+" | Film Society, HKUSTSU";detail_wrapper.setAttribute("hidden",true);while(detail_wrapper.firstChild){detail_wrapper.removeChild(detail_wrapper.firstChild)}var pub_item;switch(publication.pub_type){case"Magazine":pub_item=cr.ui.template.render_template("pub_magazine.html",{publication:publication,base_url:cr.settings.resource_base+"upload/"});break;case"MicroMagazine":pub_item=cr.ui.template.render_template("pub_micromagazine.html",{publication:publication});break;case"Podcast":pub_item=cr.ui.template.render_template("pub_podcast.html",{publication:publication,base_url:cr.settings.resource_base+"upload/"});break}detail_wrapper.appendChild(pub_item);if(publication.pub_type==="Magazine"){pub_item.querySelector(".publication-content").id="embedded_pub_"+idx;var scribd_doc=scribd.Document.getDocFromUrl(cr.settings.resource_base+"upload/"+publication.doc_url.url,cr.settings.scribd_id);scribd_doc.addParam("jsapi_version",2);scribd_doc.addParam("title",publication.title);scribd_doc.addParam("public",true);scribd_doc.addParam("mode","list");scribd_doc.write("embedded_pub_"+idx);idx++}detail_wrapper.removeAttribute("hidden");setTimeout(function(){panel.classList.remove("loading")},0)},410)})}function pub_list(param){var node=this,left_panel=node.querySelector(".left-panel");list_magazine_wrapper=left_panel.querySelector(".publication-magazine-list-wrapper"),list_micromagazine_wrapper=left_panel.querySelector(".publication-micromagazine-list-wrapper"),list_podcast_wrapper=left_panel.querySelector(".publication-podcast-list-wrapper"),panel=node.querySelector(".right-panel");function onload_f(item,idx){var entry=cr.ui.template.render_template("pub_list_item.html",{publication:item}),that=this;entry.addEventListener("click",(function(id){var activeElements=left_panel.querySelectorAll(".publication-list-item[selected]");for(var i=0;i<activeElements.length;i++){activeElements[i].removeAttribute("selected")}entry.setAttribute("selected",true);publication_switch(node,id)}).bind(entry,item.id));that.elem.insertBefore(entry,that.anchor_element);setTimeout((function(){this.classList.remove("loading")}).bind(entry),50*idx+1)}list_magazine_wrapper.scrollList=new cr.ui.scrollList(list_magazine_wrapper,list_magazine_wrapper,new cr.Pager(cr.model.Publication,"/?pub_type=Magazine"),{onfirstload:function(obj_list){if(obj_list.length===0){this.anchor_element.textContent="No items at the time"}},onload:function(item,idx){var entry=cr.ui.template.render_template("pub_list_item.html",{publication:item}),that=this;entry.addEventListener("click",(function(id){var activeElements=left_panel.querySelectorAll(".publication-list-item[selected]");for(var i=0;i<activeElements.length;i++){activeElements[i].removeAttribute("selected")}entry.setAttribute("selected",true);publication_switch(node,id)}).bind(entry,item.id));that.elem.insertBefore(entry,that.anchor_element);setTimeout((function(){this.classList.remove("loading")}).bind(entry),50*idx+1);if(idx===0&&that.first_load){entry.setAttribute("selected",true);publication_switch(node,item.id)}},deleteAnchor:false});list_magazine_wrapper.scrollList.load();list_micromagazine_wrapper.scrollList=new cr.ui.scrollList(list_micromagazine_wrapper,list_micromagazine_wrapper,new cr.Pager(cr.model.Publication,"/?pub_type=MicroMagazine"),{onfirstload:function(obj_list){if(obj_list.length===0){this.anchor_element.textContent="No items at the time"}},onload:onload_f,deleteAnchor:false});list_micromagazine_wrapper.scrollList.load();list_podcast_wrapper.scrollList=new cr.ui.scrollList(list_podcast_wrapper,list_podcast_wrapper,new cr.Pager(cr.model.Publication,"/?pub_type=Podcast"),{onfirstload:function(obj_list){if(obj_list.length===0){this.anchor_element.textContent="No items at the time"}},onload:onload_f,deleteAnchor:false});list_podcast_wrapper.scrollList.load()}function pub_init_list(elem,pager,item_cbk){elem.anchor_element=elem.querySelector(".anchor");elem.ajax_loading=true;elem.first_load=true;elem.item_cbk=item_cbk;elem.addEventListener("scroll",handleScroll);pager.load(load_items);function load_items(obj_list){for(var i=0;i<obj_list.length;i++){elem.item_cbk&&elem.item_cbk(obj_list[i],i)}if(obj_list.length===0&&elem.first_load){elem.anchor_element.textContent="No items at the time";elem.removeEventListener("scroll",handleScroll)}if((!elem.first_load||obj_list.length>0)&&!this.has_next){elem.removeChild(elem.anchor_element);elem.removeEventListener("scroll",handleScroll)}elem.first_load=false;elem.ajax_loading=false}function handleScroll(e){if(this.ajax_loading){return}e.preventDefault();e.stopImmediatePropagation();var scrollTop=this.scrollTop,windowHeight=this.clientHeight,scrollHeight=this.scrollHeight;if(scrollTop+windowHeight+10>scrollHeight){this.ajax_loading=true;pager.next(load_items)}}}return{Initialization:Initialization}});cr.view.publication.Initialization();
