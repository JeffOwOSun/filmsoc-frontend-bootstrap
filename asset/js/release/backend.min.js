/**
 * Script File of Film Society, HKUSTSU
 * Author: John Tan <johnmave126@gmail.com>
 * All Rights Reserved
 */

var tz_info="+08:00";function assert(condition,opt_message){if(!condition){var msg="Assertion failed";if(opt_message){msg=msg+": "+opt_message}throw new Error(msg)}}var global=this;function $(id){return document.getElementById(id)}function pad(n,width,z){z=z||"0";n=n+"";return n.length>=width?n:new Array(width-n.length+1).join(z)+n}function cssurl(s){var s2=s.replace(/(\(|\)|\,|\s|\'|\"|\\)/g,"\\$1");if(/\\\\$/.test(s2)){s2+=" "}return'url("'+s2+'")'}function parseLocationParams(location){var params={};var query=unescape(location.search.substring(1));var vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");params[pair[0]]=pair[1]}return params}function findAncestorByClass(el,className){return findAncestor(el,function(el){if(el.classList){return el.classList.contains(className)}return null})}function findAncestor(node,predicate){var last=false;while(node!=null&&!(last=predicate(node))){node=node.parentNode}return last?node:null}function swapDomNodes(a,b){var afterA=a.nextSibling;if(afterA==b){swapDomNodes(b,a);return}var aParent=a.parentNode;b.parentNode.replaceChild(a,b);aParent.insertBefore(b,afterA)}function disableTextSelectAndDrag(opt_allowSelectStart,opt_allowDragStart){document.onselectstart=function(e){if(!(opt_allowSelectStart&&opt_allowSelectStart.call(this,e))){e.preventDefault()}};document.ondragstart=function(e){if(!(opt_allowDragStart&&opt_allowDragStart.call(this,e))){e.preventDefault()}}}function preventDefaultOnPoundLinkClicks(){document.addEventListener("click",function(e){var anchor=findAncestor(e.target,function(el){return el.tagName=="A"});if(anchor&&anchor.getAttribute("href")=="#"){e.preventDefault()}})}function getRequiredElement(id){var element=$(id);assert(element,"Missing required element: "+id);return element}(function(){if(!Element.prototype.matches){if(Element.prototype.webkitMatchesSelector){Element.prototype.matches=Element.prototype.webkitMatchesSelector}else{if(Element.prototype.mozMatchesSelector){Element.prototype.matches=Element.prototype.mozMatchesSelector}else{if(Element.prototype.oMatchesSelector){Element.prototype.matches=Element.prototype.oMatchesSelector}else{if(Element.prototype.msMatchesSelector){Element.prototype.matches=Element.prototype.msMatchesSelector}}}}}assert(Element.prototype.matches,"Unsupported Browser")})();function createElementWithClassName(type,className){var elm=document.createElement(type);elm.className=className;return elm}function extend(child,parent){var F=function(){};F.prototype=parent.prototype;child.prototype=new F();child.prototype.constructor=child;child.prototype.extend=function(obj){assert(this.hasOwnProperty("extend"),"Only prototype callable");for(var prop in obj){if(obj.hasOwnProperty(prop)){this[prop]=obj[prop]}}};child.uber=parent.prototype}function superCall(instance,func){assert(instance.uber,"Not a subclass of any class");assert(instance.uber[func] instanceof Function,"super class has no functin specified");return instance.uber[func].bind(instance)}function toISODate(dateString){return dateString.replace(" ","T")+".000"+tz_info}function stopEvent(e){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation()}function deepCopy(src){if(src==null||typeof(src)!=="object"){return src}if(typeof src.clone=="function"){return src.clone(true)}if(src instanceof Date){return new Date(src.getTime())}if(src instanceof RegExp){return new RegExp(src)}if(src.nodeType&&typeof src.cloneNode=="function"){return src.cloneNode(true)}if(src instanceof Array){return src.slice(0)}var proto=(Object.getPrototypeOf?Object.getPrototypeOf(src):src.__proto__);if(!proto){proto=src.constructor.prototype}var ret=Object.create(proto);for(var key in src){ret[key]=deepCopy(src[key])}return ret}(function(){if(!Function.prototype.bind){Function.prototype.bind=function(oThis){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,fNOP=function(){},fBound=function(){return fToBind.apply(this instanceof fNOP&&oThis?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))};fNOP.prototype=this.prototype;fBound.prototype=new fNOP();return fBound}}})();String.prototype.splice=function(idx,rem,s){return(this.slice(0,idx)+s+this.slice(idx+Math.abs(rem)))};var EventTracker=(function(){function EventTracker(){this.listeners_=[]}EventTracker.Entry;EventTracker.prototype={add:function(node,eventType,listener,capture){var h={node:node,eventType:eventType,listener:listener,capture:capture};this.listeners_.push(h);node.addEventListener(eventType,listener,capture)},remove:function(node,eventType){this.listeners_=this.listeners_.filter(function(h){if(h.node==node&&(!eventType||(h.eventType==eventType))){EventTracker.removeEventListener_(h);return false}return true})},removeAll:function(){this.listeners_.forEach(EventTracker.removeEventListener_);this.listeners_=[]}};EventTracker.removeEventListener_=function(h){h.node.removeEventListener(h.eventType,h.listener,h.capture)};return EventTracker})();var global=this;this.cr=(function(){function exportPath(name,opt_object,opt_objectToExportTo){var parts=name.split(".");var cur=opt_objectToExportTo||global;for(var part;parts.length&&(part=parts.shift());){if(!parts.length&&opt_object!==undefined){cur[part]=opt_object}else{if(part in cur){cur=cur[part]}else{cur=cur[part]={}}}}return cur}function dispatchPropertyChange(target,propertyName,newValue,oldValue){var e=new cr.Event(propertyName+"Change");e.propertyName=propertyName;e.newValue=newValue;e.oldValue=oldValue;target.dispatchEvent(e)}function getAttributeName(jsName){return jsName.replace(/([A-Z])/g,"-$1").toLowerCase()}var PropertyKind={JS:"js",ATTR:"attr",BOOL_ATTR:"boolAttr"};function getGetter(name,kind){switch(kind){case PropertyKind.JS:var privateName=name+"_";return function(){return this[privateName]};case PropertyKind.ATTR:var attributeName=getAttributeName(name);return function(){return this.getAttribute(attributeName)};case PropertyKind.BOOL_ATTR:var attributeName=getAttributeName(name);return function(){return this.hasAttribute(attributeName)}}}function getSetter(name,kind,opt_setHook){switch(kind){case PropertyKind.JS:var privateName=name+"_";return function(value){var oldValue=this[name];if(value!==oldValue){this[privateName]=value;if(opt_setHook){opt_setHook.call(this,value,oldValue)}dispatchPropertyChange(this,name,value,oldValue)}};case PropertyKind.ATTR:var attributeName=getAttributeName(name);return function(value){var oldValue=this[name];if(value!==oldValue){if(value==undefined){this.removeAttribute(attributeName)}else{this.setAttribute(attributeName,value)}if(opt_setHook){opt_setHook.call(this,value,oldValue)}dispatchPropertyChange(this,name,value,oldValue)}};case PropertyKind.BOOL_ATTR:var attributeName=getAttributeName(name);return function(value){var oldValue=this[name];if(value!==oldValue){if(value){this.setAttribute(attributeName,name)}else{this.removeAttribute(attributeName)}if(opt_setHook){opt_setHook.call(this,value,oldValue)}dispatchPropertyChange(this,name,value,oldValue)}}}}function defineProperty(obj,name,opt_kind,opt_setHook){if(typeof obj=="function"){obj=obj.prototype}var kind=opt_kind||PropertyKind.JS;if(!obj.__lookupGetter__(name)){obj.__defineGetter__(name,getGetter(name,kind))}if(!obj.__lookupSetter__(name)){obj.__defineSetter__(name,getSetter(name,kind,opt_setHook))}}var uidCounter=1;function createUid(){return uidCounter++}function getUid(item){if(item.hasOwnProperty("uid")){return item.uid}return item.uid=createUid()}function dispatchSimpleEvent(target,type,opt_bubbles,opt_cancelable){var e=new cr.Event(type,opt_bubbles,opt_cancelable);return target.dispatchEvent(e)}function define(name,fun){var obj=exportPath(name);var exports=fun();for(var propertyName in exports){var propertyDescriptor=Object.getOwnPropertyDescriptor(exports,propertyName);if(propertyDescriptor){Object.defineProperty(obj,propertyName,propertyDescriptor)}}}function addSingletonGetter(ctor){ctor.getInstance=function(){return ctor.instance_||(ctor.instance_=new ctor())}}function Event(type,opt_bubbles,opt_preventable){var e=cr.doc.createEvent("Event");e.initEvent(type,!!opt_bubbles,!!opt_preventable);e.__proto__=global.Event.prototype;return e}function initialize(){if(!global.document){var originalCr=cr;Object.defineProperty(global,"cr",{get:function(){Object.defineProperty(global,"cr",{value:originalCr});originalCr.initialize();return originalCr},configurable:true});return}Event.prototype={__proto__:global.Event.prototype};cr.doc=document}return{addSingletonGetter:addSingletonGetter,createUid:createUid,define:define,defineProperty:defineProperty,dispatchPropertyChange:dispatchPropertyChange,dispatchSimpleEvent:dispatchSimpleEvent,Event:Event,getUid:getUid,initialize:initialize,PropertyKind:PropertyKind}})();cr.initialize();cr.define("cr",function(){function EventTarget(){}EventTarget.prototype={addEventListener:function(type,handler){if(!this.listeners_){this.listeners_=Object.create(null)}if(!(type in this.listeners_)){this.listeners_[type]=[handler]}else{var handlers=this.listeners_[type];if(handlers.indexOf(handler)<0){handlers.push(handler)}}},removeEventListener:function(type,handler){if(!this.listeners_){return}if(type in this.listeners_){var handlers=this.listeners_[type];var index=handlers.indexOf(handler);if(index>=0){if(handlers.length==1){delete this.listeners_[type]}else{handlers.splice(index,1)}}}},dispatchEvent:function(event){if(this["on"+event.type]){return this["on"+event.type].call(this,event)}if(!this.listeners_){return true}var self=this;event.__defineGetter__("target",function(){return self});event.preventDefault=function(){this.returnValue=false};var type=event.type;var prevented=0;if(type in this.listeners_){var handlers=this.listeners_[type].concat();for(var i=0,handler;handler=handlers[i];i++){if(handler.handleEvent){prevented|=handler.handleEvent.call(handler,event)===false}else{prevented|=handler.call(this,event)===false}}}return !prevented&&event.returnValue}};return{EventTarget:EventTarget}});cr.define("cr.settings",function(){return{resource_base:"http://ihome.ust.hk/~su_film/asset/",api_base:"http://dml085.resnet.ust.hk:49000/film/api/",login_url:"http://dml085.resnet.ust.hk:49000/film/member/login/",logout_url:"http://dml085.resnet.ust.hk:49000/film/member/logout/",url_base:"/~su_film/",scribd_id:"pub-51573345608846754358"}});cr.define("cr.ui.template",function(){var templates={},BBHandler=[{pattern:/\[b\](.+?)\[\/b\]/ig,repl:"<b>$1</b>"},{pattern:/\[i\](.+?)\[\/i\]/ig,repl:"<em>$1</em>"},{pattern:/\[u\](.+?)\[\/u\]/ig,repl:"<u>$1</u>"},{pattern:/\[big\](.+?)\[\/big\]/ig,repl:"<big>$1</big>"},{pattern:/\[small\](.+?)\[\/small\]/ig,repl:"<small>$1</small>"},{pattern:/\[color=([a-zA-Z]*|\#?[0-9a-fA-F]{6})\](.+?)\[\/color\]/ig,repl:'<span style="color:$1">$2</span>'},{pattern:/\[link\=\s*((?:(?:ftp|https?):\/\/)?(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+[A-Z]{2,6}\.?|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d+)?(?:\/?|[\/?]\S+?))\s*\](.+?)\[\/link\]/ig,repl:'<a href="$1" rel="nofollow" target="_blank">$2</a>'},{pattern:/\[img\=\s*((?:(?:ftp|https?):\/\/)?(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+[A-Z]{2,6}\.?|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d+)?(?:\/?|[\/?]\S+?))\s*\](.*?)\[\/img\]/ig,repl:'<img src="$1" alt="$2" title="$2">'}];function escapeWrap(value){return"<p>"+value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\n/g,"</p><p>")+"</p>"}function escapePreWrap(value){return value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace("\n","<br>")}function escapePre(value){return value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function escapeAttr(value){return value.replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function escapeHTML(value){return value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace("\n"," ")}function escapeBBCode(value){value=escapeWrap(value);for(var i=0;i<BBHandler.length;i++){var dup_value;do{dup_value=value;value=value.replace(BBHandler[i].pattern,BBHandler[i].repl)}while(dup_value!=value)}return value}function render_template(url,param){var template=templates[url],wrapper=document.createElement("div"),item,text,func_head,func_bottom;if(template===undefined){throw new ReferenceError("Undefined template.")}param=param||{};text=template.content||"";var argn=[],args=[];for(var prop in param){if(param.hasOwnProperty(prop)&&/^[_a-zA-Z][_a-zA-Z0-9]*$/.test(prop)){argn.push(prop);args.push("param."+prop)}}func_head="(function("+argn.join(",")+"){ return eval('";func_bottom="');})("+args.join(",")+")";var html=text.replace(/{{(.*?)}}/g,function(m,value){var arg_list,escaper=escapeHTML;value=value.trim();arg_list=value.split("|");if(arg_list[1]){switch(arg_list[1].trim()){case"safe":escaper=function(value){return value};break;case"attr":escaper=escapeAttr;break;case"bbcode":escaper=escapeBBCode;break;case"wrap":escaper=escapeWrap;break;case"pre":escaper=escapePre;break;case"prewrap":escaper=escapePreWrap;break;default:break}}var result=eval(func_head+arg_list[0].trim().replace(/'/g,"\\'")+func_bottom);if(result!=undefined){result=""+result}else{result=""}return escaper(result)});wrapper.innerHTML=html;item=wrapper.firstChild||document.createElement("div");if(template.callback){template.callback.call(item,param)}return item}function globalInitialization(){var pending=[],complete_cnt=0;for(var url in templates){var xhr=new XMLHttpRequest();xhr.open("GET",cr.settings.resource_base+"templates/"+url,true);xhr.onload=(function(url){templates[url].content=this.responseText.trim();complete_cnt++;if(complete_cnt==pending.length){cr.dispatchSimpleEvent(window,"moduleload",false,false)}}).bind(xhr,url);xhr.onerror=function(e){e.recObj={errno:xhr.status,error:""};cr.errorHandler(e)};pending.push(xhr)}for(var i=0;i<pending.length;i++){pending[i].send(null)}if(pending.length===0){cr.dispatchSimpleEvent(window,"moduleload",false,false)}}function register(url,callback){templates[url]={content:null,callback:callback}}function registerBBCode(pattern,repl){assert(pattern instanceof RegExp,"pattern must be RegExp");BBHandler.push({pattern:pattern,repl:repl})}return{globalInitialization:globalInitialization,render_template:render_template,register:register,registerBBCode:registerBBCode,escapeAttr:escapeAttr,escapeBBCode:escapeBBCode}});document.addEventListener("DOMContentLoaded",cr.ui.template.globalInitialization);cr.define("cr",function(){var dirty_listening=[];function BaseModel(name){Object.defineProperty(this,"name",{value:name});this._cache={};this.fields=[]}function APIRequest(model,method,api,force_new){var base_url=cr.settings.api_base+model.name+api;this.xhr=new XMLHttpRequest();if(method==="GET"&&force_new){this.xhr.open(method,base_url+((/\?/).test(base_url)?"&":"?")+(new Date()).getTime(),true)}else{this.xhr.open(method,base_url,true)}this.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");this.xhr.withCredentials=true;this.xhr.onprogress=(function(e){if(this.onloadprogress){this.onloadprogress(e)}}).bind(this);this.xhr.upload.onprogress=(function(e){if(this.onuploadprogress){this.onuploadprogress(e)}}).bind(this);this.xhr.onreadystatechange=(function(){if(this.xhr.readyState===4){if(this.xhr.status===200){try{var obj=JSON.parse(this.xhr.responseText);this.success=obj.errno===0;this.data=obj;e=new cr.Event((obj.errno===0)?"load":"error",false,true);e.recObj=obj}catch(exception){this.success=false;this.data={errno:2,error:"Error receiving data"};e=new cr.Event("error",false,true);e.recObj={errno:2,error:"Error receiving data"}}}else{this.success=false;this.data={errno:this.xhr.status,error:this.xhr.statusText};e=new cr.Event("error",false,true);e.recObj={errno:this.xhr.status,error:this.xhr.statusText}}this.dispatchEvent(e)}}).bind(this)}extend(APIRequest,cr.EventTarget);APIRequest.prototype.extend({onload:null,onerror:null,onuploadprogress:null,onloadprogress:null,send:function(){this.xhr.send()},sendRaw:function(data){this.xhr.send(data)},sendForm:function(data){this.xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");this.xhr.send(data)},sendJSON:function(obj){this.xhr.setRequestHeader("Content-Type","application/json");this.xhr.send(JSON.stringify(obj))}});BaseModel.prototype={update:function(data,level){if(!this._cache[data.id]){this._cache[data.id]={data:{}}}for(var key in data){if(this.fields.indexOf(key)!==-1){this._cache[data.id].data[key]=data[key]}}this._cache[data.id].dirty=level},get:function(id,callback){if(this._cache[id]&&this._cache[id].dirty>0){if(callback){callback(deepCopy(this._cache[id].data))}}else{var r=new APIRequest(this,"GET","/"+id+"/",this._cache[id]);r.onload=(function(e){this.update(e.recObj,1);if(callback){callback(deepCopy(this._cache[id].data))}}).bind(this);r.onerror=function(e){cr.errorHandler(e)};r.send()}},put:function(id,data,update,callback){var r=new APIRequest(this,"PUT","/"+id+"/");r.onload=(function(e){if(update){this.update(e.recObj,2)}if(callback){callback(deepCopy(this._cache[id].data))}}).bind(this);r.onerror=function(e){cr.errorHandler(e)};r.sendJSON(data)},post:function(data,callback){var r=new APIRequest(this,"POST","/");r.onload=(function(e){this.update(e.recObj,2);if(callback){callback(deepCopy(this._cache[e.recObj.id].data))}}).bind(this);r.onerror=function(e){cr.errorHandler(e)};r.sendJSON(data)},remove:function(id,callback){var r=new APIRequest(this,"DELETE","/"+id+"/");r.onload=(function(e){if(this._cache[e.recObj.id]){delete this._cache[e.recObj.id]}if(callback){callback(e.recObj)}}).bind(this);r.onerror=function(e){cr.errorHandler(e)};r.send()},setup:function(refresh){if(refresh){addDirty(this)}}};function addDirty(model){dirty_listening.push(model)}function ModelInit(){var delay=6*60*1000;var refresh_dirty=function(){var r=new APIRequest({name:"dirty"},"GET","/",true);r.onerror=function(e){if(e.recObj.errno!==403){setTimeout(refresh_dirty,delay)}};r.onload=function(e){for(var i=0;i<dirty_listening.length;i++){var model=dirty_listening[i],list=e.recObj[model.name];for(var j=0;list&&j<list.length;j++){model._cache[list[i]]&&(model._cache[list[i]].dirty--)}}setTimeout(refresh_dirty,delay)};r.send()};setTimeout(refresh_dirty,delay)}return{BaseModel:BaseModel,APIRequest:APIRequest,ModelInit:ModelInit}});cr.ModelInit();cr.define("cr",function(){function Pager(model,query){Object.defineProperty(this,"model",{value:model});Object.defineProperty(this,"has_prev",{get:function(){return this._cache[this.pos].meta.previous.length>0}});Object.defineProperty(this,"has_next",{get:function(){return this._cache[this.pos].meta.next.length>0}});Object.defineProperty(this,"page",{get:function(){return this._cache[this.pos].meta.page}});Object.defineProperty(this,"total",{get:function(){return this._cache[this.pos].meta.total}});Object.defineProperty(this,"obj_list",{get:function(){return this._cache[this.pos].objects}});this._cache={};this.pos=0;(loadPage.bind(this))(query,0)}function readPage(entry,callback){var objs=[],loaded=0;for(var i=0;i<entry.objects.length;i++){this.model.get(entry.objects[i],(function(p,instance){objs[p]=instance;loaded++;if(loaded===entry.objects.length){if(callback){callback.call(this,objs)}}}).bind(this,i))}if(entry.objects.length===0){callback.call(this,objs)}}function loadPage(query,pos,callback){if(this._cache[pos]){if(this._cache[pos].state===1){(readPage.bind(this))(this._cache[pos],callback)}else{this._cache[pos].callback=callback}}else{if(!query){return}this._cache[pos]={state:0,callback:callback,objects:[],meta:{}};var r=new cr.APIRequest(this.model,"GET",query);r.onload=(function(ev){var entry=this._cache[pos],obj=ev.recObj;entry.meta=deepCopy(obj.meta);for(var i=0;i<obj.objects.length;i++){this.model.update(obj.objects[i],1);entry.objects.push(obj.objects[i].id)}entry.state=1;if(entry.callback){entry.callback.call(this,obj.objects)}}).bind(this);r.onerror=cr.errorHandler;r.send()}}Pager.prototype={load:function(callback){(loadPage.bind(this))(null,this.pos,function(){if(callback){callback.apply(this,arguments)}if(!this._cache[this.pos+1]){(loadPage.bind(this))(this._cache[this.pos].meta.next,this.pos+1,null)}if(!this._cache[this.pos-1]){(loadPage.bind(this))(this._cache[this.pos].meta.previous,this.pos-1,null)}})},next:function(callback){if(this._cache[this.pos].meta.next){this.pos++}(loadPage.bind(this))(null,this.pos,function(){if(callback){callback.apply(this,arguments)}if(!this._cache[this.pos+1]){(loadPage.bind(this))(this._cache[this.pos].meta.next,this.pos+1,null)}})},prev:function(callback){if(this._cache[this.pos].meta.previous){this.pos--}(loadPage.bind(this))(null,this.pos,function(){if(callback){callback.apply(this,arguments)}if(!this._cache[this.pos-1]){(loadPage.bind(this))(this._cache[this.pos].meta.previous,this.pos-1,null)}})}};return{Pager:Pager}});cr.define("routerManager",function(){function getHash(){var hash=location.hash.substr(1),qs=parseLocationParams(window.location);if(qs._escaped_fragment_){return qs._escaped_fragment_}if(hash.charAt(0)=="!"){hash=hash.substr(1)}return hash}function parseQueryParams(query){var params={};var vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");params[pair[0]]=decodeURIComponent(pair[1])}return params}function parseHash(){var hashString=getHash(),query;var q_pos=hashString.indexOf("?");if(q_pos===-1){query={}}else{query=hashString.slice(q_pos+1,hashString.length);query=parseQueryParams(query);hashString=hashString.slice(0,q_pos)}if(hashString.length===0){this.pushState(this.defaultRouter.url,true);return}if(hashString[hashString.length-1]!=="/"){hashString=hashString+"/"}for(var i=0;i<this.routers.length;i++){var router=this.routers[i];if(router.re.test(hashString)){var args;hashString.replace(router.re,function(){var end=Array.prototype.indexOf.call(arguments,0);args=Array.prototype.slice.call(arguments,1,end);for(var i=0;i<args.length;i++){args[i]=decodeComponent(args[i])}});args.push(query);router.callback.apply(router,args);return}}cr.notFoundHandler(hashString)}function globalInitialization(){window.addEventListener("authload",(function(){window.onpopstate=parseHash.bind(this);this.parseHash()}).bind(this));this.routers=[];this.notFoundHandler=function(){};this.defaultRouter={url:"",callback:function(){},re:new RegExp("")}}function encodeComponent(url){return url.replace("!","!0").replace("/","!1")}function decodeComponent(componnet){return componnet.replace("!1","/").replace("!0","!")}function pushState(url,replace,custom){if(url===getHash()){return}var historyFunction=!replace?window.history.pushState:window.history.replaceState,prefix=this.prefix==0?"#":"#!";historyFunction.call(window.history,{},"",prefix+url);if(!custom){this.parseHash()}}function register(pattern,isDefault,callback){assert(pattern instanceof RegExp,"Regular Expression wanted");var router={url:pattern.source.replace("\\/","/"),callback:callback,re:new RegExp("^"+pattern.source+"$")};this.routers.push(router);if(isDefault===true){this.defaultRouter=router}}function markTracker(){if(window.ga){ga("send","pageview",{page:cr.settings.url_base+getHash()})}}return{globalInitialization:globalInitialization,encodeComponent:encodeComponent,decodeComponent:decodeComponent,pushState:pushState,register:register,parseHash:parseHash,markTracker:markTracker,prefix:0}});routerManager.globalInitialization();cr.define("cr.ui",function(){function decorate(source,constr){var elements;if(typeof source=="string"){elements=cr.doc.querySelectorAll(source)}else{elements=[source]}for(var i=0,el;el=elements[i];i++){if(!(el instanceof constr)){constr.decorate(el)}}}function createElementHelper(tagName,opt_bag){var doc;if(opt_bag&&opt_bag.ownerDocument){doc=opt_bag.ownerDocument}else{doc=cr.doc}return doc.createElement(tagName)}function define(tagNameOrFunction){var createFunction,tagName;if(typeof tagNameOrFunction=="function"){createFunction=tagNameOrFunction;tagName=""}else{createFunction=createElementHelper;tagName=tagNameOrFunction}function f(opt_propertyBag){var el=createFunction(tagName,opt_propertyBag);f.decorate(el);for(var propertyName in opt_propertyBag){el[propertyName]=opt_propertyBag[propertyName]}return el}f.decorate=function(el){el.__proto__=f.prototype;el.decorate()};return f}function limitInputWidth(el,parentEl,min,opt_scale){el.style.width="10px";var doc=el.ownerDocument;var win=doc.defaultView;var computedStyle=win.getComputedStyle(el);var parentComputedStyle=win.getComputedStyle(parentEl);var rtl=computedStyle.direction=="rtl";var inputRect=el.getBoundingClientRect();var parentRect=parentEl.getBoundingClientRect();var startPos=rtl?parentRect.right-inputRect.right:inputRect.left-parentRect.left;var inner=parseInt(computedStyle.borderLeftWidth,10)+parseInt(computedStyle.paddingLeft,10)+parseInt(computedStyle.paddingRight,10)+parseInt(computedStyle.borderRightWidth,10);var parentPadding=rtl?parseInt(parentComputedStyle.paddingLeft,10):parseInt(parentComputedStyle.paddingRight,10);var max=parentEl.clientWidth-startPos-inner-parentPadding;if(opt_scale){max*=opt_scale}function limit(){if(el.scrollWidth>max){el.style.width=max+"px"}else{el.style.width=0;var sw=el.scrollWidth;if(sw<min){el.style.width=min+"px"}else{el.style.width=sw+"px"}}}el.addEventListener("input",limit);limit()}function toCssPx(pixels){if(!window.isFinite(pixels)){console.error("Pixel value is not a number: "+pixels)}return Math.round(pixels)+"px"}function swallowDoubleClick(e){var doc=e.target.ownerDocument;var counter=Math.min(1,e.detail);function swallow(e){e.stopPropagation();e.preventDefault()}function onclick(e){if(e.detail>counter){counter=e.detail;swallow(e)}else{doc.removeEventListener("dblclick",swallow,true);doc.removeEventListener("click",onclick,true)}}setTimeout(function(){doc.addEventListener("click",onclick,true);doc.addEventListener("dblclick",swallow,true)},0)}return{decorate:decorate,define:define,limitInputWidth:limitInputWidth,toCssPx:toCssPx,swallowDoubleClick:swallowDoubleClick}});(function(){if("ontouchstart" in document.documentElement){var listener=function(e){var old=document.body.querySelectorAll(".hover");for(var i=0;i<old.length;i++){old[i].classList.remove("hover")}findAncestor(e.target,function(node){if(node.classList){node.classList.add("hover")}return !node.classList})};document.addEventListener("mouseover",listener,true);document.addEventListener("touchstart",listener,true);try{var ignore=":hover",orig=/:hover/g,replace=".hover";for(var i=0;i<document.styleSheets.length;i++){var sheet=document.styleSheets[i];for(var j=0;sheet.cssRules&&j<sheet.cssRules.length;j++){var rule=sheet.cssRules[j];if(rule.type===CSSRule.STYLE_RULE&&rule.selectorText.search(ignore)!==-1){rule.selectorText=rule.selectorText.replace(orig,replace)}}}}catch(e){}}})();(function(){var requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){setTimeout(function(){callback(Date.now())},30)};window.requestAnimationFrame=requestAnimationFrame})();cr.define("cr.ui",function(){function scrollList(elem,wrapper,pager,conf){var default_conf={onfirstload:function(){return true},onload:function(obj,idx){return true},deleteAnchor:true,anchorClass:".anchor"},that=this;conf=conf||{};for(var key in default_conf){if(conf[key]==null){conf[key]=default_conf[key]}}that.elem=elem;that.wrapper=wrapper;that.pager=pager;that.onfirstload=conf.onfirstload;that.onload=conf.onload;that.deleteAnchor=conf.deleteAnchor;that.first_load=true;that.ajax_loading=true;that.anchor_element=elem.querySelector(conf.anchorClass)}function handleScroll(e){if(this.ajax_loading){return}e.preventDefault();e.stopImmediatePropagation();var that=this,elem=that.wrapper,scrollTop=elem.scrollTop,windowHeight=elem.clientHeight,scrollHeight=elem.scrollHeight;if(scrollTop+windowHeight+15>scrollHeight){that.ajax_loading=true;that.pager.next(loadItem.bind(that))}}function loadItem(obj_list){var that=this,elem=that.elem,pager=that.pager;for(var i=0;i<obj_list.length;i++){that.onload&&that.onload(obj_list[i],i)}if(that.first_load){that.onfirstload&&that.onfirstload(obj_list)}if(!pager.has_next){if(!that.first_load||that.deleteAnchor||obj_list.length>0){elem.removeChild(that.anchor_element)}that.wrapper.removeEventListener("scroll",that.scrollcbk)}that.first_load=false;that.ajax_loading=false}scrollList.prototype={load:function(){var that=this;that.scrollcbk=handleScroll.bind(that);that.wrapper.addEventListener("scroll",that.scrollcbk);that.pager.load(loadItem.bind(that))}};return{scrollList:scrollList}});cr.define("cr.ui",function(){var notificationTimeout=null;function showNotification(text,actionText,opt_delay){var notificationElement=$("notification");var actionLink=notificationElement.querySelector(".link-color");var delay=opt_delay||5000;function show(){window.clearTimeout(notificationTimeout);notificationElement.classList.add("show");document.body.classList.add("notification-shown")}function hide(){window.clearTimeout(notificationTimeout);notificationElement.classList.remove("show");document.body.classList.remove("notification-shown");actionLink.tabIndex=-1;actionLink.blur()}function delayedHide(){notificationTimeout=window.setTimeout(hide,delay)}notificationElement.firstElementChild.textContent=text;actionLink.textContent=actionText;actionLink.onclick=hide;actionLink.onkeydown=function(e){if(e.keyIdentifier=="Enter"){hide()}};notificationElement.onmouseover=show;notificationElement.onmouseout=delayedHide;actionLink.onfocus=show;actionLink.onblur=delayedHide;actionLink.tabIndex=0;show();delayedHide()}return{showNotification:showNotification}});cr.define("cr.ui.bbcode",function(){function globalInitialization(){cr.ui.template.registerBBCode(/\[inlinedisk\](\d+)\[\/inlinedisk\]/ig,'<a class="richtext-inline-disk" href="#!library/$1/" remote_id="$1">...</a>');cr.ui.template.registerBBCode(/\[disk\](\d+)\[\/disk\]/ig,'<div class="richtext-disk" remote_id="$1"></div>');cr.ui.template.registerBBCode(/\[rfs\](\d+)\[\/rfs\]/ig,'<div class="richtext-rfs" remote_id="$1"></div>');cr.ui.template.registerBBCode(/\[ticket\](\d+)\[\/ticket\]/ig,'<div class="richtext-ticket" remote_id="$1"></div>');cr.ui.template.register("richtext_disk.html",function(param){var cover=this.querySelector(".richtext-disk-cover");if(param.disk.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.disk.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}});cr.ui.template.register("richtext_rfs.html",function(param){var items=this.querySelectorAll(".richtext-rfs-item");for(var i=0;i<items.length;i++){var item=items[i],disk=param.rfs["film_"+item.getAttribute("refer")];if(disk.cover_url){item.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+disk.cover_url.url+")"}else{item.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}}});cr.ui.template.register("richtext_ticket.html",function(param){var cover=this.querySelector(".richtext-disk-cover");if(param.ticket.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.ticket.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}})}function handleHTML(elem){var inline_disks=elem.querySelectorAll(".richtext-inline-disk"),disks=elem.querySelectorAll(".richtext-disk"),rfss=elem.querySelectorAll(".richtext-rfs"),tickets=elem.querySelectorAll(".richtext-ticket");for(var i=0;i<inline_disks.length;i++){var entry=inline_disks[i],id=entry.getAttribute("remote_id");cr.model.Disk.get(id,(function(disk){this.textContent=disk.title_en+" / "+disk.title_ch}).bind(entry));entry.addEventListener("click",function(e){e.preventDefault();e.stopImmediatePropagation();routerManager.pushState(this.getAttribute("href").substr(2),false,false)})}for(var i=0;i<disks.length;i++){var entry=disks[i],id=entry.getAttribute("remote_id");cr.model.Disk.get(id,(function(disk){var info=cr.ui.template.render_template("richtext_disk.html",{disk:disk});this.appendChild(info);info.classList.remove("loading")}).bind(entry))}for(var i=0;i<rfss.length;i++){var entry=rfss[i],id=entry.getAttribute("remote_id");cr.model.RegularFilmShow.get(id,(function(rfs){var info=cr.ui.template.render_template("richtext_rfs.html",{rfs:rfs});this.appendChild(info);info.classList.remove("loading")}).bind(entry))}for(var i=0;i<tickets.length;i++){var entry=tickets[i],id=entry.getAttribute("remote_id");cr.model.PreviewShowTicket.get(id,(function(ticket){var info=cr.ui.template.render_template("richtext_ticket.html",{ticket:ticket});this.appendChild(info);info.classList.remove("loading")}).bind(entry))}}return{globalInitialization:globalInitialization,handleHTML:handleHTML}});cr.ui.bbcode.globalInitialization();cr.define("cr.ui",function(){var ArrowLocation={TOP_START:"top-start",TOP_END:"top-end",BOTTOM_START:"bottom-start",BOTTOM_END:"bottom-end"};var BubbleAlignment={ARROW_TO_MID_ANCHOR:"arrow-to-mid-anchor",BUBBLE_EDGE_TO_ANCHOR_EDGE:"bubble-edge-anchor-edge",ENTIRELY_VISIBLE:"entirely-visible"};var BubbleBase=cr.ui.define("div");BubbleBase.ARROW_OFFSET=30;BubbleBase.MIN_VIEWPORT_EDGE_MARGIN=2;BubbleBase.prototype={__proto__:HTMLDivElement.prototype,decorate:function(){this.className="bubble";this.innerHTML='<div class="bubble-content"></div><div class="bubble-shadow"></div><div class="bubble-arrow"></div>';this.hidden=true;this.bubbleAlignment=BubbleAlignment.ENTIRELY_VISIBLE},set anchorNode(node){if(!this.hidden){return}this.anchorNode_=node},set content(node){if(!this.hidden){return}var bubbleContent=this.querySelector(".bubble-content");bubbleContent.innerHTML="";bubbleContent.appendChild(node)},set arrowLocation(location){if(!this.hidden){return}this.arrowAtRight_=location==ArrowLocation.TOP_END||location==ArrowLocation.BOTTOM_END;if(document.documentElement.dir=="rtl"){this.arrowAtRight_=!this.arrowAtRight_}this.arrowAtTop_=location==ArrowLocation.TOP_START||location==ArrowLocation.TOP_END},set bubbleAlignment(alignment){if(!this.hidden){return}this.bubbleAlignment_=alignment},reposition:function(){var documentWidth=document.documentElement.clientWidth;var documentHeight=document.documentElement.clientHeight;var anchor=this.anchorNode_.getBoundingClientRect();var anchorMid=(anchor.left+anchor.right)/2;var bubble=this.getBoundingClientRect();var arrow=this.querySelector(".bubble-arrow").getBoundingClientRect();if(this.bubbleAlignment_==BubbleAlignment.ENTIRELY_VISIBLE){var left=this.arrowAtRight_?anchorMid+BubbleBase.ARROW_OFFSET-bubble.width:anchorMid-BubbleBase.ARROW_OFFSET;var max_left_pos=documentWidth-bubble.width-BubbleBase.MIN_VIEWPORT_EDGE_MARGIN;var min_left_pos=BubbleBase.MIN_VIEWPORT_EDGE_MARGIN;if(document.documentElement.dir=="rtl"){left=Math.min(Math.max(left,min_left_pos),max_left_pos)}else{left=Math.max(Math.min(left,max_left_pos),min_left_pos)}var arrowTip=Math.min(Math.max(arrow.width/2,this.arrowAtRight_?left+bubble.width-anchorMid:anchorMid-left),bubble.width-arrow.width/2);var offsetTop=Math.min(documentHeight-anchor.bottom-bubble.height,arrow.height/2);var offsetBottom=Math.min(anchor.top-bubble.height,arrow.height/2);if(offsetTop<0&&offsetBottom<0){var top=0;this.updateArrowPosition_(false,false,arrowTip)}else{if(offsetTop>offsetBottom||offsetTop==offsetBottom&&this.arrowAtTop_){var top=anchor.bottom+offsetTop;this.updateArrowPosition_(true,true,arrowTip)}else{var top=anchor.top-bubble.height-offsetBottom;this.updateArrowPosition_(true,false,arrowTip)}}}else{if(this.bubbleAlignment_==BubbleAlignment.BUBBLE_EDGE_TO_ANCHOR_EDGE){var left=this.arrowAtRight_?anchor.right-bubble.width:anchor.left}else{var left=this.arrowAtRight_?anchorMid-this.clientWidth+BubbleBase.ARROW_OFFSET:anchorMid-BubbleBase.ARROW_OFFSET}var top=this.arrowAtTop_?anchor.bottom+arrow.height/2:anchor.top-this.clientHeight-arrow.height/2;this.updateArrowPosition_(true,this.arrowAtTop_,BubbleBase.ARROW_OFFSET)}this.style.left=left+"px";this.style.top=top+"px"},show:function(){if(!this.hidden){return}this.attachToDOM_();this.hidden=false;this.reposition();var doc=this.ownerDocument;this.eventTracker_=new EventTracker;this.eventTracker_.add(doc,"keydown",this.handleEvent.bind(this),true);this.eventTracker_.add(doc,"mousedown",this.handleEvent.bind(this),true)},hide:function(){if(this.hidden){return}this.eventTracker_.removeAll();this.hidden=true;this.parentNode.removeChild(this)},handleEvent:function(event){if(event.type=="keydown"&&event.keyCode==27){this.hide();event.preventDefault();event.stopPropagation()}},attachToDOM_:function(){document.body.appendChild(this)},updateArrowPosition_:function(visible,atTop,tipOffset){var bubbleArrow=this.querySelector(".bubble-arrow");bubbleArrow.hidden=!visible;if(!visible){return}var edgeOffset=(-bubbleArrow.clientHeight/2)+"px";bubbleArrow.style.top=atTop?edgeOffset:"auto";bubbleArrow.style.bottom=atTop?"auto":edgeOffset;edgeOffset=(tipOffset-bubbleArrow.offsetWidth/2)+"px";bubbleArrow.style.left=this.arrowAtRight_?"auto":edgeOffset;bubbleArrow.style.right=this.arrowAtRight_?edgeOffset:"auto"}};var Bubble=cr.ui.define("div");Bubble.prototype={__proto__:BubbleBase.prototype,decorate:function(){BubbleBase.prototype.decorate.call(this);var close=document.createElement("div");close.className="bubble-close";this.insertBefore(close,this.querySelector(".bubble-content"));this.handleCloseEvent=this.hide;this.deactivateToDismissDelay_=0;this.bubbleAlignment=BubbleAlignment.ARROW_TO_MID_ANCHOR},set handleCloseEvent(handler){if(!this.hidden){return}this.handleCloseEvent_=handler},set deactivateToDismissDelay(delay){this.deactivateToDismissDelay_=delay},set closeButtonVisible(isVisible){this.querySelector(".bubble-close").hidden=!isVisible},show:function(){if(!this.hidden){return}BubbleBase.prototype.show.call(this);this.showTime_=Date.now();this.eventTracker_.add(window,"resize",this.reposition.bind(this))},handleEvent:function(event){BubbleBase.prototype.handleEvent.call(this,event);if(event.type=="mousedown"){if(event.target==this.querySelector(".bubble-close")){this.handleCloseEvent_()}else{if(!this.contains(event.target)&&Date.now()-this.showTime_>=this.deactivateToDismissDelay_){this.hide()}}}}};var AutoCloseBubble=cr.ui.define("div");AutoCloseBubble.prototype={__proto__:BubbleBase.prototype,decorate:function(){BubbleBase.prototype.decorate.call(this);this.classList.add("auto-close-bubble")},set domSibling(node){if(!this.hidden){return}this.domSibling_=node},show:function(){if(!this.hidden){return}BubbleBase.prototype.show.call(this);this.domSibling_.showingBubble=true;var doc=this.ownerDocument;this.eventTracker_.add(doc,"mousewheel",this.handleEvent.bind(this),true);this.eventTracker_.add(doc,"scroll",this.handleEvent.bind(this),true);this.eventTracker_.add(doc,"elementFocused",this.handleEvent.bind(this),true);this.eventTracker_.add(window,"resize",this.handleEvent.bind(this))},hide:function(){BubbleBase.prototype.hide.call(this);this.domSibling_.showingBubble=false},handleEvent:function(event){BubbleBase.prototype.handleEvent.call(this,event);switch(event.type){case"mousedown":if(event.button==0&&this.anchorNode_.contains(event.target)){break}case"mousewheel":case"scroll":if(this.contains(event.target)){break}case"resize":this.hide();break;case"elementFocused":if(!this.anchorNode_.contains(event.target)&&!this.contains(event.target)){this.hide()}break}},attachToDOM_:function(){var parent=this.domSibling_.parentNode;parent.insertBefore(this,this.domSibling_.nextSibling)}};return{ArrowLocation:ArrowLocation,BubbleAlignment:BubbleAlignment,BubbleBase:BubbleBase,Bubble:Bubble,AutoCloseBubble:AutoCloseBubble}});cr.define("cr.ui.overlay",function(){function getTopOverlay(){var overlays=document.querySelectorAll(".overlay:not([hidden])");return overlays[overlays.length-1]}function getDefaultButton(overlay){function isHidden(node){return node.hidden}var defaultButtons=overlay.querySelectorAll(".page .button-strip > .default-button");for(var i=0;i<defaultButtons.length;i++){if(!findAncestor(defaultButtons[i],isHidden)){return defaultButtons[i]}}return null}function globalInitialization(){document.addEventListener("keydown",function(e){var overlay=getTopOverlay();if(!overlay){return}if(e.keyCode==27){cr.dispatchSimpleEvent(overlay,"cancelOverlay")}var forbiddenTagNames=/^(A|BUTTON|SELECT|TEXTAREA)$/;if(e.keyIdentifier=="Enter"&&!forbiddenTagNames.test(document.activeElement.tagName)){var button=getDefaultButton(overlay);if(button){button.click()}}});window.addEventListener("resize",setMaxHeightAllPages);setMaxHeightAllPages()}function setMaxHeightAllPages(){var pages=document.querySelectorAll(".overlay .page");var maxHeight=Math.min(0.9*window.innerHeight,640)+"px";for(var i=0;i<pages.length;i++){pages[i].style.maxHeight=maxHeight}}function setupOverlay(overlay){var closeButtons=overlay.querySelectorAll(".page > .close-button");for(var i=0;i<closeButtons.length;i++){closeButtons[i].addEventListener("click",function(e){cr.dispatchSimpleEvent(overlay,"cancelOverlay")})}overlay.addEventListener("cancelOverlay",hideOverlay,true);var pages=overlay.querySelectorAll(".page");for(var i=0;i<pages.length;i++){pages[i].__defineSetter__("hidden",function(value){if(value){this.setAttribute("hidden",true)}else{this.removeAttribute("hidden")}});pages[i].__defineGetter__("hidden",function(){return this.hasAttribute("hidden")})}overlay.__defineSetter__("hidden",function(value){this.classList.remove("pulse");if(value){this.setAttribute("hidden",true)}else{this.removeAttribute("hidden")}});overlay.__defineGetter__("hidden",function(){return this.hasAttribute("hidden")});overlay.addEventListener("click",function(e){if(this!=e.target){return}var overlayPage=this.querySelector(".page:not([hidden])");if(overlayPage){overlayPage.classList.add("pulse")}});overlay.addEventListener("webkitAnimationEnd",function(e){e.target.classList.remove("pulse")});overlay.addEventListener("MSAnimationEnd",function(e){e.target.classList.remove("pulse")});overlay.addEventListener("oAnimationEnd",function(e){e.target.classList.remove("pulse")});overlay.addEventListener("animationend",function(e){e.target.classList.remove("pulse")})}function setupPage(page){var closeButtons=page.querySelectorAll(".close-button");for(var i=0;i<closeButtons.length;i++){closeButtons[i].addEventListener("click",function(e){cr.dispatchSimpleEvent(page.parentNode,"cancelOverlay")})}page.__defineSetter__("hidden",function(value){if(value){this.setAttribute("hidden",true)}else{this.removeAttribute("hidden")}});page.__defineGetter__("hidden",function(){return this.hasAttribute("hidden")})}function showOverlay(page){assert(page);var overlay=page.parentNode,showing=overlay.querySelector(".page:not([hidden])");if(showing===page){return}if(showing){showing.hidden=true}overlay.hidden=false;overlay.classList.remove("transparent");page.hidden=false;page.classList.add("pulse");document.body.classList.add("hideflow")}function hideOverlay(e){assert(e.target);var overlay=findAncestor(e.target,function(elem){return elem.classList.contains("overlay")});assert(overlay);var listener=function(ev){if(!ev.target.classList.contains("overlay")){return}if(e.target.classList.contains("page")){e.target.hidden=true}else{var visible_children=ev.target.querySelectorAll(".page:not([hidden])");for(var i=0;i<visible_children.length;i++){visible_children[i].hidden=true}}if(!ev.target.querySelector(".page:not([hidden])")){ev.target.hidden=true;if(!document.body.querySelector(".overlay:not([hidden])")){document.body.classList.remove("hideflow")}}ev.target.removeEventListener("webkitAnimationEnd",listener);ev.target.removeEventListener("MSAnimationEnd",listener);ev.target.removeEventListener("oAnimationEnd",listener);ev.target.removeEventListener("animationend",listener)};overlay.addEventListener("webkitAnimationEnd",listener,false);overlay.addEventListener("MSAnimationEnd",listener,false);overlay.addEventListener("oAnimationEnd",listener,false);overlay.addEventListener("animationend",listener,false);overlay.classList.remove("transparent");setTimeout(function(){overlay.classList.add("transparent")},0)}return{globalInitialization:globalInitialization,setupOverlay:setupOverlay,setupPage:setupPage,showOverlay:showOverlay,hideOverlay:hideOverlay}});document.addEventListener("DOMContentLoaded",cr.ui.overlay.globalInitialization);cr.define("cr.ui",function(){function replaceContent(repl){var container=$("main-container");container.classList.add("loading");if(repl instanceof HTMLElement||repl instanceof DocumentFragment){setTimeout(function(){container.setAttribute("hidden",true);while(container.firstChild){container.removeChild(container.firstChild)}container.appendChild(repl);container.removeAttribute("hidden");container.classList.remove("loading")},180)}else{if(repl instanceof Function){setTimeout(function(){container.setAttribute("hidden",true);while(container.firstChild){container.removeChild(container.firstChild)}repl(container);container.removeAttribute("hidden");container.classList.remove("loading")},180)}else{container.classList.remove("loading");assert(false,"Error processing content")}}}function controlInitialization(){var navigationItems=document.querySelectorAll("li:not(.space)");for(var i=0;i<navigationItems.length;++i){navigationItems[i].addEventListener("click",onNavItemClicked)}}function onNavItemClicked(e){if(e.currentTarget.classList.contains("space")){return}if(!e.currentTarget.classList.contains("selected")){setSelection(e.currentTarget)}var control=e.currentTarget.getAttribute("controls");routerManager.pushState(control+"/",false,false)}function changeSelection(name){var navItem=document.querySelector('li[controls="'+name+'"]');setSelection(navItem)}function setSelection(newSelection){var lastSelectedNavItem=document.querySelector("li.selected");if(lastSelectedNavItem!==newSelection){newSelection.classList.add("selected");if(lastSelectedNavItem){lastSelectedNavItem.classList.remove("selected")}}}function displayLoading(elem){var chd=elem.querySelectorAll(".temp-loading"),d=createElementWithClassName("div","temp-loading");if(chd.length>0){return}d.innerHTML='<div class="throbber"></div><span>Loading...</span>';elem.setAttribute("hidden",true);elem.appendChild(d);elem.removeAttribute("hidden")}function removeLoading(elem){var chd=elem.querySelectorAll(".temp-loading");elem.setAttribute("hidden",true);for(var i=0;i<chd.length;i++){elem.removeChild(chd[i])}elem.removeAttribute("hidden")}function loadingListener(e){if(e.keyCode==27){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation()}return false}function showLoading(){cr.ui.overlay.showOverlay($("loadingOverlay"));window.addEventListener("keydown",loadingListener,true)}function hideLoading(){window.removeEventListener("keydown",loadingListener);cr.dispatchSimpleEvent($("loadingOverlay"),"cancelOverlay")}function resetMultiuse(){var overlay=$("multiuseOverlay");overlay.querySelector("h1").innerHTML="&nbsp;";overlay.querySelector(".content-area").innerHTML="";$("multiuse-button1").setAttribute("hidden","true");$("multiuse-button2").setAttribute("hidden","true");$("multiuse-button3").setAttribute("hidden","true");if(overlay.eventTracker){overlay.eventTracker.removeAll()}else{overlay.eventTracker=new EventTracker}}return{replaceContent:replaceContent,controlInitialization:controlInitialization,changeSelection:changeSelection,displayLoading:displayLoading,removeLoading:removeLoading,showLoading:showLoading,hideLoading:hideLoading,resetMultiuse:resetMultiuse}});document.addEventListener("DOMContentLoaded",cr.ui.controlInitialization);cr.define("alertOverlay",function(){var okButton;var cancelButton;function initialize(e){okButton=$("alertOverlayOk");cancelButton=$("alertOverlayCancel");okButton.addEventListener("click",function(e){assert(okButton.clickCallback);okButton.clickCallback(e);okButton.clickCallback=null;cancelButton.clickCallback=null});cancelButton.addEventListener("click",function(e){assert(cancelButton.clickCallback);cancelButton.clickCallback(e);okButton.clickCallback=null;cancelButton.clickCallback=null})}function setValues(title,message,okTitle,cancelTitle,okCallback,cancelCallback){if(typeof title!="undefined"){$("alertOverlayTitle").textContent=title}$("alertOverlayTitle").hidden=typeof title=="undefined";if(typeof message!="undefined"){$("alertOverlayMessage").textContent=message}$("alertOverlayMessage").hidden=typeof message=="undefined";if(okTitle){okButton.textContent=okTitle}okButton.hidden=!okTitle;okButton.clickCallback=okCallback;if(cancelTitle){cancelButton.textContent=cancelTitle}cancelButton.hidden=!cancelTitle;cancelButton.clickCallback=cancelCallback}return{initialize:initialize,setValues:setValues}});document.addEventListener("DOMContentLoaded",alertOverlay.initialize);cr.define("cr.ui",function(){function DragWrapper(target,handler){this.initialize(target,handler)}DragWrapper.prototype={initialize:function(target,handler){target.addEventListener("dragenter",this.onDragEnter_.bind(this));target.addEventListener("dragover",this.onDragOver_.bind(this));target.addEventListener("drop",this.onDrop_.bind(this));target.addEventListener("dragleave",this.onDragLeave_.bind(this));this.target_=target;this.handler_=handler},dragEnters_:0,get isCurrentDragTarget(){return this.target_.classList.contains("drag-target")},onDragEnter_:function(e){if(++this.dragEnters_==1){if(this.handler_.shouldAcceptDrag(e)){this.target_.classList.add("drag-target");this.handler_.doDragEnter(e)}}else{this.onDragOver_(e)}},onDragOver_:function(e){if(!this.target_.classList.contains("drag-target")){return}this.handler_.doDragOver(e)},onDrop_:function(e){this.dragEnters_=0;if(!this.target_.classList.contains("drag-target")){return}this.target_.classList.remove("drag-target");this.handler_.doDrop(e)},onDragLeave_:function(e){if(--this.dragEnters_>0){return}this.target_.classList.remove("drag-target");this.handler_.doDragLeave(e)}};return{DragWrapper:DragWrapper}});cr.define("cr.richText",function(){function Initialization(){cr.ui.template.register("admin/richtext_toolbar.html",function(){var popup_link=this.querySelector(".link-adder"),popup_color=this.querySelector(".colorpicker"),popup_img=this.querySelector(".image-adder"),popup_id=this.querySelector(".id-adder");popup_link.querySelector('button[controls="ok"]').addEventListener("click",function(){popup_link.ok_cbk()});popup_link.querySelector('button[controls="cancel"]').addEventListener("click",function(){popup_link.cancel_cbk()});popup_color.querySelector('button[controls="ok"]').addEventListener("click",function(){popup_color.ok_cbk()});popup_color.querySelector('button[controls="cancel"]').addEventListener("click",function(){popup_color.cancel_cbk()});ColorPicker(popup_color.querySelector(".colorpicker-wrapper"),function(hex){popup_color.querySelector(".sample").style.color=hex;popup_color.querySelector('input[name="color"]').value=hex});popup_img.querySelector('button[controls="ok"]').addEventListener("click",function(){popup_img.ok_cbk()});popup_img.querySelector('button[controls="cancel"]').addEventListener("click",function(){popup_img.cancel_cbk()});cr.uploader.init(popup_img.querySelector(".cover-drop"),function(){popup_img.querySelector('input[name="url"]').value="uploading"},function(new_cover){popup_img.querySelector(".cover-container").style.backgroundImage="url("+cr.settings.resource_base+"upload/"+new_cover.url+")";popup_img.querySelector('input[name="url"]').value=cr.settings.resource_base+"upload/"+new_cover.url});popup_id.querySelector('button[controls="ok"]').addEventListener("click",function(){popup_id.ok_cbk()});popup_id.querySelector('button[controls="cancel"]').addEventListener("click",function(){popup_id.cancel_cbk()})})}function init(node){var toolbar=cr.ui.template.render_template("admin/richtext_toolbar.html");node.parentNode.insertBefore(toolbar,node);toolbar.querySelector(".bar").addEventListener("click",function(e){var action=e.target.getAttribute("controls");if(!action){return}switch(action){case"bold":wrapSelection.call(node,"b");break;case"italics":wrapSelection.call(node,"i");break;case"underline":wrapSelection.call(node,"u");break;case"big":case"small":wrapSelection.call(node,action);break;case"link":addLink.call(node,toolbar);break;case"color":addColor.call(node,toolbar);break;case"img":addImage.call(node,toolbar);break;case"inlinedisk":case"disk":case"rfs":case"ticket":addCustomTag.call(node,toolbar,action);break;case"preview":switchPreview.call(node,toolbar);break}});toolbar.querySelector(".preview").addEventListener("click",function(e){var action=e.target.getAttribute("controls");if(!action){return}switch(action){case"edit":switchEdit.call(node,toolbar);break}})}function wrapSelection(tag){if(this.selectionStart!=undefined&&this.selectionEnd!=undefined&&this.selectionEnd>this.selectionStart){this.value=this.value.splice(this.selectionEnd,0,"[/"+tag+"]");this.value=this.value.splice(this.selectionStart,0,"["+tag+"]");this.setSelectionRange(this.selectionStart+("["+tag+"]").length,this.selectionEnd+("["+tag+"]").length);this.focus()}else{alert("Select Text First")}}function addLink(toolbar){var popup=toolbar.querySelector(".link-adder"),input=popup.querySelector('input[name="url"]'),start=this.selectionStart,end=this.selectionEnd;input.value="";input.removeAttribute("disabled");popup.ok_cbk=(function(popup,input){popup.setAttribute("hidden",true);input.setAttribute("disabled",true);if(start!=undefined&&end!=undefined&&end>start){this.value=this.value.splice(end,0,"[/link]");var startTag="[link="+input.value+"]";this.value=this.value.splice(start,0,startTag);this.setSelectionRange(start+startTag.length,end+startTag.length);this.focus()}}).bind(this,popup,input);popup.cancel_cbk=(function(popup){input.setAttribute("disabled",true);popup.setAttribute("hidden",true);this.setSelectionRange(start,end);this.focus()}).bind(this,popup);popup.removeAttribute("hidden")}function addColor(toolbar){var popup=toolbar.querySelector(".colorpicker"),input=popup.querySelector('input[name="color"]'),start=this.selectionStart,end=this.selectionEnd;input.value="";popup.ok_cbk=(function(popup,input){popup.setAttribute("hidden",true);input.setAttribute("disabled",true);if(start!=undefined&&end!=undefined&&end>start){this.value=this.value.splice(end,0,"[/color]");var startTag="[color="+input.value+"]";this.value=this.value.splice(start,0,startTag);this.setSelectionRange(start+startTag.length,end+startTag.length);this.focus()}}).bind(this,popup,input);popup.cancel_cbk=(function(popup){input.setAttribute("disabled",true);popup.setAttribute("hidden",true);this.setSelectionRange(start,end);this.focus()}).bind(this,popup);popup.removeAttribute("hidden")}function addImage(toolbar){var popup=toolbar.querySelector(".image-adder"),input=popup.querySelector('input[name="url"]'),start=this.selectionStart,end=this.selectionEnd;input.value="";popup.querySelector(".cover-container").style.background="";popup.querySelector(".progressbar-track").setAttribute("hidden",true);popup.querySelector(".progressbar-progress").setAttribute("hidden",true);popup.ok_cbk=(function(popup,input){if(input.value=="uploading"){alert("Still uploading");return}popup.setAttribute("hidden",true);input.setAttribute("disabled",true);if(start!=undefined&&end!=undefined&&end>=start){this.value=this.value.splice(end,0,"[/img]");var startTag="[img="+input.value+"]";this.value=this.value.splice(start,0,startTag);this.setSelectionRange(start+startTag.length,end+startTag.length);this.focus()}}).bind(this,popup,input);popup.cancel_cbk=(function(popup){input.setAttribute("disabled",true);popup.setAttribute("hidden",true);this.setSelectionRange(start,end);this.focus()}).bind(this,popup);popup.removeAttribute("hidden")}function addCustomTag(toolbar,custom_tag){var popup=toolbar.querySelector(".id-adder"),input=popup.querySelector('input[name="itemid"]'),start=this.selectionStart,end=this.selectionEnd;input.value="";input.removeAttribute("disabled");popup.ok_cbk=(function(popup,input){popup.setAttribute("hidden",true);input.setAttribute("disabled",true);if(start!=undefined&&end!=undefined){var Tag="["+custom_tag+"]"+input.value+"[/"+custom_tag+"]";this.value=this.value.splice(start,end-start,Tag);this.setSelectionRange(start,start+Tag.length);this.focus()}}).bind(this,popup,input);popup.cancel_cbk=(function(popup){input.setAttribute("disabled",true);popup.setAttribute("hidden",true);this.setSelectionRange(start,end);this.focus()}).bind(this,popup);popup.removeAttribute("hidden")}function switchPreview(toolbar){var bar=toolbar.querySelector(".bar"),preview=toolbar.querySelector(".preview .preview-wrapper");bar.setAttribute("hidden",true);this.setAttribute("hidden",true);while(preview.firstChild){preview.removeChild(preview.firstChild)}preview.innerHTML=cr.ui.template.escapeBBCode(this.value);cr.ui.bbcode.handleHTML(preview);toolbar.querySelector(".preview").removeAttribute("hidden")}function switchEdit(toolbar){var bar=toolbar.querySelector(".bar"),preview=toolbar.querySelector(".preview .preview-wrapper");bar.removeAttribute("hidden");this.removeAttribute("hidden");toolbar.querySelector(".preview").setAttribute("hidden",true)}return{Initialization:Initialization,init:init}});cr.richText.Initialization();cr.define("cr.uploader",function(){function init(container,ondrop,callback){var track=container.querySelector(".progressbar-track"),progressbar=container.querySelector(".progressbar-bar"),progresstext=container.querySelector(".progressbar-progress"),dropper=container.querySelector(".drag-notifier"),wrapper=new cr.ui.DragWrapper(container,{doDragEnter:function(e){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation();dropper.removeAttribute("hidden")},doDragOver:function(e){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation();dropper.removeAttribute("hidden")},doDrop:function(e){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation();dropper.setAttribute("hidden","true");if(e.dataTransfer.files&&e.dataTransfer.files[0]){var r=new cr.APIRequest(cr.model.File,"POST","/"),form=new FormData;form.append("file",e.dataTransfer.files[0]);progressbar.style.width="0%";progresstext.textContent="0%";track.removeAttribute("hidden");progresstext.removeAttribute("hidden");r.onuploadprogress=function(e){var complete=(e.loaded/e.total*80|0)+"%";progressbar.style.width=complete;progresstext.textContent=complete};r.onloadprogress=function(e){if(e.lengthComputable){var complete=(80+(e.loaded/e.total*20|0))+"%";progressbar.style.width=complete;progresstext.textContent=complete}};r.onload=function(e){progressbar.style.width="100%";progresstext.textContent="Upload Complete";if(callback){callback(e.recObj)}};r.onerror=cr.errorHandler;if(ondrop){ondrop()}r.sendRaw(form)}},doDragLeave:function(e){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation();dropper.setAttribute("hidden","true")},shouldAcceptDrag:function(e){return true}})}return{init:init}});cr.define("cr.model",function(){var File=new cr.BaseModel("file"),User=new cr.BaseModel("user"),Log=new cr.BaseModel("log"),Disk=new cr.BaseModel("disk"),RegularFilmShow=new cr.BaseModel("regularfilmshow"),PreviewShowTicket=new cr.BaseModel("previewshowticket"),DiskReview=new cr.BaseModel("diskreview"),News=new cr.BaseModel("news"),Document=new cr.BaseModel("document"),Publication=new cr.BaseModel("publication"),Sponsor=new cr.BaseModel("sponsor"),Exco=new cr.BaseModel("exco"),SiteSettings=new cr.BaseModel("sitesettings"),OneSentence=new cr.BaseModel("onesentence");File.fields=["id","name","url"];User.fields=["id","expire_at","expired","admin","full_name","itsc","join_at","member_type","mobile","pennalized","rfs_count","login_count","student_id","university_id"];User.types=["create","edit","delete"];Log.fields=["id","model","log_type","model_refer","user_affected","admin_involved","content","created_at"];Disk.fields=["id","director_en","director_ch","category","create_log","imdb_url","show_year","avail_type","actors","desc_en","tags","reserved_by","title_en","cover_url","hold_by","disk_type","due_at","borrow_cnt","length","desc_ch","title_ch"];Disk.types=["create","edit","delete","reserve","borrow","rate"];RegularFilmShow.fields=["id","state","film_1","film_2","film_3","vote_cnt_1","vote_cnt_2","vote_cnt_3","create_log","remarks","participant_list"];RegularFilmShow.types=["create","edit","delete","vote","entry"];PreviewShowTicket.fields=["id","state","title_en","title_ch","desc_en","desc_ch","director_en","director_ch","actors","cover_url","language","subtitle","venue","show_time","apply_deadline","length","quantity","remarks","successful_applicant","create_log"];PreviewShowTicket.types=["create","edit","delete","apply"];DiskReview.fields=["id","poster","disk","content","create_log"];DiskReview.types=["create","delete"];News.fields=["id","title","content","create_log"];News.types=["create","edit","delete"];Document.fields=["id","title","doc_url","create_log"];Document.types=["create","edit","delete"];Publication.fields=["id","pub_type","title","cover_url","doc_url","ext_doc_url","create_log"];Publication.types=["create","edit","delete"];Sponsor.fields=["id","name","img_url","create_log"];Sponsor.types=["create","edit","delete"];Exco.fields=["id","name_en","name_ch","descript","position","email","hall_allocate","img_url"];SiteSettings.fields=["id","key","value"];SiteSettings._cache_dict={};SiteSettings.loadSettings=function(callback){var r=new cr.APIRequest(this,"GET","/",true);r.onload=function(e){for(var i=0;i<e.recObj.objects.length;i++){SiteSettings.update(e.recObj.objects[i],1);SiteSettings._cache_dict[e.recObj.objects[i].key]=e.recObj.objects[i].id}if(callback){callback()}};r.onerror=cr.errorHandler;r.send()};SiteSettings.getField=function(field){if(!this._cache_dict[field]){return null}return this._cache[this._cache_dict[field]].data};OneSentence.fields=["id","content","create_log","film"];OneSentence.types=["create","edit","delete"];return{File:File,User:User,Log:Log,Disk:Disk,RegularFilmShow:RegularFilmShow,PreviewShowTicket:PreviewShowTicket,DiskReview:DiskReview,News:News,Document:Document,Publication:Publication,Sponsor:Sponsor,Exco:Exco,SiteSettings:SiteSettings,OneSentence:OneSentence}});cr.model.User.setup(true);cr.model.Disk.setup(true);cr.model.RegularFilmShow.setup(true);cr.model.PreviewShowTicket.setup(true);cr.model.News.setup(true);cr.model.Document.setup(true);cr.model.Publication.setup(true);cr.model.Sponsor.setup(true);cr.model.Exco.setup(true);cr.define("Application",function(){function initialization(){cr.ui.overlay.setupOverlay($("overlay_1"));cr.ui.overlay.setupOverlay($("overlay_2"));cr.ui.showLoading();window.addEventListener("moduleload",function(){var r=new cr.APIRequest(cr.model.User,"GET","/current_user/",true);r.onload=function(ev){if(!ev.recObj.admin){ev.recObj={errno:2,error:"Admin Only"};errorHandler(ev)}else{cr.model.User.update(ev.recObj,1);cr.define("cr",function(){return{user_id:ev.recObj.id}});cr.model.SiteSettings.loadSettings(function(){cr.dispatchSimpleEvent(window,"authload",false,false)})}};r.onerror=errorHandler;r.send()});window.addEventListener("authload",cr.ui.hideLoading);cr.define("cr",function(){return{errorHandler:errorHandler,notFoundHandler:notFoundHandler}})}function errorHandler(ev){cr.ui.hideLoading();alertOverlay.setValues("Error",ev.recObj.error||"Fatal: Server Error","Retry",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");routerManager.parseHash()},null);cr.ui.overlay.showOverlay($("alertOverlay"))}function startPage(){var img=new Image();img.onload=function(){cr.ui.replaceContent(cr.ui.template.render_template("admin/start_page.html"))};img.src="../asset/css/admin/title_img.png"}function notFoundHandler(url){var content=cr.ui.template.render_template("admin/notfound.html",{url:url});cr.ui.replaceContent(content)}function collectForm(content){var inputs=content.querySelectorAll("input:enabled, select:enabled, textarea:enabled"),payload={};for(var i=0;i<inputs.length;i++){payload[inputs[i].name]=(inputs[i].type==="checkbox")?inputs[i].checked:inputs[i].value;if(payload[inputs[i].name]==undefined||payload[inputs[i].name]===""){payload[inputs[i].name]=null;if(inputs[i].getAttribute("role")==="list"){payload[inputs[i].name]=""}}}return payload}return{initialization:initialization,startPage:startPage,collectForm:collectForm}});document.addEventListener("DOMContentLoaded",Application.initialization);cr.ui.template.register("admin/notfound.html");cr.ui.template.register("admin/start_page.html");routerManager.register(/\//,true,Application.startPage);cr.define("cr.logger",function(){function initialize(){var log_list=$("log-view-list");$("close-log-view").addEventListener("click",function(){cr.dispatchSimpleEvent(this,"cancelOverlay")});window.addEventListener("resize",setMaxHeight);setMaxHeight()}function setMaxHeight(){var log_list=$("log-view-list");log_list.style.maxHeight=(0.5*Math.min(0.9*window.innerHeight,640))+"px"}function showLogger(title,filter,types){types=types&&types.slice(0);var model=filter.model,ref_id=filter.id,user_affected=filter.user,logger=$("log-view-page"),log_list=$("log-view-list"),options=$("log-view-options"),pager=new cr.Pager(cr.model.Log,generateAPI()),ajax_loading=true,rev=0;log_list.innerHTML='<div class="spacer"></div><div class="list-loading"><div class="spinner"></div></div>';$("log-view-title").textContent=title;var loading=log_list.querySelector(".list-loading"),spacer=log_list.querySelector(".spacer");options.innerHTML="";for(var i=0;types&&i<types.length;i++){var d=cr.ui.template.render_template("admin/filter_checker.html",{type:types[i]});d.addEventListener("change",function(e){var type=e.target.getAttribute("filter");if(e.target.checked){types.push(type)}else{types.splice(types.indexOf(type),1)}rev++;log_list.innerHTML='<div class="spacer"></div><div class="list-loading"><div class="spinner"></div></div>';loading=log_list.querySelector(".list-loading");spacer=log_list.querySelector(".spacer");pager=new cr.Pager(cr.model.Log,generateAPI());ajax_loading=true;pager.load(appendLog.bind(pager,rev))});options.appendChild(d)}cr.ui.overlay.showOverlay($("log-view-page"));pager.load(appendLog.bind(pager,rev));log_list.onscroll=function(e){e.stopImmediatePropagation();if(ajax_loading||!pager.has_next){return}var scrollTop=log_list.scrollTop,windowHeight=log_list.clientHeight,scrollHeight=log_list.scrollHeight;if(scrollTop+windowHeight+5>scrollHeight){ajax_loading=true;pager.next(appendLog.bind(pager,rev))}};function appendLog(old_rev,obj_list){if(old_rev!==rev){return}if(!this.has_next){log_list.removeChild(loading)}for(var i=0;i<obj_list.length;i++){var d=cr.ui.template.render_template("admin/log_item.html",{log:obj_list[i]});log_list.insertBefore(d,spacer);setTimeout((function(){this.classList.remove("loading")}).bind(d),i*30)}ajax_loading=false}function generateAPI(){var param=[];if(model){param.push("model="+encodeURIComponent(model))}if(ref_id){param.push("model_refer="+encodeURIComponent(ref_id))}if(user_affected){param.push("user_affected="+encodeURIComponent(user_affected))}if(types){param.push("log_type__in="+encodeURIComponent(types.join(",")))}return"/?"+param.join("&")}}return{showLogger:showLogger,initialize:initialize}});document.addEventListener("DOMContentLoaded",cr.logger.initialize);cr.ui.template.register("admin/filter_checker.html");cr.ui.template.register("admin/log_item.html");cr.define("cr.view.member",function(){var name="member";function Initialize(){routerManager.register(/member\//,false,member_setup(member_list));routerManager.register(/member\/search\//,false,member_setup(member_search));cr.ui.template.register("admin/user_list.html");cr.ui.template.register("admin/user_search.html");cr.ui.template.register("admin/user_list_item.html",function(param){this.querySelector('button[control="edit"]').addEventListener("click",(function(obj){edit_member(obj.id)}).bind(null,param.user));this.querySelector('button[control="viewlog"]').addEventListener("click",(function(obj){cr.logger.showLogger("View Logs of member "+obj.itsc,{user:obj.id})}).bind(null,param.user));this.querySelector('button[control="delete"]').addEventListener("click",delete_member.bind(null,param.user))});cr.ui.template.register("admin/user_edit.html",function(){this.querySelector('input[name="university_id"]').addEventListener("keydown",function(e){if(e.keyCode===13){e.preventDefault();e.stopImmediatePropagation()}},true)});cr.ui.template.register("admin/user_create.html",function(){this.querySelector('input[name="university_id"]').addEventListener("keydown",function(e){if(e.keyCode===13){e.preventDefault();e.stopImmediatePropagation()}},true)})}function member_setup(func){return function(){cr.ui.changeSelection(name);document.title="Member | Film Society, HKUSTSU";func.apply(this,arguments)}}function create_member(){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Create New Member";button2.textContent="Create";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);var form=cr.ui.template.render_template("admin/user_create.html");content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);cr.model.User.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})}function edit_member(id){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Edit Member Information";button2.textContent="Save";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);cr.model.User.get(id,function(obj){var form=cr.ui.template.render_template("admin/user_edit.html",{user:obj});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);cr.model.User.put(id,payload,true,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})})}function delete_member(user){alertOverlay.setValues("Confirm Delete","Confirm delete member "+user.itsc+"?","Delete","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();cr.model.User.remove(user.id,function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Deleted","dismiss")})},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function member_list(query){var page=query.page||1,type_filter=query.type_filter?query.type_filter.split(","):["Full","OneSem","OneYear","TwoYear","ThreeYear","Honour","Assoc"],skeleton=cr.ui.template.render_template("admin/user_list.html",{filter:type_filter});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/?page="+page+"&member_type__in="+type_filter.join(","),pager=new cr.Pager(cr.model.User,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});var checkbox=skeleton.querySelectorAll('header .controls input[type="checkbox"]');for(var i=0;i<checkbox.length;i++){checkbox[i].addEventListener("change",function(e){var type=e.target.getAttribute("filter");if(e.target.checked){type_filter.push(type)}else{type_filter.splice(type_filter.indexOf(type),1)}page=1;api_query="/?page="+page+"&member_type__in="+type_filter.join(","),pager=new cr.Pager(cr.model.User,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)})}skeleton.querySelector("#user-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module User",{model:"User"},cr.model.User.types)});skeleton.querySelector("#user-create-member").addEventListener("click",create_member);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}var new_query={q:e.target.value};routerManager.pushState("member/search/?q="+encodeURIComponent(e.target.value),false,false)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/user_list_item.html",{user:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"member/?page="+page+"&type_filter="+type_filter.join(",")}}function member_search(query){var page=query.page||1,param=query.q||"",skeleton=cr.ui.template.render_template("admin/user_search.html",{query:param});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/search/?page="+page+"&query="+encodeURIComponent(param),pager=new cr.Pager(cr.model.User,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#user-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module User",{model:"User"},cr.model.User.types)});skeleton.querySelector("#user-create-member").addEventListener("click",create_member);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}param=e.target.value;page=1;api_query="/search/?page="+page+"&query="+encodeURIComponent(param);pager=new cr.Pager(cr.model.User,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/user_list_item.html",{user:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"member/search/?page="+page+"&q="+encodeURIComponent(param)}}return{Initialize:Initialize}});cr.view.member.Initialize();cr.define("cr.view.liba",function(){var name="liba";function cn(obj){return obj.disk_type+pad(obj.id,4)}function Initialize(){routerManager.register(/liba\//,false,liba_setup(liba_list));routerManager.register(/liba\/search\//,false,liba_setup(liba_search));cr.ui.template.register("admin/liba_list.html");cr.ui.template.register("admin/liba_search.html");cr.ui.template.register("admin/disk_list_item.html",function(param){var cover=this.querySelector("div.cover-column > img");if(param.disk.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.disk.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}this.querySelector('button[control="edit"]').addEventListener("click",(function(obj){edit_disk(obj.id)}).bind(null,param.disk));this.querySelector('button[control="viewlog"]').addEventListener("click",(function(obj){cr.logger.showLogger("View Logs of Disk "+cn(obj),{model:"Disk",id:obj.id},cr.model.Disk.types)}).bind(null,param.disk));this.querySelector('button[control="checkout"]').addEventListener("click",checkout_disk.bind(null,param.disk));this.querySelector('button[control="checkin"]').addEventListener("click",checkin_disk.bind(null,param.disk));this.querySelector('button[control="renew"]').addEventListener("click",renew_disk.bind(null,param.disk));this.querySelector('button[control="clear"]').addEventListener("click",clear_disk.bind(null,param.disk));this.querySelector('button[control="delete"]').addEventListener("click",delete_disk.bind(null,param.disk))});cr.ui.template.register("admin/disk_edit.html",function(param){var cover=this.querySelector(".cover-container");if(param.disk.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.disk.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}cr.uploader.init(this.querySelector(".cover-drop"),(function(){this.querySelector('input[name="cover_url"]').value="uploading"}).bind(this),(function(new_cover){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+new_cover.url+")";this.querySelector('input[name="cover_url"]').value=new_cover.id}).bind(this))});cr.ui.template.register("admin/disk_create.html",function(){var cover=this.querySelector(".cover-container");cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)";cr.uploader.init(this.querySelector(".cover-drop"),(function(){this.querySelector('input[name="cover_url"]').value="uploading"}).bind(this),(function(new_cover){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+new_cover.url+")";this.querySelector('input[name="cover_url"]').value=new_cover.id}).bind(this))});cr.ui.template.register("admin/disk_checkout.html",function(param){var node=this;this.querySelector('input[name="student_id"]').addEventListener("keyup",function(){if(this.value){node.querySelector('input[name="id"]').value="relate"}else{node.querySelector('input[name="id"]').value=null}});this.querySelector('input[name="university_id"]').addEventListener("keydown",function(e){if(e.keyCode===13){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation();cr.ui.showLoading();var r=new cr.APIRequest(cr.model.User,"GET","/?university_id="+this.value,true);r.onload=function(e){cr.ui.hideLoading();if(e.recObj.objects.length===0){node.querySelector('input[name="student_id"]').focus();node.querySelector('input[name="id"]').value="relate"}else{node.querySelector('input[name="id"]').value=e.recObj.objects[0].id;$("multiuse-button2").click()}};r.onerror=cr.errorHandler;r.send()}},true)})}function liba_setup(func){return function(){cr.ui.changeSelection(name);document.title="VCD/DVD Library | Film Society, HKUSTSU";func.apply(this,arguments)}}function create_disk(){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button1=$("multiuse-button1"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Create New Disk";button1.textContent="Save As Draft";button1.removeAttribute("hidden");button2.textContent="Publish";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);var form=cr.ui.template.render_template("admin/disk_create.html");content.appendChild(form);overlay.eventTracker.add(button1,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.cover_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}payload.avail_type="Draft";cr.model.Disk.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})});overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.cover_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}payload.avail_type="Available";cr.model.Disk.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})}function edit_disk(id){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Edit Disk Information";button2.textContent="Save";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);cr.model.Disk.get(id,function(obj){var form=cr.ui.template.render_template("admin/disk_edit.html",{disk:obj,cn:cn(obj)});content.appendChild(form);if(obj.avail_type==="Draft"){var button1=$("multiuse-button1");button1.textContent="Publish";button1.removeAttribute("hidden");overlay.eventTracker.add(button1,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.cover_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}payload.avail_type="Available";cr.model.Disk.put(id,payload,true,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})}overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.cover_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}cr.model.Disk.put(id,payload,true,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})})}function delete_disk(disk){alertOverlay.setValues("Confirm Delete","Confirm delete Disk "+cn(disk)+"?","Delete","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();cr.model.Disk.remove(disk.id,function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Deleted","dismiss")})},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function checkout_disk(disk){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Check out Disk "+cn(disk);button2.textContent="Check out";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);var form=cr.ui.template.render_template("admin/disk_checkout.html",{disk:disk,due_at:cr.model.SiteSettings.getField("due_date").value});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var r=new cr.APIRequest(cr.model.Disk,"POST","/"+disk.id+"/borrow/"),userid=form.querySelector('input[name="id"]').value;r.onload=function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Checked out","dismiss")};r.onerror=cr.errorHandler;if(userid==="relate"){var stu_id=content.querySelector('input[name="student_id"]').value,uni_id=content.querySelector('input[name="university_id"]').value;if(stu_id&&uni_id){var _r=new cr.APIRequest(cr.model.User,"POST","/relation/");_r.onload=function(e){r.sendJSON({id:e.recObj.id})};_r.onerror=cr.errorHandler;_r.sendJSON({student_id:stu_id,university_id:uni_id})}else{if(stu_id){var _r=new cr.APIRequest(cr.model.User,"GET","/?student_id="+stu_id);_r.onload=function(e){if(e.recObj.objects.length===0){var error=new cr.Event("error",false,true);error.recObj={errno:2,error:"User not exist"};cr.errorHandler(error)}else{r.sendJSON({id:e.recObj.objects[0].id})}};_r.onerror=cr.errorHandler;_r.send()}else{content.querySelector('input[name="student_id"]').focus()}}}else{r.sendJSON({id:userid})}})}function checkin_disk(disk){var today=new Date,t_start=Date.parse([today.getFullYear(),pad(today.getMonth()+1,2),pad(today.getDate(),2)].join("-")+"T00:00:00.000+08:00"),t_due=Date.parse(toISODate(disk.due_at)),day=1000*60*60*24;alertOverlay.setValues("Confirm Checkin","Check the disk "+cn(disk)+" before confirming!\nDue at: "+disk.due_at+((t_start>t_due)?("\nOverdue! Raw due day: "+Math.ceil((t_start-t_due)/day)+" days"):""),"Check in","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();var r=new cr.APIRequest(cr.model.Disk,"DELETE","/"+disk.id+"/borrow/");r.onload=function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Succeeded","dismiss")};r.onerror=cr.errorHandler;r.send()},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function clear_disk(disk){alertOverlay.setValues("Confirm Clear Reservation Record","Really?","Clear","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();var r=new cr.APIRequest(cr.model.Disk,"DELETE","/"+disk.id+"/reservation/");r.onload=function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Cleared","dismiss")};r.onerror=cr.errorHandler;r.send()},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function renew_disk(disk){alertOverlay.setValues("Confirm Renew","Renewing disk "+cn(disk)+" will postpone the due date to 7 days later!","Renew","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();var r=new cr.APIRequest(cr.model.Disk,"POST","/"+disk.id+"/borrow/");r.onload=function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Renewed","dismiss")};r.onerror=cr.errorHandler;r.sendJSON({id:disk.hold_by.id})},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function liba_list(query){var page=query.page||1,type_filter=query.type_filter?query.type_filter.split(","):["Draft","Available","Borrowed","Reserved","OnDelivery","ReservedCounter","Voting","Onshow"],skeleton=cr.ui.template.render_template("admin/liba_list.html",{filter:type_filter});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/?page="+page+"&avail_type__in="+type_filter.join(","),pager=new cr.Pager(cr.model.Disk,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});var checkbox=skeleton.querySelectorAll('header .controls input[type="checkbox"]');for(var i=0;i<checkbox.length;i++){checkbox[i].addEventListener("change",function(e){var type=e.target.getAttribute("filter");if(e.target.checked){type_filter.push(type)}else{type_filter.splice(type_filter.indexOf(type),1)}page=1;api_query="/?page="+page+"&avail_type__in="+type_filter.join(","),pager=new cr.Pager(cr.model.Disk,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)})}skeleton.querySelector("#liba-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module Disk",{model:"Disk"},cr.model.Disk.types)});skeleton.querySelector("#liba-create-disk").addEventListener("click",create_disk);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}var new_query={q:e.target.value};routerManager.pushState("liba/search/?q="+encodeURIComponent(e.target.value),false,false)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/disk_list_item.html",{disk:obj_list[i],cn:cn(obj_list[i])});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"liba/?page="+page+"&type_filter="+type_filter.join(",")}}function liba_search(query){var page=query.page||1,param=query.q||"",skeleton=cr.ui.template.render_template("admin/liba_search.html",{query:param});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query=generateAPI(),pager=new cr.Pager(cr.model.Disk,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#liba-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module Disk",{model:"Disk"},cr.model.Disk.types)});skeleton.querySelector("#liba-create-disk").addEventListener("click",create_disk);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}param=e.target.value;page=1;api_query=generateAPI();pager=new cr.Pager(cr.model.Disk,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/disk_list_item.html",{disk:obj_list[i],cn:cn(obj_list[i])});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"liba/search/?page="+page+"&q="+encodeURIComponent(param)}function generateAPI(){if(/^[AB]\d{4}$/.test(param)){return"/?disk_type="+param.substr(0,1)+"&id="+param.substr(1)}else{return"/search/?page="+page+"&query="+encodeURIComponent(param)}}}return{Initialize:Initialize}});cr.view.liba.Initialize();cr.define("cr.view.review",function(){var name="review";function Initialize(){routerManager.register(/review\//,false,review_setup(review_list));routerManager.register(/review\/search\//,false,review_setup(review_search));cr.ui.template.register("admin/review_list.html");cr.ui.template.register("admin/review_list_item.html",function(param){this.querySelector('button[control="delete"]').addEventListener("click",delete_review.bind(null,param.review))})}function review_setup(func){return function(){cr.ui.changeSelection(name);document.title="Disk Review | Film Society, HKUSTSU";func.apply(this,arguments)}}function delete_review(review){alertOverlay.setValues("Confirm Delete","Confirm delete thsi review?","Delete","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();cr.model.DiskReview.remove(review.id,function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Deleted","dismiss")})},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function review_list(query){var page=query.page||1,skeleton=cr.ui.template.render_template("admin/review_list.html",{query:""});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/?page="+page,pager=new cr.Pager(cr.model.DiskReview,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#review-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module DiskReview",{model:"DiskReview"},cr.model.DiskReview.types)});var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}var new_query={q:e.target.value};routerManager.pushState("review/search/?q="+encodeURIComponent(e.target.value),false,false)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/review_list_item.html",{review:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"review/?page="+page}}function review_search(query){var page=query.page||1,param=query.q||"",skeleton=cr.ui.template.render_template("admin/review_list.html",{query:param});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query;if(/^[AB]\d{4}$/.test(param)){api_query="/?disk="+param.substr(1)+"&page="+page}else{api_query="/search/?page="+page+"&query="+encodeURIComponent(param)}var pager=new cr.Pager(cr.model.DiskReview,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#review-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module DiskReview",{model:"DiskReview"},cr.model.DiskReview.types)});var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}param=e.target.value;page=1;if(/^[AB]\d{4}$/.test(param)){api_query="/?disk="+param.substr(1).replace(/^0+/g,"")+"&page="+page}else{api_query="/search/?page="+page+"&query="+encodeURIComponent(param)}pager=new cr.Pager(cr.model.DiskReview,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/review_list_item.html",{review:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"review/search/?page="+page+"&q="+encodeURIComponent(param)}}return{Initialize:Initialize}});cr.view.review.Initialize();cr.define("cr.view.onesentence",function(){var name="onesentence";function Initialize(){routerManager.register(/onesentence\//,false,onesentence_setup(onesentence_list));routerManager.register(/onesentence\/search\//,false,onesentence_setup(onesentence_search));cr.ui.template.register("admin/ons_list.html");cr.ui.template.register("admin/ons_list_item.html",function(param){this.querySelector('button[control="edit"]').addEventListener("click",(function(obj){edit_onesentence(obj.id)}).bind(null,param.ons));this.querySelector('button[control="delete"]').addEventListener("click",delete_onesentence.bind(null,param.ons))});cr.ui.template.register("admin/ons_form.html")}function onesentence_setup(func){return function(){cr.ui.changeSelection(name);document.title="One Sentence | Film Society, HKUSTSU";func.apply(this,arguments)}}function create_onesentence(){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Create New One Sentence";button2.textContent="Create";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);var form=cr.ui.template.render_template("admin/ons_form.html",{ons:{}});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);cr.model.OneSentence.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})}function edit_onesentence(id){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Edit One Sentence";button2.textContent="Save";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);cr.model.OneSentence.get(id,function(obj){var form=cr.ui.template.render_template("admin/ons_form.html",{ons:obj});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);cr.model.OneSentence.put(id,payload,true,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})})}function delete_onesentence(ons){alertOverlay.setValues("Confirm Delete","Confirm delete onesentence "+ons.content+"?","Delete","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();cr.model.OneSentence.remove(ons.id,function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Deleted","dismiss")})},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function onesentence_list(query){var page=query.page||1,skeleton=cr.ui.template.render_template("admin/ons_list.html",{query:""});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/?page="+page,pager=new cr.Pager(cr.model.OneSentence,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#ons-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module OneSentence",{model:"OneSentence"},cr.model.OneSentence.types)});skeleton.querySelector("#ons-create-onesentence").addEventListener("click",create_onesentence);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}var new_query={q:e.target.value};routerManager.pushState("onesentence/search/?q="+encodeURIComponent(e.target.value),false,false)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/ons_list_item.html",{ons:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"onesentence/?page="+page}}function onesentence_search(query){var page=query.page||1,param=query.q||"",skeleton=cr.ui.template.render_template("admin/ons_list.html",{query:param});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/search/?page="+page+"&query="+encodeURIComponent(param),pager=new cr.Pager(cr.model.OneSentence,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#ons-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module OneSentence",{model:"OneSentence"},cr.model.OneSentence.types)});skeleton.querySelector("#ons-create-onesentence").addEventListener("click",create_onesentence);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}param=e.target.value;page=1;api_query="/search/?page="+page+"&query="+encodeURIComponent(param);pager=new cr.Pager(cr.model.OneSentence,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/ons_list_item.html",{ons:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"onesentence/search/?page="+page+"&q="+encodeURIComponent(param)}}return{Initialize:Initialize}});cr.view.onesentence.Initialize();cr.define("cr.view.settings",function(){var name="settings";function Initialize(){routerManager.register(/settings\//,false,settings_setup(settings_set));cr.ui.template.register("admin/settings.html",function(){var buttons=this.querySelectorAll('button[type="submit"]'),node=this;for(var i=0;i<buttons.length;i++){buttons[i].addEventListener("click",function(){var key=this.getAttribute("control"),input_tag=node.querySelector('*[name="'+key+'"]'),value=input_tag.value,id=cr.model.SiteSettings.getField(key).id;cr.ui.showLoading();cr.model.SiteSettings.put(id,{value:value},true,function(){cr.ui.hideLoading();cr.ui.showNotification("Saved","dismiss")})})}})}function settings_setup(func){return function(){cr.ui.changeSelection(name);document.title="Site Settings | Film Society, HKUSTSU";func.apply(this,arguments)}}function settings_set(){var skeleton=cr.ui.template.render_template("admin/settings.html",{model:cr.model.SiteSettings}),cover=skeleton.querySelector(".front-drop img"),cover_id=cr.model.SiteSettings.getField("header_image").value;if(cover_id){cr.model.File.get(cover_id,function(file){cover.src=cr.settings.resource_base+"upload/"+file.url})}cr.uploader.init(skeleton.querySelector(".front-drop"),null,function(new_cover){var id=cr.model.SiteSettings.getField("header_image").id;cover.src=cr.settings.resource_base+"upload/"+new_cover.url;cr.ui.showLoading();cr.model.SiteSettings.put(id,{value:new_cover.id},true,function(){cr.ui.hideLoading();cr.ui.showNotification("Saved","dismiss")})});cr.ui.replaceContent(skeleton)}return{Initialize:Initialize}});cr.view.settings.Initialize();cr.define("cr.view.rfs",function(){var name="rfs";function toShow(obj){if(obj.film_1.avail_type==="Onshow"){return obj.film_1}if(obj.film_2.avail_type==="Onshow"){return obj.film_2}if(obj.film_3.avail_type==="Onshow"){return obj.film_3}var p=1;if(obj.vote_cnt_2>obj.vote_cnt_1){p=2}if(obj.vote_cnt_3>obj["vote_cnt_"+p]){p=3}return obj["film_"+p]}function cn(obj){return obj.disk_type+pad(obj.id,4)}function Initialize(){routerManager.register(/rfs\//,false,rfs_setup(rfs_list));cr.ui.template.register("admin/rfs_list.html");cr.ui.template.register("admin/rfs_list_item.html",function(param){this.querySelector('button[control="edit"]').addEventListener("click",(function(obj){edit_rfs(obj.id)}).bind(null,param.rfs));this.querySelector('button[control="viewlog"]').addEventListener("click",(function(obj){cr.logger.showLogger("View Logs of RegularFilmShow",{model:"RegularFilmShow",id:obj.id},cr.model.RegularFilmShow.types)}).bind(null,param.rfs));this.querySelector('button[control="signin"]').addEventListener("click",signin_rfs.bind(null,param.rfs));this.querySelector('button[control="delete"]').addEventListener("click",delete_rfs.bind(null,param.rfs))});cr.ui.template.register("admin/rfs_edit.html");cr.ui.template.register("admin/rfs_create.html");cr.ui.template.register("admin/rfs_signin.html",function(param){var node=this;this.querySelector('input[name="student_id"]').addEventListener("keyup",function(){if(this.value){node.querySelector('input[name="id"]').value="relate"}else{node.querySelector('input[name="id"]').value=null}});this.querySelector('input[name="university_id"]').addEventListener("keydown",function(e){if(e.keyCode===13){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation();cr.ui.showLoading();var r=new cr.APIRequest(cr.model.User,"GET","/?university_id="+this.value,true);r.onload=function(e){cr.ui.hideLoading();if(e.recObj.objects.length===0){node.querySelector('input[name="student_id"]').focus();node.querySelector('input[name="id"]').value="relate"}else{node.querySelector('input[name="id"]').value=e.recObj.objects[0].id;$("multiuse-button2").click()}};r.onerror=cr.errorHandler;r.send()}},true)})}function rfs_setup(func){return function(){cr.ui.changeSelection(name);document.title="Regular Film Show | Film Society, HKUSTSU";func.apply(this,arguments)}}function create_rfs(){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button1=$("multiuse-button1"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Create New Show";button1.textContent="Save As Draft";button1.removeAttribute("hidden");button2.textContent="Publish";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);var form=cr.ui.template.render_template("admin/rfs_create.html");content.appendChild(form);overlay.eventTracker.add(button1,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);payload.state="Draft";payload.film_1=payload.film_1.substr(1);payload.film_2=payload.film_2.substr(1);payload.film_3=payload.film_3.substr(1);cr.model.RegularFilmShow.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})});overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);payload.state="Open";payload.film_1=payload.film_1.substr(1);payload.film_2=payload.film_2.substr(1);payload.film_3=payload.film_3.substr(1);cr.model.RegularFilmShow.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})}function edit_rfs(id){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Edit Regular Film Show Information";button2.textContent="Save";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);cr.model.RegularFilmShow.get(id,function(obj){var form=cr.ui.template.render_template("admin/rfs_edit.html",{rfs:obj,cn:cn});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);var regex=/^[AB]\d{4}$/;if((payload.film_1&&!regex.test(payload.film_1))||(payload.film_2&&!regex.test(payload.film_2))||(payload.film_3&&!regex.test(payload.film_3))){alertOverlay.setValues("Error","Call Number Error","Retry",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");routerManager.parseHash()},null);cr.ui.overlay.showOverlay($("alertOverlay"));return}payload.film_1&&(payload.film_1=payload.film_1.substr(1));payload.film_2&&(payload.film_2=payload.film_2.substr(1));payload.film_3&&(payload.film_3=payload.film_3.substr(1));cr.model.RegularFilmShow.put(id,payload,true,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})})}function delete_rfs(rfs){alertOverlay.setValues("Confirm Delete","Confirm delete Regular Film Show?","Delete","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();cr.model.RegularFilmShow.remove(rfs.id,function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Deleted","dismiss")})},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function signin_rfs(rfs){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="RegularFilmShow Member Sign in";button2.textContent="Sign in";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);var form=cr.ui.template.render_template("admin/rfs_signin.html",{rfs:rfs,toshow:toShow(rfs)});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var r=new cr.APIRequest(cr.model.RegularFilmShow,"POST","/"+rfs.id+"/participant/"),userid=form.querySelector('input[name="id"]').value;r.onload=function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Signed in","dismiss")};r.onerror=cr.errorHandler;if(userid==="relate"){var stu_id=content.querySelector('input[name="student_id"]').value,uni_id=content.querySelector('input[name="university_id"]').value;if(stu_id&&uni_id){var _r=new cr.APIRequest(cr.model.User,"POST","/relation/");_r.onload=function(e){r.sendJSON({id:e.recObj.id})};_r.onerror=cr.errorHandler;_r.sendJSON({student_id:stu_id,university_id:uni_id})}else{if(stu_id){var _r=new cr.APIRequest(cr.model.User,"GET","/?student_id="+stu_id);_r.onload=function(e){if(e.recObj.objects.length===0){var error=new cr.Event("error",false,true);error.recObj={errno:2,error:"User not exist"};cr.errorHandler(error)}else{r.sendJSON({id:e.recObj.objects[0].id})}};_r.onerror=cr.errorHandler;_r.send()}else{content.querySelector('input[name="student_id"]').focus()}}}else{r.sendJSON({id:userid})}})}function rfs_list(query){var page=query.page||1,type_filter=query.type_filter?query.type_filter.split(","):["Draft","Open","Pending","Passed"],skeleton=cr.ui.template.render_template("admin/rfs_list.html",{filter:type_filter});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/?page="+page+"&state__in="+type_filter.join(","),pager=new cr.Pager(cr.model.RegularFilmShow,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});var checkbox=skeleton.querySelectorAll('header .controls input[type="checkbox"]');for(var i=0;i<checkbox.length;i++){checkbox[i].addEventListener("change",function(e){var type=e.target.getAttribute("filter");if(e.target.checked){type_filter.push(type)}else{type_filter.splice(type_filter.indexOf(type),1)}page=1;api_query="/?page="+page+"&state__in="+type_filter.join(","),pager=new cr.Pager(cr.model.RegularFilmShow,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)})}skeleton.querySelector("#rfs-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module RegularFilmShow",{model:"RegularFilmShow"},cr.model.RegularFilmShow.types)});skeleton.querySelector("#rfs-create-show").addEventListener("click",create_rfs);function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/rfs_list_item.html",{rfs:obj_list[i],cn:cn});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"rfs/?page="+page+"&type_filter="+type_filter.join(",")}}return{Initialize:Initialize}});cr.view.rfs.Initialize();cr.define("cr.view.ticket",function(){var name="ticket";function Initialize(){routerManager.register(/ticket\//,false,ticket_setup(ticket_list));routerManager.register(/ticket\/search\//,false,ticket_setup(ticket_search));cr.ui.template.register("admin/ticket_list.html");cr.ui.template.register("admin/ticket_search.html");cr.ui.template.register("admin/ticket_list_item.html",function(param){var cover=this.querySelector("div.cover-column > img");if(param.ticket.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.ticket.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}this.querySelector('button[control="edit"]').addEventListener("click",(function(obj){edit_ticket(obj.id)}).bind(null,param.ticket));this.querySelector('button[control="viewlog"]').addEventListener("click",(function(obj){cr.logger.showLogger("View Logs of PreviewShowTicket",{model:"PreviewShowTicket",id:obj.id},cr.model.PreviewShowTicket.types)}).bind(null,param.ticket));this.querySelector('button[control="delete"]').addEventListener("click",delete_ticket.bind(null,param.ticket))});cr.ui.template.register("admin/ticket_edit.html",function(param){var cover=this.querySelector(".cover-container");if(param.ticket.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.ticket.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}cr.uploader.init(this.querySelector(".cover-drop"),(function(){this.querySelector('input[name="cover_url"]').value="uploading"}).bind(this),(function(new_cover){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+new_cover.url+")";this.querySelector('input[name="cover_url"]').value=new_cover.id}).bind(this))});cr.ui.template.register("admin/ticket_create.html",function(){var cover=this.querySelector(".cover-container");cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)";cr.uploader.init(this.querySelector(".cover-drop"),(function(){this.querySelector('input[name="cover_url"]').value="uploading"}).bind(this),(function(new_cover){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+new_cover.url+")";this.querySelector('input[name="cover_url"]').value=new_cover.id}).bind(this))})}function ticket_setup(func){return function(){cr.ui.changeSelection(name);document.title="Preview Show Ticket | Film Society, HKUSTSU";func.apply(this,arguments)}}function create_ticket(){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button1=$("multiuse-button1"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Create New PreviewShowTicket";button1.textContent="Save As Draft";button1.removeAttribute("hidden");button2.textContent="Publish";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);var form=cr.ui.template.render_template("admin/ticket_create.html");content.appendChild(form);overlay.eventTracker.add(button1,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.cover_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}payload.state="Draft";cr.model.PreviewShowTicket.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})});overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.cover_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}payload.state="Open";cr.model.PreviewShowTicket.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})}function edit_ticket(id){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Edit PreviewShowTicket Information";button2.textContent="Save";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);cr.model.PreviewShowTicket.get(id,function(obj){var form=cr.ui.template.render_template("admin/ticket_edit.html",{ticket:obj});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.cover_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}cr.model.PreviewShowTicket.put(id,payload,true,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})})}function delete_ticket(ticket){alertOverlay.setValues("Confirm Delete","Confirm delete PreviewShowTicket?","Delete","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();cr.model.PreviewShowTicket.remove(ticket.id,function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Deleted","dismiss")})},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function ticket_list(query){var page=query.page||1,type_filter=query.type_filter?query.type_filter.split(","):["Draft","Open","Closed"],skeleton=cr.ui.template.render_template("admin/ticket_list.html",{filter:type_filter});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/?page="+page+"&state__in="+type_filter.join(","),pager=new cr.Pager(cr.model.PreviewShowTicket,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});var checkbox=skeleton.querySelectorAll('header .controls input[type="checkbox"]');for(var i=0;i<checkbox.length;i++){checkbox[i].addEventListener("change",function(e){var type=e.target.getAttribute("filter");if(e.target.checked){type_filter.push(type)}else{type_filter.splice(type_filter.indexOf(type),1)}page=1;api_query="/?page="+page+"&state__in="+type_filter.join(","),pager=new cr.Pager(cr.model.PreviewShowTicket,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)})}skeleton.querySelector("#ticket-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module PreviewShowTicket",{model:"PreviewShowTicket"},cr.model.PreviewShowTicket.types)});skeleton.querySelector("#ticket-create-ticket").addEventListener("click",create_ticket);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}var new_query={q:e.target.value};routerManager.pushState("ticket/search/?q="+encodeURIComponent(e.target.value),false,false)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/ticket_list_item.html",{ticket:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"ticket/?page="+page+"&type_filter="+type_filter.join(",")}}function ticket_search(query){var page=query.page||1,param=query.q||"",skeleton=cr.ui.template.render_template("admin/ticket_search.html",{query:param});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query=generateAPI(),pager=new cr.Pager(cr.model.PreviewShowTicket,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#ticket-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module PreviewShowTicket",{model:"PreviewShowTicket"},cr.model.PreviewShowTicket.types)});skeleton.querySelector("#ticket-create-ticket").addEventListener("click",create_ticket);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}param=e.target.value;page=1;api_query=generateAPI();pager=new cr.Pager(cr.model.PreviewShowTicket,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/ticket_list_item.html",{ticket:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"ticket/search/?page="+page+"&q="+encodeURIComponent(param)}function generateAPI(){return"/search/?page="+page+"&query="+encodeURIComponent(param)}}return{Initialize:Initialize}});cr.view.ticket.Initialize();cr.define("cr.view.doc",function(){var name="doc";function Initialize(){routerManager.register(/doc\//,false,doc_setup(doc_list));routerManager.register(/doc\/search\//,false,doc_setup(doc_search));cr.ui.template.register("admin/doc_list.html");cr.ui.template.register("admin/doc_list_item.html",function(param){this.querySelector('button[control="edit"]').addEventListener("click",(function(obj){edit_doc(obj.id)}).bind(null,param.doc));this.querySelector('button[control="delete"]').addEventListener("click",delete_doc.bind(null,param.doc))});cr.ui.template.register("admin/doc_form.html",function(){var dn=this.querySelector("a.dn_link");cr.uploader.init(this.querySelector(".file-drop"),(function(){this.querySelector('input[name="doc_url"]').value="uploading"}).bind(this),(function(new_doc){dn.href=cr.settings.resource_base+"upload/"+new_doc.url+"?force_download=true&dn_name="+new_doc.name;dn.removeAttribute("hidden");this.querySelector('input[name="doc_url"]').value=new_doc.id}).bind(this))})}function doc_setup(func){return function(){cr.ui.changeSelection(name);document.title="Document | Film Society, HKUSTSU";func.apply(this,arguments)}}function create_doc(){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Create New Document";button2.textContent="Create";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);var form=cr.ui.template.render_template("admin/doc_form.html",{doc:{},base_url:cr.settings.resource_base+"upload/"});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.doc_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}cr.model.Document.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})}function edit_doc(id){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Edit Document";button2.textContent="Save";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);cr.model.Document.get(id,function(obj){var form=cr.ui.template.render_template("admin/doc_form.html",{doc:obj,base_url:cr.settings.resource_base+"upload/"});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.doc_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}cr.model.Document.put(id,payload,true,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})})}function delete_doc(doc){alertOverlay.setValues("Confirm Delete","Confirm delete document "+doc.title+"?","Delete","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();cr.model.Document.remove(doc.id,function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Deleted","dismiss")})},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function doc_list(query){var page=query.page||1,skeleton=cr.ui.template.render_template("admin/doc_list.html",{query:""});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/?page="+page,pager=new cr.Pager(cr.model.Document,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#doc-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module Document",{model:"Document"},cr.model.Document.types)});skeleton.querySelector("#doc-create-doc").addEventListener("click",create_doc);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}var new_query={q:e.target.value};routerManager.pushState("doc/search/?q="+encodeURIComponent(e.target.value),false,false)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/doc_list_item.html",{doc:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"doc/?page="+page}}function doc_search(query){var page=query.page||1,param=query.q||"",skeleton=cr.ui.template.render_template("admin/doc_list.html",{query:param});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/search/?page="+page+"&query="+encodeURIComponent(param),pager=new cr.Pager(cr.model.Document,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#doc-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module Document",{model:"Document"},cr.model.Document.types)});skeleton.querySelector("#doc-create-doc").addEventListener("click",create_doc);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}param=e.target.value;page=1;api_query="/search/?page="+page+"&query="+encodeURIComponent(param);pager=new cr.Pager(cr.model.Document,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/doc_list_item.html",{doc:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"doc/search/?page="+page+"&q="+encodeURIComponent(param)}}return{Initialize:Initialize}});cr.view.doc.Initialize();cr.define("cr.view.sponsor",function(){var name="sponsor";function Initialize(){routerManager.register(/sponsor\//,false,sponsor_setup(sponsor_list));routerManager.register(/sponsor\/search\//,false,sponsor_setup(sponsor_search));cr.ui.template.register("admin/sponsor_list.html");cr.ui.template.register("admin/sponsor_list_item.html",function(param){var cover=this.querySelector(".img-column > img");if(param.sponsor.img_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.sponsor.img_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}this.querySelector('button[control="edit"]').addEventListener("click",(function(obj){edit_sponsor(obj.id)}).bind(null,param.sponsor));this.querySelector('button[control="delete"]').addEventListener("click",delete_sponsor.bind(null,param.sponsor))});cr.ui.template.register("admin/sponsor_form.html",function(param){var cover=this.querySelector(".cover-container");if(param.sponsor.img_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.sponsor.img_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}cr.uploader.init(this.querySelector(".cover-drop"),(function(){this.querySelector('input[name="img_url"]').value="uploading"}).bind(this),(function(new_cover){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+new_cover.url+")";this.querySelector('input[name="img_url"]').value=new_cover.id}).bind(this))})}function sponsor_setup(func){return function(){cr.ui.changeSelection(name);document.title="Sponsor | Film Society, HKUSTSU";func.apply(this,arguments)}}function create_sponsor(){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Create New Sponsor";button2.textContent="Create";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);var form=cr.ui.template.render_template("admin/sponsor_form.html",{sponsor:{},base_url:cr.settings.resource_base+"upload/"});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.img_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}cr.model.Sponsor.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})}function edit_sponsor(id){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Edit Sponsor";button2.textContent="Save";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);cr.model.Sponsor.get(id,function(obj){var form=cr.ui.template.render_template("admin/sponsor_form.html",{sponsor:obj,base_url:cr.settings.resource_base+"upload/"});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.img_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}cr.model.Sponsor.put(id,payload,true,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})})}function delete_sponsor(sponsor){alertOverlay.setValues("Confirm Delete","Confirm delete sponsor "+sponsor.name+"?","Delete","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();cr.model.Sponsor.remove(sponsor.id,function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Deleted","dismiss")})},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function sponsor_list(query){var page=query.page||1,skeleton=cr.ui.template.render_template("admin/sponsor_list.html",{query:""});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/?page="+page,pager=new cr.Pager(cr.model.Sponsor,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#sponsor-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module Sponsor",{model:"Sponsor"},cr.model.Sponsor.types)});skeleton.querySelector("#sponsor-create-sponsor").addEventListener("click",create_sponsor);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}var new_query={q:e.target.value};routerManager.pushState("sponsor/search/?q="+encodeURIComponent(e.target.value),false,false)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/sponsor_list_item.html",{sponsor:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"sponsor/?page="+page}}function sponsor_search(query){var page=query.page||1,param=query.q||"",skeleton=cr.ui.template.render_template("admin/sponsor_list.html",{query:param});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/search/?page="+page+"&query="+encodeURIComponent(param),pager=new cr.Pager(cr.model.Sponsor,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#sponsor-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module Sponsor",{model:"Sponsor"},cr.model.Sponsor.types)});skeleton.querySelector("#sponsor-create-sponsor").addEventListener("click",create_sponsor);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}param=e.target.value;page=1;api_query="/search/?page="+page+"&query="+encodeURIComponent(param);pager=new cr.Pager(cr.model.Sponsor,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/sponsor_list_item.html",{sponsor:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"sponsor/search/?page="+page+"&q="+encodeURIComponent(param)}}return{Initialize:Initialize}});cr.view.sponsor.Initialize();cr.define("cr.view.news",function(){var name="news";function Initialize(){routerManager.register(/news\//,false,news_setup(news_list));routerManager.register(/news\/search\//,false,news_setup(news_search));cr.ui.template.register("admin/news_list.html");cr.ui.template.register("admin/news_search.html");cr.ui.template.register("admin/news_list_item.html",function(param){this.querySelector('button[control="edit"]').addEventListener("click",edit_news.bind(null,param.news.id));this.querySelector('button[control="delete"]').addEventListener("click",delete_news.bind(null,param.news))});cr.ui.template.register("admin/news_form.html",function(param){cr.richText.init(this.querySelector('textarea[name="content"]'))})}function news_setup(func){return function(){cr.ui.changeSelection(name);document.title="News | Film Society, HKUSTSU";func.apply(this,arguments)}}function create_news(){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button1=$("multiuse-button1"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Create New News";button2.textContent="Publish";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);var form=cr.ui.template.render_template("admin/news_form.html",{news:{}});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);cr.model.News.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})}function edit_news(id){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Edit News";button2.textContent="Save";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);cr.model.News.get(id,function(obj){var form=cr.ui.template.render_template("admin/news_form.html",{news:obj});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);cr.model.News.put(id,payload,true,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})})}function delete_news(news){alertOverlay.setValues("Confirm Delete","Confirm delete News "+news.title+"?","Delete","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();cr.model.News.remove(news.id,function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Deleted","dismiss")})},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function news_list(query){var page=query.page||1,skeleton=cr.ui.template.render_template("admin/news_list.html",{query:""});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/?page="+page,pager=new cr.Pager(cr.model.News,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#news-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module News",{model:"News"},cr.model.News.types)});skeleton.querySelector("#news-create-news").addEventListener("click",create_news);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}var new_query={q:e.target.value};routerManager.pushState("news/search/?q="+encodeURIComponent(e.target.value),false,false)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/news_list_item.html",{news:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"news/?page="+page}}function news_search(query){var page=query.page||1,param=query.q||"",skeleton=cr.ui.template.render_template("admin/news_list.html",{query:param});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/search/?page="+page+"&query="+encodeURIComponent(param),pager=new cr.Pager(cr.model.News,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#news-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module News",{model:"News"},cr.model.News.types)});skeleton.querySelector("#news-create-news").addEventListener("click",create_news);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}param=e.target.value;page=1;api_query="/search/?page="+page+"&query="+encodeURIComponent(param);pager=new cr.Pager(cr.model.News,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/news_list_item.html",{news:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"news/search/?page="+page+"&q="+encodeURIComponent(param)}}return{Initialize:Initialize}});cr.view.news.Initialize();(function(s,t,u){var v=(s.SVGAngle||t.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML"),picker,slide,hueOffset=15,svgNS="http://www.w3.org/2000/svg";var w=['<div class="picker-wrapper">','<div class="picker"></div>','<div class="picker-indicator"></div>',"</div>",'<div class="slide-wrapper">','<div class="slide"></div>','<div class="slide-indicator"></div>',"</div>"].join("");function mousePosition(a){if(s.event&&s.event.contentOverflow!==u){return{x:s.event.offsetX,y:s.event.offsetY}}if(a.offsetX!==u&&a.offsetY!==u){return{x:a.offsetX,y:a.offsetY}}var b=a.target.parentNode.parentNode;return{x:a.layerX-b.offsetLeft,y:a.layerY-b.offsetTop}}function $(a,b,c){a=t.createElementNS(svgNS,a);for(var d in b){a.setAttribute(d,b[d])}if(Object.prototype.toString.call(c)!="[object Array]"){c=[c]}var i=0,len=(c[0]&&c.length)||0;for(;i<len;i++){a.appendChild(c[i])}return a}if(v=="SVG"){slide=$("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1",width:"100%",height:"100%"},[$("defs",{},$("linearGradient",{id:"gradient-hsv",x1:"0%",y1:"100%",x2:"0%",y2:"0%"},[$("stop",{offset:"0%","stop-color":"#FF0000","stop-opacity":"1"}),$("stop",{offset:"13%","stop-color":"#FF00FF","stop-opacity":"1"}),$("stop",{offset:"25%","stop-color":"#8000FF","stop-opacity":"1"}),$("stop",{offset:"38%","stop-color":"#0040FF","stop-opacity":"1"}),$("stop",{offset:"50%","stop-color":"#00FFFF","stop-opacity":"1"}),$("stop",{offset:"63%","stop-color":"#00FF40","stop-opacity":"1"}),$("stop",{offset:"75%","stop-color":"#0BED00","stop-opacity":"1"}),$("stop",{offset:"88%","stop-color":"#FFFF00","stop-opacity":"1"}),$("stop",{offset:"100%","stop-color":"#FF0000","stop-opacity":"1"})])),$("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"url(#gradient-hsv)"})]);picker=$("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1",width:"100%",height:"100%"},[$("defs",{},[$("linearGradient",{id:"gradient-black",x1:"0%",y1:"100%",x2:"0%",y2:"0%"},[$("stop",{offset:"0%","stop-color":"#000000","stop-opacity":"1"}),$("stop",{offset:"100%","stop-color":"#CC9A81","stop-opacity":"0"})]),$("linearGradient",{id:"gradient-white",x1:"0%",y1:"100%",x2:"100%",y2:"100%"},[$("stop",{offset:"0%","stop-color":"#FFFFFF","stop-opacity":"1"}),$("stop",{offset:"100%","stop-color":"#CC9A81","stop-opacity":"0"})])]),$("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"url(#gradient-white)"}),$("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"url(#gradient-black)"})])}else{if(v=="VML"){slide=['<DIV style="position: relative; width: 100%; height: 100%">','<v:rect style="position: absolute; top: 0; left: 0; width: 100%; height: 100%" stroked="f" filled="t">','<v:fill type="gradient" method="none" angle="0" color="red" color2="red" colors="8519f fuchsia;.25 #8000ff;24903f #0040ff;.5 aqua;41287f #00ff40;.75 #0bed00;57671f yellow"></v:fill>',"</v:rect>","</DIV>"].join("");picker=['<DIV style="position: relative; width: 100%; height: 100%">','<v:rect style="position: absolute; left: -1px; top: -1px; width: 101%; height: 101%" stroked="f" filled="t">','<v:fill type="gradient" method="none" angle="270" color="#FFFFFF" opacity="100%" color2="#CC9A81" o:opacity2="0%"></v:fill>',"</v:rect>",'<v:rect style="position: absolute; left: 0px; top: 0px; width: 100%; height: 101%" stroked="f" filled="t">','<v:fill type="gradient" method="none" angle="0" color="#000000" opacity="100%" color2="#CC9A81" o:opacity2="0%"></v:fill>',"</v:rect>","</DIV>"].join("");if(!t.namespaces.v){t.namespaces.add("v","urn:schemas-microsoft-com:vml","#default#VML")}}}function hsv2rgb(a){var R,G,B,X,C;var h=(a.h%360)/60;C=a.v*a.s;X=C*(1-Math.abs(h%2-1));R=G=B=a.v-C;h=~~h;R+=[C,X,0,0,X,C][h];G+=[X,C,C,X,0,0][h];B+=[0,0,X,C,C,X][h];var r=Math.floor(R*255);var g=Math.floor(G*255);var b=Math.floor(B*255);return{r:r,g:g,b:b,hex:"#"+(16777216|b|(g<<8)|(r<<16)).toString(16).slice(1)}}function rgb2hsv(a){var r=a.r;var g=a.g;var b=a.b;if(a.r>1||a.g>1||a.b>1){r/=255;g/=255;b/=255}var H,S,V,C;V=Math.max(r,g,b);C=V-Math.min(r,g,b);H=(C==0?null:V==r?(g-b)/C+(g<b?6:0):V==g?(b-r)/C+2:(r-g)/C+4);H=(H%6)*60;S=C==0?0:C/V;return{h:H,s:S,v:V}}function slideListener(d,e,f){return function(a){a=a||s.event;var b=mousePosition(a);d.h=b.y/e.offsetHeight*360+hueOffset;d.s=d.v=1;var c=hsv2rgb({h:d.h,s:1,v:1});f.style.backgroundColor=c.hex;d.callback&&d.callback(c.hex,{h:d.h-hueOffset,s:d.s,v:d.v},{r:c.r,g:c.g,b:c.b},u,b)}}function pickerListener(d,e){return function(a){a=a||s.event;var b=mousePosition(a),width=e.offsetWidth,height=e.offsetHeight;d.s=b.x/width;d.v=(height-b.y)/height;var c=hsv2rgb(d);d.callback&&d.callback(c.hex,{h:d.h-hueOffset,s:d.s,v:d.v},{r:c.r,g:c.g,b:c.b},b)}}var x=0;function ColorPicker(f,g,h){if(!(this instanceof ColorPicker)){return new ColorPicker(f,g,h)}this.h=0;this.s=1;this.v=1;if(!h){var i=f;i.innerHTML=w;this.slideElement=i.getElementsByClassName("slide")[0];this.pickerElement=i.getElementsByClassName("picker")[0];var j=i.getElementsByClassName("slide-indicator")[0];var k=i.getElementsByClassName("picker-indicator")[0];ColorPicker.fixIndicators(j,k);this.callback=function(a,b,c,d,e){ColorPicker.positionIndicators(j,k,e,d);g(a,b,c)}}else{this.callback=h;this.pickerElement=g;this.slideElement=f}if(v=="SVG"){var l=slide.cloneNode(true);var m=picker.cloneNode(true);var n=l.querySelector("#gradient-hsv");var o=l.querySelector("rect");n.id="gradient-hsv-"+x;o.setAttribute("fill","url(#"+n.id+")");var p=[m.querySelector("#gradient-black"),m.querySelector("#gradient-white")];var q=m.querySelectorAll("rect");p[0].id="gradient-black-"+x;p[1].id="gradient-white-"+x;q[0].setAttribute("fill","url(#"+p[1].id+")");q[1].setAttribute("fill","url(#"+p[0].id+")");this.slideElement.appendChild(l);this.pickerElement.appendChild(m);x++}else{this.slideElement.innerHTML=slide;this.pickerElement.innerHTML=picker}addEventListener(this.slideElement,"click",slideListener(this,this.slideElement,this.pickerElement));addEventListener(this.pickerElement,"click",pickerListener(this,this.pickerElement));enableDragging(this,this.slideElement,slideListener(this,this.slideElement,this.pickerElement));enableDragging(this,this.pickerElement,pickerListener(this,this.pickerElement))}function addEventListener(a,b,c){if(a.attachEvent){a.attachEvent("on"+b,c)}else{if(a.addEventListener){a.addEventListener(b,c,false)}}}function enableDragging(b,c,d){var e=false;addEventListener(c,"mousedown",function(a){e=true});addEventListener(c,"mouseup",function(a){e=false});addEventListener(c,"mouseout",function(a){e=false});addEventListener(c,"mousemove",function(a){if(e){d(a)}})}ColorPicker.hsv2rgb=function(a){var b=hsv2rgb(a);delete b.hex;return b};ColorPicker.hsv2hex=function(a){return hsv2rgb(a).hex};ColorPicker.rgb2hsv=rgb2hsv;ColorPicker.rgb2hex=function(a){return hsv2rgb(rgb2hsv(a)).hex};ColorPicker.hex2hsv=function(a){return rgb2hsv(ColorPicker.hex2rgb(a))};ColorPicker.hex2rgb=function(a){return{r:parseInt(a.substr(1,2),16),g:parseInt(a.substr(3,2),16),b:parseInt(a.substr(5,2),16)}};function setColor(a,b,d,e){a.h=b.h%360;a.s=b.s;a.v=b.v;var c=hsv2rgb(a);var f={y:(a.h*a.slideElement.offsetHeight)/360,x:0};var g=a.pickerElement.offsetHeight;var h={x:a.s*a.pickerElement.offsetWidth,y:g-a.v*g};a.pickerElement.style.backgroundColor=hsv2rgb({h:a.h,s:1,v:1}).hex;a.callback&&a.callback(e||c.hex,{h:a.h,s:a.s,v:a.v},d||{r:c.r,g:c.g,b:c.b},h,f);return a}ColorPicker.prototype.setHsv=function(a){return setColor(this,a)};ColorPicker.prototype.setRgb=function(a){return setColor(this,rgb2hsv(a),a)};ColorPicker.prototype.setHex=function(a){return setColor(this,ColorPicker.hex2hsv(a),u,a)};ColorPicker.positionIndicators=function(a,b,c,d){if(c){b.style.left="auto";b.style.right="0px";b.style.top="0px";a.style.top=(c.y-a.offsetHeight/2)+"px"}if(d){b.style.top=(d.y-b.offsetHeight/2)+"px";b.style.left=(d.x-b.offsetWidth/2)+"px"}};ColorPicker.fixIndicators=function(a,b){b.style.pointerEvents="none";a.style.pointerEvents="none"};s.ColorPicker=ColorPicker})(window,window.document);cr.define("cr.view.exco",function(){var name="exco";function Initialize(){routerManager.register(/exco\//,false,exco_setup(exco_list));cr.ui.template.register("admin/exco_list.html");cr.ui.template.register("admin/exco_list_item.html",function(param){this.querySelector('button[control="edit"]').addEventListener("click",(function(obj){edit_exco(obj.id)}).bind(null,param.exco))});cr.ui.template.register("admin/exco_form.html",function(param){var cover=this.querySelector(".cover-container");cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.exco.img_url.url+")";cr.uploader.init(this.querySelector(".cover-drop"),(function(){this.querySelector('input[name="img_url"]').value="uploading"}).bind(this),(function(new_cover){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+new_cover.url+")";this.querySelector('input[name="img_url"]').value=new_cover.id}).bind(this));cr.ui.rotator.init(cover);cr.richText.init(this.querySelector('textarea[name="descript"]'))})}function exco_setup(func){return function(){cr.ui.changeSelection(name);document.title="Exco | Film Society, HKUSTSU";func.apply(this,arguments)}}function edit_exco(id){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Edit Exco";button2.textContent="Save";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);cr.model.Exco.get(id,function(obj){var form=cr.ui.template.render_template("admin/exco_form.html",{exco:obj,base_url:cr.settings.resource_base+"upload/"});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.img_url==="uploading"){alertOverlay.setValues("Warning","Picture is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}cr.model.Exco.put(id,payload,true,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})})}function exco_list(query){var page=query.page||1,skeleton=cr.ui.template.render_template("admin/exco_list.html",{query:""});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/?page="+page,pager=new cr.Pager(cr.model.Exco,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/exco_list_item.html",{exco:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"exco/?page="+page}}return{Initialize:Initialize}});cr.view.exco.Initialize();cr.define("cr.ui.rotator",function(){var fwidth=600,fheight=800,fnum=24,velocity=13,isTouch="ontouchstart" in document.documentElement,activeElem=null;function Initialization(){document.addEventListener(isTouch?"touchend":"mouseup",handleUp);document.addEventListener(isTouch?"touchmove":"mousemove",handleMove)}function init(elem){elem.addEventListener(isTouch?"touchstart":"mousedown",handleDown.bind(elem));elem.rotFrame=elem.rotLastFrame=0;elem.rotating=false}function handleDown(e){if(!isTouch&&e.button!=0){return false}this.rotDragging=true;activeElem=this;document.body.classList.add("dragging");if(this.rotCoords==null){this.rotCoords=getMouse(e)}this.offset=0;e.preventDefault();e.stopImmediatePropagation();return false}function handleMove(e){if(!activeElem){return false}var offset=calcOffset(e,activeElem.rotCoords);dragBg(offset);return true}function handleUp(e){if(!activeElem){return false}activeElem.rotLastFrame=activeElem.rotFrame;activeElem.rotCoords=null;document.body.classList.remove("dragging");activeElem=null;return true}function getMouse(e){if(isTouch){e=e.touches[0]}if(e.pageX&&e.pageY){return{x:e.pageX,y:e.pageY}}return{x:e.clientX+(document.documentElement.scrollLeft-document.documentElement.clientLeft),y:e.clientY+(document.documentElement.scrollTop-document.documentElement.clientTop)}}function calcOffset(e,coords){var curMouse=getMouse(e);return{x:curMouse.x-coords.x,y:curMouse.y-coords.y}}function dragBg(offset){var lastFrame=activeElem.rotLastFrame||0,gotoFrame;gotoFrame=lastFrame+Math.round(offset.x/velocity);if(gotoFrame>=fnum||gotoFrame<0){gotoFrame=gotoFrame-(fnum*Math.floor(gotoFrame/fnum))}activeElem.rotFrame=gotoFrame;activeElem.style.backgroundPosition=(100*gotoFrame/(fnum-1))+"% 0%"}return{Initialization:Initialization,init:init}});cr.ui.rotator.Initialization();cr.define("cr.view.publication",function(){var name="publication";function Initialize(){routerManager.register(/publication\//,false,publication_setup(publication_list));routerManager.register(/publication\/search\//,false,publication_setup(publication_search));cr.ui.template.register("admin/publication_list.html");cr.ui.template.register("admin/publication_search.html");cr.ui.template.register("admin/publication_list_item.html",function(param){var cover=this.querySelector(".cover-column > img");if(param.publication.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.publication.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}this.querySelector('button[control="edit"]').addEventListener("click",(function(obj){edit_publication(obj.id)}).bind(null,param.publication));this.querySelector('button[control="delete"]').addEventListener("click",delete_publication.bind(null,param.publication))});cr.ui.template.register("admin/publication_form.html",function(param){var cover=this.querySelector(".cover-container"),dn=this.querySelector("a.dn_link"),file_wrapper=this.querySelector(".publication-file"),link_wrapper=this.querySelector(".publication-link");if(param.publication.cover_url){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+param.publication.cover_url.url+")"}else{cover.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}cr.uploader.init(this.querySelector(".cover-drop"),(function(){this.querySelector('input[name="cover_url"]').value="uploading"}).bind(this),(function(new_cover){cover.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+new_cover.url+")";this.querySelector('input[name="cover_url"]').value=new_cover.id}).bind(this));cr.uploader.init(this.querySelector(".file-drop"),(function(){this.querySelector('input[name="doc_url"]').value="uploading"}).bind(this),(function(new_doc){dn.href=cr.settings.resource_base+"upload/"+new_doc.url+"?force_download=true&dn_name="+new_doc.name;dn.removeAttribute("hidden");this.querySelector('input[name="doc_url"]').value=new_doc.id}).bind(this));this.querySelector('select[name="pub_type"]').addEventListener("change",function(){switch(this.value){case"MicroMagazine":link_wrapper.removeAttribute("hidden");file_wrapper.setAttribute("hidden",true);link_wrapper.querySelector('input[name="ext_doc_url"]').removeAttribute("disabled");file_wrapper.querySelector('input[name="doc_url"]').value="";break;default:file_wrapper.removeAttribute("hidden");link_wrapper.setAttribute("hidden",true);file_wrapper.querySelector('input[name="doc_url"]').removeAttribute("disabled");link_wrapper.querySelector('input[name="ext_doc_url"]').value=""}})})}function publication_setup(func){return function(){cr.ui.changeSelection(name);document.title="Publication | Film Society, HKUSTSU";func.apply(this,arguments)}}function create_publication(){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Create New Publication";button2.textContent="Create";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);var form=cr.ui.template.render_template("admin/publication_form.html",{publication:{},base_url:cr.settings.resource_base+"upload/"});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.cover_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}if(payload.doc_url==="uploading"){alertOverlay.setValues("Warning","Document is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}cr.model.Publication.post(payload,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})}function edit_publication(id){var overlay=$("multiuseOverlay"),title=overlay.querySelector("h1"),content=overlay.querySelector(".content-area"),button2=$("multiuse-button2"),button3=$("multiuse-button3");cr.ui.resetMultiuse();title.textContent="Edit Publication";button2.textContent="Save";button2.removeAttribute("hidden");button3.textContent="Cancel";button3.removeAttribute("hidden");overlay.eventTracker.add(button3,"click",function(){cr.dispatchSimpleEvent(overlay,"cancelOverlay")});cr.ui.overlay.showOverlay(overlay);cr.model.Publication.get(id,function(obj){var form=cr.ui.template.render_template("admin/publication_form.html",{publication:obj,base_url:cr.settings.resource_base+"upload/"});content.appendChild(form);overlay.eventTracker.add(button2,"click",function(){cr.ui.showLoading();var payload=Application.collectForm(content);if(payload.cover_url==="uploading"){alertOverlay.setValues("Warning","Cover is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}if(payload.doc_url==="uploading"){alertOverlay.setValues("Warning","Document is still uploading","OK",null,function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")},null);cr.ui.hideLoading();cr.ui.overlay.showOverlay($("alertOverlay"));return}cr.model.Publication.put(id,payload,true,function(){cr.ui.hideLoading();cr.dispatchSimpleEvent(overlay,"cancelOverlay");history.go();cr.ui.showNotification("Saved","dismiss")})})})}function delete_publication(publication){alertOverlay.setValues("Confirm Delete","Confirm delete publication "+publication.title+"?","Delete","Cancel",function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay");cr.ui.showLoading();cr.model.Publication.remove(publication.id,function(){cr.ui.hideLoading();history.go();cr.ui.showNotification("Deleted","dismiss")})},function(){cr.dispatchSimpleEvent($("alertOverlay"),"cancelOverlay")});cr.ui.overlay.showOverlay($("alertOverlay"))}function publication_list(query){var page=query.page||1,type_filter=query.type_filter?query.type_filter.split(","):["Magazine","MicroMagazine","Podcast"],skeleton=cr.ui.template.render_template("admin/publication_list.html",{filter:type_filter});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/?page="+page+"&avail_type__in="+type_filter.join(","),pager=new cr.Pager(cr.model.Publication,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});var checkbox=skeleton.querySelectorAll('header .controls input[type="checkbox"]');for(var i=0;i<checkbox.length;i++){checkbox[i].addEventListener("change",function(e){var type=e.target.getAttribute("filter");if(e.target.checked){type_filter.push(type)}else{type_filter.splice(type_filter.indexOf(type),1)}page=1;api_query="/?page="+page+"&avail_type__in="+type_filter.join(","),pager=new cr.Pager(cr.model.Publication,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)})}skeleton.querySelector("#publication-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module Publication",{model:"Publication"},cr.model.Publication.types)});skeleton.querySelector("#publication-create-publication").addEventListener("click",create_publication);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}var new_query={q:e.target.value};routerManager.pushState("publication/search/?q="+encodeURIComponent(e.target.value),false,false)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/publication_list_item.html",{publication:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"publication/?page="+page+"&type_filter="+type_filter.join(",")}}function publication_search(query){var page=query.page||1,param=query.q||"",skeleton=cr.ui.template.render_template("admin/publication_search.html",{query:param});cr.ui.replaceContent(skeleton);var list_container=skeleton.querySelector("list"),content=skeleton.querySelector(".content"),footer=skeleton.querySelector("footer"),api_query="/search/?page="+page+"&query="+encodeURIComponent(param),pager=new cr.Pager(cr.model.Publication,api_query);cr.ui.displayLoading(content);pager.load(load_obj);skeleton.querySelector("#page-prev").addEventListener("click",function(e){page--;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.prev(load_obj)});skeleton.querySelector("#page-next").addEventListener("click",function(e){page++;routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.next(load_obj)});skeleton.querySelector("#publication-view-log").addEventListener("click",function(){cr.logger.showLogger("View Logs of module Publication",{model:"Publication"},cr.model.Publication.types)});skeleton.querySelector("#publication-create-publication").addEventListener("click",create_publication);var searchbox=skeleton.querySelector('header .corner input[type="search"]');searchbox.addEventListener("keydown",function(e){if(e.keyCode===13){if(e.target.value===""){return}param=e.target.value;page=1;api_query="/search/?page="+page+"&query="+encodeURIComponent(param);pager=new cr.Pager(cr.model.Publication,api_query);routerManager.pushState(generateURL(),false,true);scrollTo(0,0);cr.ui.displayLoading(content);pager.load(load_obj)}});function load_obj(obj_list){cr.ui.removeLoading(content);list_container.classList.add("content-loading");list_container.innerHTML="";for(var i=0;i<obj_list.length;i++){var listitem=cr.ui.template.render_template("admin/publication_list_item.html",{publication:obj_list[i]});list_container.appendChild(listitem)}if(this.has_prev){footer.querySelector(".lefthub").removeAttribute("hidden")}else{footer.querySelector(".lefthub").setAttribute("hidden","true")}if(this.has_next){footer.querySelector(".righthub").removeAttribute("hidden")}else{footer.querySelector(".righthub").setAttribute("hidden","true")}footer.querySelector(".centerhub > span").textContent=this.page+"/"+this.total;setTimeout(function(){list_container.classList.remove("content-loading")},100)}function generateURL(){return"publication/search/?page="+page+"&q="+encodeURIComponent(param)}}return{Initialize:Initialize}});cr.view.publication.Initialize();
